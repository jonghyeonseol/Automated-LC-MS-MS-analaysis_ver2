<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🧬 통합 LC-MS-MS 분석 플랫폼</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/plotly.js/2.26.0/plotly.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 3.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.3em;
            opacity: 0.9;
        }

        /* 메인 레이아웃 */
        .main-layout {
            display: grid;
            grid-template-columns: 350px 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        /* 왼쪽 컨트롤 패널 */
        .control-sidebar {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            height: fit-content;
        }

        .control-section {
            margin-bottom: 25px;
        }

        .control-section h3 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 1.2em;
            border-bottom: 2px solid #3498db;
            padding-bottom: 5px;
        }

        /* 파일 업로드 */
        .file-upload {
            border: 3px dashed #667eea;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
            margin-bottom: 15px;
        }

        .file-upload:hover {
            border-color: #764ba2;
            background: rgba(102, 126, 234, 0.05);
        }

        .file-upload.dragover {
            border-color: #764ba2;
            background: rgba(102, 126, 234, 0.1);
            transform: scale(1.02);
        }

        /* 설정 슬라이더 */
        .slider-group {
            margin-bottom: 15px;
        }

        .slider-group label {
            display: block;
            font-weight: bold;
            margin-bottom: 5px;
            color: #2c3e50;
        }

        .slider-container {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .slider {
            flex: 1;
            height: 6px;
            border-radius: 3px;
            background: #e0e0e0;
            outline: none;
            appearance: none;
        }

        .slider::-webkit-slider-thumb {
            appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #667eea;
            cursor: pointer;
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
        }

        .value-display {
            background: #f8f9fa;
            padding: 5px 10px;
            border-radius: 5px;
            font-weight: bold;
            min-width: 60px;
            text-align: center;
            border: 1px solid #e9ecef;
        }

        /* 버튼 스타일 */
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 5px;
            width: 100%;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-success {
            background: linear-gradient(135deg, #27ae60, #229954);
            color: white;
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(39, 174, 96, 0.4);
        }

        /* 오른쪽 메인 콘텐츠 */
        .main-content {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            min-height: 700px;
        }

        /* 탭 인터페이스 */
        .tab-container {
            margin-bottom: 20px;
        }

        .tab-nav {
            display: flex;
            border-bottom: 2px solid #e9ecef;
            margin-bottom: 20px;
        }

        .tab-btn {
            background: none;
            border: none;
            padding: 15px 25px;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            color: #6c757d;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
        }

        .tab-btn.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }

        .tab-btn:hover:not(.active) {
            color: #495057;
            background-color: #f8f9fa;
        }

        .tab-content {
            min-height: 600px;
        }

        .tab-pane {
            display: none;
        }

        .tab-pane.active {
            display: block;
        }

        /* 시각화 영역 */
        .visualization-area {
            border: 1px solid #e9ecef;
            border-radius: 10px;
            padding: 20px;
            min-height: 500px;
        }

        .plot-container {
            width: 100%;
            height: 600px;
        }

        /* 상태 표시 */
        .status-panel {
            background: #f8f9fa;
            border-left: 4px solid #3498db;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            font-family: 'Courier New', monospace;
        }

        /* 통계 카드 */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .stat-number {
            font-size: 2.2em;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.9em;
            opacity: 0.9;
        }

        /* 범례 */
        .legend {
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
            border: 1px solid #e9ecef;
        }

        .legend h4 {
            margin-top: 0;
            color: #495057;
        }

        .legend-item {
            display: inline-block;
            margin-right: 20px;
            margin-bottom: 10px;
        }

        .legend-color {
            display: inline-block;
            width: 15px;
            height: 15px;
            border-radius: 3px;
            margin-right: 8px;
            vertical-align: middle;
        }

        /* 컨트롤 버튼 */
        .controls {
            text-align: center;
            margin-bottom: 20px;
        }

        .controls .btn {
            width: auto;
            margin: 0 5px;
        }

        /* 반응형 디자인 */
        @media (max-width: 1200px) {
            .main-layout {
                grid-template-columns: 1fr;
            }

            .header h1 {
                font-size: 2.5em;
            }
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }

            .header h1 {
                font-size: 2em;
            }

            .tab-nav {
                flex-wrap: wrap;
            }

            .tab-btn {
                padding: 10px 15px;
                font-size: 1em;
            }
        }

        /* 로딩 애니메이션 */
        .loading {
            text-align: center;
            padding: 40px;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* 고급 컨트롤 */
        .advanced-controls {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
        }

        .mode-selector {
            display: flex;
            gap: 5px;
            margin-top: 10px;
        }

        .mode-option {
            flex: 1;
            padding: 8px;
            text-align: center;
            border-radius: 5px;
            background: #e9ecef;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9em;
        }

        .mode-option.active {
            background: #667eea;
            color: white;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- 헤더 -->
        <div class="header">
            <h1>🧬 통합 LC-MS-MS 분석 플랫폼</h1>
            <p>2D/3D 시각화와 실시간 분석을 결합한 차세대 Ganglioside 분석 도구</p>
        </div>

        <!-- 메인 레이아웃 -->
        <div class="main-layout">
            <!-- 왼쪽 컨트롤 패널 -->
            <div class="control-sidebar">
                <!-- 파일 업로드 -->
                <div class="control-section">
                    <h3>📁 데이터 업로드</h3>
                    <div class="file-upload" id="fileUpload" onclick="document.getElementById('csvFile').click();">
                        <div style="font-size: 2em; margin-bottom: 10px;">📄</div>
                        <div>CSV 파일 업로드</div>
                        <small>클릭 또는 드래그</small>
                        <input type="file" id="csvFile" accept=".csv" style="display: none;">
                    </div>
                    <div id="fileStatus" style="text-align: center; color: #6c757d; font-size: 0.9em;">파일을 선택해주세요</div>
                </div>

                <!-- 분석 설정 -->
                <div class="control-section">
                    <h3>⚙️ 분석 설정</h3>

                    <div class="slider-group">
                        <label for="outlierThreshold">이상치 임계값</label>
                        <div class="slider-container">
                            <input type="range" id="outlierThreshold" class="slider" min="1.0" max="5.0" step="0.1" value="3.0">
                            <div class="value-display" id="outlierValue">3.0</div>
                        </div>
                    </div>

                    <div class="slider-group">
                        <label for="r2Threshold">R² 임계값</label>
                        <div class="slider-container">
                            <input type="range" id="r2Threshold" class="slider" min="0.90" max="0.999" step="0.001" value="0.99">
                            <div class="value-display" id="r2Value">0.990</div>
                        </div>
                    </div>

                    <div class="slider-group">
                        <label for="rtTolerance">RT 허용 범위</label>
                        <div class="slider-container">
                            <input type="range" id="rtTolerance" class="slider" min="0.05" max="0.5" step="0.01" value="0.1">
                            <div class="value-display" id="rtValue">±0.10</div>
                        </div>
                    </div>

                    <div style="margin-top: 15px;">
                        <label>분석 모드</label>
                        <div class="mode-selector">
                            <div class="mode-option active" data-mode="Porcine" onclick="selectMode('Porcine')">🐷 Porcine</div>
                            <div class="mode-option" data-mode="Mouse" onclick="selectMode('Mouse')">🐭 Mouse</div>
                        </div>
                    </div>
                </div>

                <!-- 분석 버튼 -->
                <div class="control-section">
                    <h3>🚀 실행</h3>
                    <button class="btn btn-primary" onclick="runAnalysis()">분석 시작</button>
                    <button class="btn btn-success" onclick="generateIntegratedVisualization()" id="visualizeBtn" style="display: none;">통합 시각화</button>

                    <div class="advanced-controls">
                        <button class="btn btn-primary" onclick="resetSettings()">🔄 설정 초기화</button>
                        <button class="btn btn-success" onclick="downloadResults()" id="downloadBtn" style="display: none;">💾 결과 다운로드</button>
                        <button class="btn btn-primary" onclick="testConnection()" style="background-color: #e74c3c;">🔌 연결 테스트</button>
                    </div>
                </div>

                <!-- 실시간 상태 -->
                <div class="control-section">
                    <h3>📊 실시간 상태</h3>
                    <div id="realtimeStats" style="font-size: 0.9em; color: #6c757d;">
                        분석 대기중...
                    </div>
                </div>
            </div>

            <!-- 오른쪽 메인 콘텐츠 -->
            <div class="main-content">
                <!-- 탭 인터페이스 -->
                <div class="tab-container">
                    <div class="tab-nav">
                        <button class="tab-btn active" data-tab="analysis">📊 분석 결과</button>
                        <button class="tab-btn" data-tab="visualization-2d">📈 2D 시각화</button>
                        <button class="tab-btn" data-tab="visualization-3d">🌌 3D 시각화</button>
                        <button class="tab-btn" data-tab="integrated">🔄 통합 뷰</button>
                        <button class="tab-btn" data-tab="statistics">📋 상세 통계</button>
                    </div>

                    <div class="tab-content">
                        <!-- 분석 결과 탭 -->
                        <div id="analysis" class="tab-pane active">
                            <div class="status-panel" id="statusDisplay">
                                분석을 시작하려면 CSV 파일을 업로드하고 '분석 시작' 버튼을 클릭하세요.
                            </div>

                            <div class="stats-grid" id="statsGrid" style="display: none;">
                                <!-- 동적으로 생성 -->
                            </div>

                            <div id="analysisDetails" style="display: none;">
                                <h4>분석 상세 정보</h4>
                                <div id="detailsContent"></div>
                            </div>
                        </div>

                        <!-- 2D 시각화 탭 -->
                        <div id="visualization-2d" class="tab-pane">
                            <div class="controls">
                                <button class="btn btn-primary" onclick="reset2DView()">🔄 시점 초기화</button>
                                <button class="btn btn-primary" onclick="toggle2DOutliers()">👁️ 이상치 토글</button>
                                <button class="btn btn-primary" onclick="show2DRegression()">📈 회귀선 표시</button>
                            </div>

                            <div class="visualization-area">
                                <div id="plot-2d" class="plot-container"></div>
                            </div>

                            <div class="legend">
                                <h4>범례</h4>
                                <div class="legend-item">
                                    <span class="legend-color" style="background-color: #3498db;"></span>
                                    Anchor 화합물 (T)
                                </div>
                                <div class="legend-item">
                                    <span class="legend-color" style="background-color: #2ecc71;"></span>
                                    유효 화합물
                                </div>
                                <div class="legend-item">
                                    <span class="legend-color" style="background-color: #e74c3c;"></span>
                                    이상치
                                </div>
                            </div>
                        </div>

                        <!-- 3D 시각화 탭 -->
                        <div id="visualization-3d" class="tab-pane">
                            <div class="controls">
                                <button class="btn btn-primary" onclick="reset3DView()">🔄 시점 초기화</button>
                                <button class="btn btn-primary" onclick="toggle3DOutliers()">👁️ 이상치 토글</button>
                                <button class="btn btn-primary" onclick="toggle3DRegression()">📈 회귀평면 토글</button>
                            </div>

                            <div class="visualization-area">
                                <div id="plot-3d" class="plot-container"></div>
                            </div>

                            <div class="legend">
                                <h4>축 정보</h4>
                                <div class="legend-item">
                                    <strong>X축:</strong> Mass-to-Charge (m/z)
                                </div>
                                <div class="legend-item">
                                    <strong>Y축:</strong> Retention Time (min)
                                </div>
                                <div class="legend-item">
                                    <strong>Z축:</strong> Partition Coefficient (Log P)
                                </div>
                            </div>
                        </div>

                        <!-- 통합 뷰 탭 -->
                        <div id="integrated" class="tab-pane">
                            <div class="controls">
                                <button class="btn btn-primary" onclick="refreshIntegratedView()">🔄 새로고침</button>
                                <button class="btn btn-primary" onclick="openIntegratedWindow()">🔗 새 창에서 열기</button>
                            </div>

                            <div class="visualization-area">
                                <div id="integratedVisualization" style="min-height: 600px;">
                                    <div style="text-align: center; padding: 50px; color: #6c757d;">
                                        분석 후 통합 시각화를 생성해주세요.
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 상세 통계 탭 -->
                        <div id="statistics" class="tab-pane">
                            <div id="detailedStats">
                                <div style="text-align: center; padding: 50px; color: #6c757d;">
                                    분석 결과가 없습니다. 먼저 분석을 실행해주세요.
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 전역 변수
        let currentAnalysisResults = null;
        let currentSettings = {
            outlierThreshold: 3.0,
            r2Threshold: 0.99,
            rtTolerance: 0.1,
            analysisMode: 'Porcine'
        };
        let uploadedFile = null;
        let compoundData = null;

        // 시각화 상태
        let showOutliers2D = true;
        let showOutliers3D = true;
        let showRegression2D = false;
        let showRegression3D = false;

        // 페이지 로드 시 초기화
        document.addEventListener('DOMContentLoaded', function() {
            initializeEventListeners();
            setupDragAndDrop();
            initializeTabs();
        });

        // 이벤트 리스너 초기화
        function initializeEventListeners() {
            // 슬라이더 이벤트
            document.getElementById('outlierThreshold').addEventListener('input', updateOutlierValue);
            document.getElementById('r2Threshold').addEventListener('input', updateR2Value);
            document.getElementById('rtTolerance').addEventListener('input', updateRtValue);

            // 파일 업로드 이벤트
            document.getElementById('csvFile').addEventListener('change', handleFileUpload);
        }

        // 탭 초기화
        function initializeTabs() {
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const targetTab = this.getAttribute('data-tab');
                    switchTab(targetTab);
                });
            });
        }

        function switchTab(tabId) {
            // 모든 탭 버튼과 패널 비활성화
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-pane').forEach(pane => pane.classList.remove('active'));

            // 선택된 탭 활성화
            document.querySelector(`[data-tab="${tabId}"]`).classList.add('active');
            document.getElementById(tabId).classList.add('active');

            // 탭 전환 시 플롯 리사이즈
            setTimeout(() => {
                const plotElements = ['plot-2d', 'plot-3d'];
                plotElements.forEach(id => {
                    const element = document.getElementById(id);
                    if (element && element.data) {
                        Plotly.Plots.resize(element);
                    }
                });
            }, 100);
        }

        // 드래그 앤 드롭 설정
        function setupDragAndDrop() {
            const fileUpload = document.getElementById('fileUpload');

            fileUpload.addEventListener('dragover', function(e) {
                e.preventDefault();
                fileUpload.classList.add('dragover');
            });

            fileUpload.addEventListener('dragleave', function(e) {
                e.preventDefault();
                fileUpload.classList.remove('dragover');
            });

            fileUpload.addEventListener('drop', function(e) {
                e.preventDefault();
                fileUpload.classList.remove('dragover');

                const files = e.dataTransfer.files;
                if (files.length > 0 && files[0].name.endsWith('.csv')) {
                    document.getElementById('csvFile').files = files;
                    handleFileUpload({target: {files: files}});
                }
            });
        }

        // 슬라이더 값 업데이트 함수들
        function updateOutlierValue(event) {
            const value = parseFloat(event.target.value);
            document.getElementById('outlierValue').textContent = value.toFixed(1);
            currentSettings.outlierThreshold = value;

            if (uploadedFile) {
                debounceAnalysis();
            }
        }

        function updateR2Value(event) {
            const value = parseFloat(event.target.value);
            document.getElementById('r2Value').textContent = value.toFixed(3);
            currentSettings.r2Threshold = value;

            if (uploadedFile) {
                debounceAnalysis();
            }
        }

        function updateRtValue(event) {
            const value = parseFloat(event.target.value);
            document.getElementById('rtValue').textContent = `±${value.toFixed(2)}`;
            currentSettings.rtTolerance = value;

            if (uploadedFile) {
                debounceAnalysis();
            }
        }

        // 분석 모드 선택
        function selectMode(mode) {
            document.querySelectorAll('.mode-option').forEach(option => {
                option.classList.remove('active');
            });

            document.querySelector(`[data-mode="${mode}"]`).classList.add('active');
            currentSettings.analysisMode = mode;

            if (uploadedFile) {
                debounceAnalysis();
            }
        }

        // 설정 초기화
        function resetSettings() {
            currentSettings = {
                outlierThreshold: 3.0,
                r2Threshold: 0.99,
                rtTolerance: 0.1,
                analysisMode: 'Porcine'
            };

            document.getElementById('outlierThreshold').value = 3.0;
            document.getElementById('r2Threshold').value = 0.99;
            document.getElementById('rtTolerance').value = 0.1;
            document.getElementById('outlierValue').textContent = '3.0';
            document.getElementById('r2Value').textContent = '0.990';
            document.getElementById('rtValue').textContent = '±0.10';

            selectMode('Porcine');

            if (uploadedFile) {
                runAnalysis();
            }
        }

        // 파일 업로드 처리
        function handleFileUpload(event) {
            console.log('File upload event triggered:', event);
            const file = event.target.files[0];
            console.log('Selected file:', file);

            if (!file) {
                console.log('No file selected');
                return;
            }

            if (!file.name.endsWith('.csv')) {
                showStatus('❌ CSV 파일만 업로드 가능합니다.', 'error');
                console.log('Invalid file type:', file.name);
                return;
            }

            uploadedFile = file;
            console.log('File uploaded successfully:', file.name, file.size, 'bytes');

            document.getElementById('fileStatus').textContent = `✅ ${file.name} (${(file.size/1024).toFixed(1)} KB)`;
            document.getElementById('fileStatus').style.color = '#27ae60';
            showStatus(`✅ 파일 업로드 완료: ${file.name}`, 'success');
        }

        // 디바운스 분석 실행
        let analysisTimeout;
        function debounceAnalysis() {
            clearTimeout(analysisTimeout);
            analysisTimeout = setTimeout(() => {
                runAnalysis(true);
            }, 1000);
        }

        // 분석 실행
        async function runAnalysis(isAutoReanalysis = false) {
            if (!uploadedFile) {
                showStatus('❌ 먼저 CSV 파일을 업로드해주세요.', 'error');
                return;
            }

            try {
                const prefix = isAutoReanalysis ? '🔄 실시간 재분석' : '🔬 분석';
                showStatus(`${prefix} 진행 중...`, 'loading');
                showRealtimeStatus('분석 중...');

                console.log('Starting analysis with file:', uploadedFile.name);

                const formData = new FormData();
                formData.append('file', uploadedFile);
                formData.append('data_type', currentSettings.analysisMode);
                formData.append('outlier_threshold', currentSettings.outlierThreshold);
                formData.append('r2_threshold', currentSettings.r2Threshold);
                formData.append('rt_tolerance', currentSettings.rtTolerance);

                console.log('FormData prepared, sending request...');

                const response = await fetch('/api/analyze', {
                    method: 'POST',
                    body: formData
                });

                console.log('Response received:', response.status);

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                console.log('Data parsed successfully:', data);

                if (data.results) {
                    currentAnalysisResults = data;
                    displayAnalysisResults(data.results, isAutoReanalysis);
                    updateStatsGrid(data.results);
                    prepareVisualizationData(data.results);

                    document.getElementById('visualizeBtn').style.display = 'block';
                    document.getElementById('downloadBtn').style.display = 'block';

                    showRealtimeStatus(`성공률: ${(data.results.statistics.success_rate || 0).toFixed(1)}%`);
                } else {
                    showStatus(`❌ 분석 오류: ${data.error}`, 'error');
                    showRealtimeStatus('분석 실패');
                }

            } catch (error) {
                showStatus(`❌ 분석 중 오류가 발생했습니다: ${error.message}`, 'error');
                showRealtimeStatus('연결 오류');
            }
        }

        // 상태 표시
        function showStatus(message, type = 'info') {
            const statusDisplay = document.getElementById('statusDisplay');
            statusDisplay.textContent = message;

            statusDisplay.className = 'status-panel';
            if (type === 'error') {
                statusDisplay.style.borderLeftColor = '#e74c3c';
                statusDisplay.style.background = '#fdf2f2';
            } else if (type === 'success') {
                statusDisplay.style.borderLeftColor = '#27ae60';
                statusDisplay.style.background = '#f2f9f4';
            } else if (type === 'loading') {
                statusDisplay.style.borderLeftColor = '#f39c12';
                statusDisplay.style.background = '#fef9e7';
            } else {
                statusDisplay.style.borderLeftColor = '#3498db';
                statusDisplay.style.background = '#f8f9fa';
            }
        }

        // 실시간 상태 표시
        function showRealtimeStatus(message) {
            document.getElementById('realtimeStats').textContent = message;
        }

        // 분석 결과 표시
        function displayAnalysisResults(results, isAutoReanalysis = false) {
            const stats = results.statistics;
            const prefix = isAutoReanalysis ? '🔄 실시간 재분석 완료!' : '🔬 분석 완료!';

            const summary = `${prefix}

=== 분석 요약 ===
총 화합물 수: ${stats.total_compounds || 'N/A'}
유효 화합물: ${stats.valid_compounds || 'N/A'}
이상치: ${stats.outliers || 'N/A'}
성공률: ${(stats.success_rate || 0).toFixed(1)}%

=== 현재 설정 ===
표준화 잔차 임계값: ${currentSettings.outlierThreshold}
R² 임계값: ${currentSettings.r2Threshold}
RT 허용 범위: ±${currentSettings.rtTolerance}분
분석 모드: ${currentSettings.analysisMode}

${isAutoReanalysis ? '⚡ 실시간 모드: 설정 변경이 자동 반영되었습니다.' : ''}`;

            showStatus(summary, 'success');
        }

        // 통계 그리드 업데이트
        function updateStatsGrid(results) {
            const stats = results.statistics;
            const grid = document.getElementById('statsGrid');

            grid.innerHTML = `
                <div class="stat-card">
                    <div class="stat-number">${stats.total_compounds || 0}</div>
                    <div class="stat-label">총 화합물</div>
                </div>
                <div class="stat-card" style="background: linear-gradient(135deg, #27ae60, #229954);">
                    <div class="stat-number">${stats.valid_compounds || 0}</div>
                    <div class="stat-label">유효 화합물</div>
                </div>
                <div class="stat-card" style="background: linear-gradient(135deg, #e74c3c, #c0392b);">
                    <div class="stat-number">${stats.outliers || 0}</div>
                    <div class="stat-label">이상치</div>
                </div>
                <div class="stat-card" style="background: linear-gradient(135deg, #f39c12, #e67e22);">
                    <div class="stat-number">${(stats.success_rate || 0).toFixed(1)}%</div>
                    <div class="stat-label">성공률</div>
                </div>
            `;

            grid.style.display = 'grid';
        }

        // 시각화 데이터 준비
        function prepareVisualizationData(results) {
            const valid_compounds = results.valid_compounds || [];
            const outliers = results.outliers || [];
            const all_compounds = valid_compounds.concat(outliers);

            if (all_compounds.length === 0) return;

            // 데이터 추출 및 m/z 계산
            compoundData = {
                names: all_compounds.map(c => c.Name),
                retention_times: all_compounds.map(c => c.RT),
                log_p_values: all_compounds.map(c => c["Log P"]),
                volumes: all_compounds.map(c => c.Volume),
                anchor_mask: all_compounds.map(c => c.Anchor === "T"),
                outlier_mask: all_compounds.map(c => outliers.includes(c)),
                mass_to_charge: all_compounds.map(c => calculateMassToCharge(c.Name))
            };

            // 자동으로 2D와 3D 플롯 생성
            create2DPlot();
            create3DPlot();
        }

        // Mass-to-charge 계산 (프론트엔드 버전)
        function calculateMassToCharge(compoundName) {
            const pattern = /\((\d+):(\d+);O(\d+)\)/;
            const match = compoundName.match(pattern);

            if (!match) return 800.0;

            const carbonCount = parseInt(match[1]);
            const unsaturation = parseInt(match[2]);
            const oxygenCount = parseInt(match[3]);

            const fattyAcidMW = carbonCount * 12.01 + (2 * carbonCount - 2 * unsaturation) * 1.008 + oxygenCount * 15.999;

            const gangliosideBaseWeights = {
                'GM3': 1200, 'GM2': 1400, 'GM1': 1500, 'GD3': 1500,
                'GD2': 1700, 'GD1': 1800, 'GT3': 1800, 'GT2': 2000,
                'GT1': 2100, 'GQ1': 2400, 'GP1': 2700
            };

            for (const [prefix, baseWeight] of Object.entries(gangliosideBaseWeights)) {
                if (compoundName.startsWith(prefix)) {
                    return baseWeight + fattyAcidMW;
                }
            }

            return 1500 + fattyAcidMW;
        }

        // 2D 플롯 생성
        function create2DPlot() {
            if (!compoundData) return;

            const traces = [];

            // Anchor 화합물
            const anchorIndices = compoundData.anchor_mask.map((isAnchor, idx) => isAnchor && !compoundData.outlier_mask[idx] ? idx : -1).filter(idx => idx >= 0);
            if (anchorIndices.length > 0) {
                traces.push({
                    x: anchorIndices.map(i => compoundData.log_p_values[i]),
                    y: anchorIndices.map(i => compoundData.retention_times[i]),
                    mode: 'markers',
                    type: 'scatter',
                    name: 'Anchor (T)',
                    marker: {
                        color: '#3498db',
                        size: 12,
                        symbol: 'diamond',
                        line: { color: 'white', width: 2 }
                    },
                    text: anchorIndices.map(i => compoundData.names[i]),
                    hovertemplate: '<b>%{text}</b><br>Log P: %{x}<br>RT: %{y}<extra></extra>'
                });
            }

            // 유효 화합물
            const validIndices = compoundData.anchor_mask.map((isAnchor, idx) => !isAnchor && !compoundData.outlier_mask[idx] ? idx : -1).filter(idx => idx >= 0);
            if (validIndices.length > 0) {
                traces.push({
                    x: validIndices.map(i => compoundData.log_p_values[i]),
                    y: validIndices.map(i => compoundData.retention_times[i]),
                    mode: 'markers',
                    type: 'scatter',
                    name: 'Valid Compounds',
                    marker: {
                        color: '#2ecc71',
                        size: 8,
                        line: { color: 'white', width: 1 }
                    },
                    text: validIndices.map(i => compoundData.names[i]),
                    hovertemplate: '<b>%{text}</b><br>Log P: %{x}<br>RT: %{y}<extra></extra>'
                });
            }

            // 이상치
            if (showOutliers2D) {
                const outlierIndices = compoundData.outlier_mask.map((isOutlier, idx) => isOutlier ? idx : -1).filter(idx => idx >= 0);
                if (outlierIndices.length > 0) {
                    traces.push({
                        x: outlierIndices.map(i => compoundData.log_p_values[i]),
                        y: outlierIndices.map(i => compoundData.retention_times[i]),
                        mode: 'markers',
                        type: 'scatter',
                        name: 'Outliers',
                        marker: {
                            color: '#e74c3c',
                            size: 10,
                            symbol: 'x',
                            line: { width: 2 }
                        },
                        text: outlierIndices.map(i => compoundData.names[i]),
                        hovertemplate: '<b>%{text}</b><br>Log P: %{x}<br>RT: %{y}<br><b>이상치</b><extra></extra>'
                    });
                }
            }

            const layout = {
                title: 'Retention Time vs Log P (2D)',
                xaxis: { title: 'Log P (Partition Coefficient)' },
                yaxis: { title: 'Retention Time (min)' },
                hovermode: 'closest',
                showlegend: true,
                legend: { x: 0.02, y: 0.98 }
            };

            Plotly.newPlot('plot-2d', traces, layout, { responsive: true });
        }

        // 3D 플롯 생성
        function create3DPlot() {
            if (!compoundData) return;

            const traces = [];

            // Anchor 화합물
            const anchorIndices = compoundData.anchor_mask.map((isAnchor, idx) => isAnchor && !compoundData.outlier_mask[idx] ? idx : -1).filter(idx => idx >= 0);
            if (anchorIndices.length > 0) {
                traces.push({
                    x: anchorIndices.map(i => compoundData.mass_to_charge[i]),
                    y: anchorIndices.map(i => compoundData.retention_times[i]),
                    z: anchorIndices.map(i => compoundData.log_p_values[i]),
                    mode: 'markers',
                    type: 'scatter3d',
                    name: 'Anchor (T)',
                    marker: {
                        color: '#3498db',
                        size: 8,
                        symbol: 'diamond',
                        line: { color: 'white', width: 2 }
                    },
                    text: anchorIndices.map(i => compoundData.names[i]),
                    hovertemplate: '<b>%{text}</b><br>m/z: %{x:.1f}<br>RT: %{y:.3f}<br>Log P: %{z:.2f}<extra></extra>'
                });
            }

            // 유효 화합물
            const validIndices = compoundData.anchor_mask.map((isAnchor, idx) => !isAnchor && !compoundData.outlier_mask[idx] ? idx : -1).filter(idx => idx >= 0);
            if (validIndices.length > 0) {
                traces.push({
                    x: validIndices.map(i => compoundData.mass_to_charge[i]),
                    y: validIndices.map(i => compoundData.retention_times[i]),
                    z: validIndices.map(i => compoundData.log_p_values[i]),
                    mode: 'markers',
                    type: 'scatter3d',
                    name: 'Valid Compounds',
                    marker: {
                        color: '#2ecc71',
                        size: 6,
                        line: { color: 'white', width: 1 }
                    },
                    text: validIndices.map(i => compoundData.names[i]),
                    hovertemplate: '<b>%{text}</b><br>m/z: %{x:.1f}<br>RT: %{y:.3f}<br>Log P: %{z:.2f}<extra></extra>'
                });
            }

            // 이상치
            if (showOutliers3D) {
                const outlierIndices = compoundData.outlier_mask.map((isOutlier, idx) => isOutlier ? idx : -1).filter(idx => idx >= 0);
                if (outlierIndices.length > 0) {
                    traces.push({
                        x: outlierIndices.map(i => compoundData.mass_to_charge[i]),
                        y: outlierIndices.map(i => compoundData.retention_times[i]),
                        z: outlierIndices.map(i => compoundData.log_p_values[i]),
                        mode: 'markers',
                        type: 'scatter3d',
                        name: 'Outliers',
                        marker: {
                            color: '#e74c3c',
                            size: 6,
                            symbol: 'x',
                            line: { width: 2 }
                        },
                        text: outlierIndices.map(i => compoundData.names[i]),
                        hovertemplate: '<b>%{text}</b><br>m/z: %{x:.1f}<br>RT: %{y:.3f}<br>Log P: %{z:.2f}<br><b>이상치</b><extra></extra>'
                    });
                }
            }

            const layout = {
                title: '3D Distribution: m/z vs RT vs Log P',
                scene: {
                    xaxis: { title: 'Mass-to-Charge (m/z)' },
                    yaxis: { title: 'Retention Time (min)' },
                    zaxis: { title: 'Partition Coefficient (Log P)' },
                    camera: {
                        eye: { x: 1.2, y: 1.2, z: 1.2 }
                    }
                },
                showlegend: true,
                legend: { x: 0.02, y: 0.98 }
            };

            Plotly.newPlot('plot-3d', traces, layout, { responsive: true });
        }

        // 통합 시각화 생성
        async function generateIntegratedVisualization() {
            if (!currentAnalysisResults) {
                showStatus('❌ 분석 결과가 없습니다. 먼저 분석을 실행해주세요.', 'error');
                return;
            }

            try {
                showStatus('🔄 통합 시각화 생성 중...', 'loading');

                const response = await fetch('/api/visualize', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        results: currentAnalysisResults.results
                    })
                });

                const data = await response.json();

                if (data.plots && data.plots.integrated_visualization) {
                    document.getElementById('integratedVisualization').innerHTML = data.plots.integrated_visualization;
                    showStatus('✅ 통합 시각화 생성 완료!', 'success');
                    switchTab('integrated');
                } else {
                    showStatus('❌ 통합 시각화 생성 실패', 'error');
                }

            } catch (error) {
                showStatus(`❌ 통합 시각화 생성 중 오류: ${error.message}`, 'error');
            }
        }

        // 통합 뷰 새로고침
        function refreshIntegratedView() {
            generateIntegratedVisualization();
        }

        // 통합 시각화 새 창에서 열기
        function openIntegratedWindow() {
            if (!currentAnalysisResults) return;

            const newWindow = window.open('', '_blank', 'width=1400,height=900');
            const integratedContent = document.getElementById('integratedVisualization').innerHTML;

            newWindow.document.write(
                '<!DOCTYPE html>' +
                '<html>' +
                '<head>' +
                '    <title>통합 LC-MS-MS 시각화</title>' +
                '    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>' +
                '</head>' +
                '<body>' +
                integratedContent +
                '</body>' +
                '</html>'
            );
            newWindow.document.close();
        }

        // 컨트롤 함수들
        function reset2DView() {
            Plotly.relayout('plot-2d', {
                'xaxis.autorange': true,
                'yaxis.autorange': true
            });
        }

        function reset3DView() {
            Plotly.relayout('plot-3d', {
                'scene.camera': {
                    eye: { x: 1.2, y: 1.2, z: 1.2 }
                }
            });
        }

        function toggle2DOutliers() {
            showOutliers2D = !showOutliers2D;
            create2DPlot();
        }

        function toggle3DOutliers() {
            showOutliers3D = !showOutliers3D;
            create3DPlot();
        }

        function show2DRegression() {
            showRegression2D = !showRegression2D;
            // 회귀선 구현 (추후 추가 가능)
            create2DPlot();
        }

        function toggle3DRegression() {
            showRegression3D = !showRegression3D;
            // 회귀평면 구현 (추후 추가 가능)
            create3DPlot();
        }

        // 결과 다운로드
        function downloadResults() {
            if (!currentAnalysisResults) {
                showStatus('❌ 분석 결과가 없습니다. 먼저 분석을 실행해주세요.', 'error');
                return;
            }

            try {
                const csvContent = generateCSVFromResults(currentAnalysisResults);
                const blob = new Blob([csvContent], { type: 'text/csv' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `ganglioside_analysis_results_${new Date().toISOString().slice(0,19).replace(/:/g, '-')}.csv`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);

                showStatus('💾 분석 결과가 성공적으로 다운로드되었습니다!', 'success');

            } catch (error) {
                showStatus(`❌ 다운로드 오류: ${error.message}`, 'error');
            }
        }

        // CSV 생성
        function generateCSVFromResults(results) {
            let csv = 'Name,RT,Volume,Log P,Anchor,Status,m/z,Analysis_Settings\n';

            const settingsString = `"Outlier:${currentSettings.outlierThreshold}|R2:${currentSettings.r2Threshold}|RT:${currentSettings.rtTolerance}|Mode:${currentSettings.analysisMode}"`;

            // 유효 화합물 추가
            if (results.results.valid_compounds) {
                results.results.valid_compounds.forEach(compound => {
                    const mz = calculateMassToCharge(compound.Name);
                    csv += `"${compound.Name}",${compound.RT},${compound.Volume || 'N/A'},"${compound['Log P']}","${compound.Anchor}","Valid",${mz.toFixed(1)},${settingsString}\n`;
                });
            }

            // 이상치 추가
            if (results.results.outliers) {
                results.results.outliers.forEach(compound => {
                    const reason = compound.outlier_reason || 'Unknown';
                    const mz = calculateMassToCharge(compound.Name);
                    csv += `"${compound.Name}",${compound.RT},${compound.Volume || 'N/A'},"${compound['Log P']}","${compound.Anchor}","Outlier: ${reason}",${mz.toFixed(1)},${settingsString}\n`;
                });
            }

            return csv;
        }

        // 연결 테스트 함수
        async function testConnection() {
            try {
                showStatus('🔌 서버 연결 테스트 중...', 'loading');
                console.log('Testing server connection...');

                const response = await fetch('/api/health');
                const data = await response.json();

                console.log('Health check response:', data);

                if (response.ok && data.status === 'healthy') {
                    showStatus('✅ 서버 연결 성공! 분석 준비 완료.', 'success');
                } else {
                    showStatus('⚠️ 서버 응답이 이상합니다.', 'error');
                }
            } catch (error) {
                console.error('Connection test failed:', error);
                showStatus(`❌ 서버 연결 실패: ${error.message}`, 'error');
            }
        }

        // 창 크기 변경 시 플롯 리사이즈
        window.addEventListener('resize', function() {
            ['plot-2d', 'plot-3d'].forEach(id => {
                const element = document.getElementById(id);
                if (element && element.data) {
                    Plotly.Plots.resize(element);
                }
            });
        });

        // 키보드 단축키
        document.addEventListener('keydown', function(e) {
            // Ctrl+Enter: 분석 실행
            if (e.ctrlKey && e.key === 'Enter') {
                e.preventDefault();
                runAnalysis();
            }

            // Ctrl+S: 결과 다운로드
            if (e.ctrlKey && e.key === 's') {
                e.preventDefault();
                if (currentAnalysisResults) {
                    downloadResults();
                }
            }
        });

        console.log('🧬 통합 LC-MS-MS 분석 플랫폼 초기화 완료!');
        console.log('📋 단축키: Ctrl+Enter (분석), Ctrl+S (다운로드)');
    </script>
</body>
</html>