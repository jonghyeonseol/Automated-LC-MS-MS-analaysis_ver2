            if (!file && isAutoReanalysis) {
                // ìë™ ì¬ë¶„ì„ì¸ë° íŒŒì¼ì´ ì—†ìœ¼ë©´ ìƒ˜í”Œ ë°ì´í„° ì‚¬ìš©
                return await testSampleData(true);
            }
            
            const formData = new FormData();
            formData.append('file', file);
            formData.append('data_type', currentSettings.analysisMode);
            formData.append('outlier_threshold', currentSettings.outlierThreshold.toString());
            formData.append('r2_threshold', currentSettings.r2Threshold.toString());
            formData.append('rt_tolerance', currentSettings.rtTolerance.toString());
            
            try {
                showLoading(true);
                updateStatus(isAutoReanalysis ? 'ğŸ”„ ì‹¤ì‹œê°„ ì¬ë¶„ì„ ì¤‘...' : 'ğŸ”¬ ë°ì´í„° ë¶„ì„ ì¤‘...');
                
                const response = await fetch(`${API_BASE}/api/analyze`, {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    currentAnalysisResults = result.results;
                    displayAnalysisResults(result.results, isAutoReanalysis);
                    updateStatus(isAutoReanalysis ? 'âœ… ì‹¤ì‹œê°„ ì¬ë¶„ì„ ì™„ë£Œ' : 'âœ… ë°ì´í„° ë¶„ì„ ì™„ë£Œ');
                } else {
                    showResult(`âŒ ë¶„ì„ ì‹¤íŒ¨: ${result.detail || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'}`, 'error');
                    updateStatus('âŒ ë¶„ì„ ì‹¤íŒ¨');
                }
            } catch (error) {
                showResult(`âŒ ë¶„ì„ ì˜¤ë¥˜: ${error.message}`, 'error');
                updateStatus('âŒ ë¶„ì„ ì˜¤ë¥˜');
            } finally {
                showLoading(false);
            }
        }
        
        // ì‹œê°í™” ìƒì„± í•¨ìˆ˜ (í–¥ìƒëœ ë²„ì „)
        async function createVisualization() {
            if (!currentAnalysisResults) {
                showResult('âš ï¸ ë¨¼ì € ë°ì´í„° ë¶„ì„ì„ ìˆ˜í–‰í•´ì£¼ì„¸ìš”.', 'warning');
                return;
            }
            
            try {
                showLoading(true);
                updateStatus('ğŸ“Š ê³ ê¸‰ ì‹œê°í™” ìƒì„± ì¤‘...');
                
                // ì‹œê°í™” ì»¨í…Œì´ë„ˆ í‘œì‹œ
                document.getElementById('visualizationContainer').style.display = 'block';
                
                // ìƒì„¸í•œ ì‹œê°í™” HTML ìƒì„±
                const results = currentAnalysisResults.results || currentAnalysisResults;
                const stats = results.statistics;
                const validCount = stats.valid_compounds || 0;
                const outlierCount = stats.outliers || 0;
                const totalCount = stats.total_compounds || 0;
                const successRate = stats.success_rate || 0;
                const anchorCount = stats.anchor_compounds || 0;
                
                // í˜„ì¬ ì„¤ì • ì •ë³´
                const settingsInfo = `
                    <div style="background: rgba(52, 73, 94, 0.1); padding: 15px; border-radius: 8px; margin: 10px 0;">
                        <h5 style="margin-top: 0;">ğŸ›ï¸ í˜„ì¬ ë¶„ì„ ì„¤ì •</h5>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; font-size: 0.9em;">
                            <div><strong>í‘œì¤€í™” ì”ì°¨ ì„ê³„ê°’:</strong> ${currentSettings.outlierThreshold}</div>
                            <div><strong>RÂ² ì„ê³„ê°’:</strong> ${currentSettings.r2Threshold}</div>
                            <div><strong>RT í—ˆìš© ë²”ìœ„:</strong> Â±${currentSettings.rtTolerance}ë¶„</div>
                            <div><strong>ë¶„ì„ ëª¨ë“œ:</strong> ${currentSettings.analysisMode}</div>
                        </div>
                    </div>
                `;
                
                // ì„¤ì • ì˜í–¥ ë¶„ì„
                const settingsImpact = `
                    <div style="background: linear-gradient(135deg, #3498db, #2980b9); color: white; padding: 20px; border-radius: 12px; margin: 15px 0;">
                        <h4 style="margin-top: 0; text-align: center;">ğŸ“ˆ ì„¤ì • ì˜í–¥ ë¶„ì„</h4>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px;">
                            <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 8px; text-align: center;">
                                <h3>${(currentSettings.outlierThreshold >= 3.0 ? 'ì—„ê²©' : currentSettings.outlierThreshold >= 2.0 ? 'ë³´í†µ' : 'ê´€ëŒ€')}</h3>
                                <p>ì´ìƒì¹˜ íŒë³„</p>
                            </div>
                            <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 8px; text-align: center;">
                                <h3>${(currentSettings.r2Threshold >= 0.99 ? 'ë§¤ìš° ë†’ìŒ' : currentSettings.r2Threshold >= 0.95 ? 'ë†’ìŒ' : 'ë³´í†µ')}</h3>
                                <p>íšŒê·€ í’ˆì§ˆ ìš”êµ¬</p>
                            </div>
                            <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 8px; text-align: center;">
                                <h3>${(currentSettings.rtTolerance <= 0.1 ? 'ì •ë°€' : currentSettings.rtTolerance <= 0.2 ? 'ë³´í†µ' : 'ê´€ëŒ€')}</h3>
                                <p>RT í—ˆìš©ë„</p>
                            </div>
                        </div>
                    </div>
                `;
                
                // ë©”ì¸ ëŒ€ì‹œë³´ë“œ
                const mainDashboard = `
                    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 25px; border-radius: 15px; margin: 15px 0; color: white;">
                        <h3 style="margin-top: 0; text-align: center;">ğŸ† Ganglioside ë¶„ì„ ëŒ€ì‹œë³´ë“œ</h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; margin: 25px 0;">
                            <div style="background: rgba(255,255,255,0.15); padding: 20px; border-radius: 12px; text-align: center;">
                                <h2 style="margin: 0; font-size: 2.5em;">${totalCount}</h2>
                                <p style="margin: 8px 0;">ì´ í™”í•©ë¬¼</p>
                            </div>
                            <div style="background: rgba(46, 204, 113, 0.2); padding: 20px; border-radius: 12px; text-align: center;">
                                <h2 style="margin: 0; font-size: 2.5em; color: #2ecc71;">${validCount}</h2>
                                <p style="margin: 8px 0;">ìœ íš¨ í™”í•©ë¬¼</p>
                            </div>
                            <div style="background: rgba(231, 76, 60, 0.2); padding: 20px; border-radius: 12px; text-align: center;">
                                <h2 style="margin: 0; font-size: 2.5em; color: #e74c3c;">${outlierCount}</h2>
                                <p style="margin: 8px 0;">ì´ìƒì¹˜</p>
                            </div>
                            <div style="background: rgba(243, 156, 18, 0.2); padding: 20px; border-radius: 12px; text-align: center;">
                                <h2 style="margin: 0; font-size: 2.5em; color: #f39c12;">${successRate.toFixed(1)}%</h2>
                                <p style="margin: 8px 0;">ì„±ê³µë¥ </p>
                            </div>
                        </div>
                        <div style="text-align: center; margin-top: 20px;">
                            <p style="font-size: 1.2em;">ğŸ¯ ë¶„ì„ ìƒíƒœ: ${results.status || 'Interactive Analysis'}</p>
                            <p style="font-size: 1.1em;">ğŸ“Š ëª©í‘œ ë‹¬ì„±: ${results.target_achievement || 'N/A'}</p>
                        </div>
                    </div>
                `;
                
                // ì‹¤ì‹œê°„ ë¶„ì„ ì •ë³´
                const realTimeInfo = isRealTimeMode ? `
                    <div style="background: linear-gradient(45deg, #27ae60, #2ecc71); color: white; padding: 20px; border-radius: 12px; margin: 15px 0; text-align: center;">
                        <h4 style="margin-top: 0;">âš¡ ì‹¤ì‹œê°„ ë¶„ì„ ëª¨ë“œ í™œì„±í™”</h4>
                        <p style="margin: 10px 0;">ì„¤ì • ë³€ê²½ ì‹œ ìë™ìœ¼ë¡œ ì¬ë¶„ì„ì´ ìˆ˜í–‰ë©ë‹ˆë‹¤</p>
                        <p style="font-size: 0.9em; opacity: 0.8;">ë§ˆì§€ë§‰ ë¶„ì„: ${new Date().toLocaleTimeString()}</p>
                    </div>
                ` : `
                    <div style="background: linear-gradient(45deg, #f39c12, #e67e22); color: white; padding: 15px; border-radius: 8px; margin: 15px 0; text-align: center;">
                        <p style="margin: 0;">ğŸ’¡ ì‹¤ì‹œê°„ ëª¨ë“œë¥¼ í™œì„±í™”í•˜ë©´ ì„¤ì • ë³€ê²½ ì‹œ ìë™ ì¬ë¶„ì„ë©ë‹ˆë‹¤</p>
                        <button onclick="isRealTimeMode = true; updateStatus('âš¡ ì‹¤ì‹œê°„ ëª¨ë“œ í™œì„±í™”');" style="background: rgba(255,255,255,0.2); border: none; color: white; padding: 8px 16px; border-radius: 4px; margin-top: 8px; cursor: pointer;">
                            ğŸš€ ì‹¤ì‹œê°„ ëª¨ë“œ í™œì„±í™”
                        </button>
                    </div>
                `;
                
                const visualizationHtml = settingsInfo + settingsImpact + mainDashboard + realTimeInfo;
                
                document.getElementById('visualizations').innerHTML = visualizationHtml;
                
                showResult('ğŸ“Š ì¸í„°ë™í‹°ë¸Œ ì‹œê°í™”ê°€ ì„±ê³µì ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!\\n\\nâœ¨ ìƒˆë¡œìš´ ê¸°ëŠ¥:\\n- í˜„ì¬ ì„¤ì • í‘œì‹œ\\n- ì„¤ì • ì˜í–¥ ë¶„ì„\\n- ì‹¤ì‹œê°„ ë¶„ì„ ëª¨ë“œ\\n- ìƒì„¸ ëŒ€ì‹œë³´ë“œ', 'success');
                updateStatus('âœ… ì‹œê°í™” ì™„ë£Œ');
                
                // ì‹œê°í™” ì˜ì—­ìœ¼ë¡œ ìŠ¤í¬ë¡¤
                document.getElementById('visualizationContainer').scrollIntoView({ behavior: 'smooth' });
                
            } catch (error) {
                showResult(`âŒ ì‹œê°í™” ì˜¤ë¥˜: ${error.message}`, 'error');
                updateStatus('âŒ ì‹œê°í™” ì‹¤íŒ¨');
            } finally {
                showLoading(false);
            }
        }
        
        // ìƒ˜í”Œ ë°ì´í„° í…ŒìŠ¤íŠ¸ (í–¥ìƒëœ ë²„ì „)
        async function testSampleData(isAutoReanalysis = false) {
            try {
                showLoading(true);
                updateStatus(isAutoReanalysis ? 'ğŸ”„ ìƒ˜í”Œ ë°ì´í„° ì¬ë¶„ì„ ì¤‘...' : 'ğŸ§ª ìƒ˜í”Œ ë°ì´í„° í…ŒìŠ¤íŠ¸ ì¤‘...');
                
                const sampleCSV = `Name,RT,Volume,Log P,Anchor
GD1a(36:1;O2),9.572,1000000,1.53,T
GM1a(36:1;O2),10.452,500000,4.00,F
GM3(36:1;O2),10.606,2000000,7.74,F
GD3(36:1;O2),10.126,800000,5.27,T
GT1b(36:1;O2),8.701,1200000,-0.94,T
GQ1c(36:1;O2),8.101,600000,-3.41,T
GP1(36:1;O2),7.851,300000,-5.88,F
GD1b(34:1;O2),9.123,750000,2.15,F
GM2(d18:1/16:0),11.234,450000,5.82,F
GT3(d18:1/18:0),8.967,920000,0.35,T`;
                
                const blob = new Blob([sampleCSV], { type: 'text/csv' });
                const formData = new FormData();
                formData.append('file', blob, 'enhanced_sample_data.csv');
                formData.append('data_type', currentSettings.analysisMode);
                formData.append('outlier_threshold', currentSettings.outlierThreshold.toString());
                formData.append('r2_threshold', currentSettings.r2Threshold.toString());
                formData.append('rt_tolerance', currentSettings.rtTolerance.toString());
                
                const response = await fetch(`${API_BASE}/api/analyze`, {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    currentAnalysisResults = result.results;
                    displayAnalysisResults(result.results, isAutoReanalysis);
                    updateStatus(isAutoReanalysis ? 'âœ… ì‹¤ì‹œê°„ ì¬ë¶„ì„ ì™„ë£Œ' : 'âœ… ìƒ˜í”Œ ë°ì´í„° í…ŒìŠ¤íŠ¸ ì™„ë£Œ');
                    
                    // ì‹¤ì‹œê°„ ëª¨ë“œ ì œì•ˆ (ì²« ë²ˆì§¸ í…ŒìŠ¤íŠ¸ì¼ ë•Œë§Œ)
                    if (!isAutoReanalysis && !isRealTimeMode) {
                        setTimeout(() => {
                            showResult('ğŸ’¡ íŒ: ì‹¤ì‹œê°„ ëª¨ë“œë¥¼ í™œì„±í™”í•˜ë©´ ì„¤ì • ë³€ê²½ ì‹œ ìë™ìœ¼ë¡œ ì¬ë¶„ì„ë©ë‹ˆë‹¤!', 'info');
                        }, 3000);
                    }
                } else {
                    showResult(`âŒ ìƒ˜í”Œ í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨: ${result.detail || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'}`, 'error');
                    updateStatus('âŒ ìƒ˜í”Œ í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨');
                }
            } catch (error) {
                showResult(`âŒ ìƒ˜í”Œ í…ŒìŠ¤íŠ¸ ì˜¤ë¥˜: ${error.message}`, 'error');
                updateStatus('âŒ ìƒ˜í”Œ í…ŒìŠ¤íŠ¸ ì˜¤ë¥˜');
            } finally {
                showLoading(false);
            }
        }
        
        // ë³µí•© ìƒ˜í”Œ í…ŒìŠ¤íŠ¸
        async function testComplexSample() {
            showResult('ğŸ§¬ ë³µí•© ìƒ˜í”Œ ë°ì´í„° ì¤€ë¹„ ì¤‘...\\n\\nì´ í…ŒìŠ¤íŠ¸ëŠ” ë‹¤ìŒì„ í¬í•¨í•©ë‹ˆë‹¤:\\n- ë‹¤ì–‘í•œ ì´ì„±ì§ˆì²´\\n- O-acetylation í™”í•©ë¬¼\\n- In-source fragmentation í›„ë³´\\n- ë‹¤ì–‘í•œ ì ‘ë‘ì‚¬/ì ‘ë¯¸ì‚¬ ì¡°í•©', 'info');
            
            setTimeout(async () => {
                try {
                    showLoading(true);
                    updateStatus('ğŸ§¬ ë³µí•© ìƒ˜í”Œ ë¶„ì„ ì¤‘...');
                    
                    const complexCSV = `Name,RT,Volume,Log P,Anchor
GD1a(36:1;O2),9.572,1000000,1.53,T
GD1b(36:1;O2),9.823,850000,1.48,F
GD1a+OAc(36:1;O2),10.125,650000,2.15,F
GM1a(34:1;O2),10.452,500000,4.00,F
GM1a+2OAc(34:1;O2),11.234,320000,4.85,F
GM3(36:1;O2),10.606,2000000,7.74,F
GM3(34:1;O2),10.598,1800000,7.69,F
GD3(36:1;O2),10.126,800000,5.27,T
GT1b(36:1;O2),8.701,1200000,-0.94,T
GT1c(36:1;O2),8.945,950000,-0.89,F
GQ1b(36:1;O2),8.101,600000,-3.41,T
GQ1c(36:1;O2),8.234,580000,-3.36,F
GP1(36:1;O2),7.851,300000,-5.88,F
GD1+dHex(36:1;O2),9.823,750000,1.48,F
GD1+HexNAc(36:1;O2),9.572,690000,1.53,F`;
                    
                    const blob = new Blob([complexCSV], { type: 'text/csv' });
                    const formData = new FormData();
                    formData.append('file', blob, 'complex_sample_data.csv');
                    formData.append('data_type', currentSettings.analysisMode);
                    formData.append('outlier_threshold', currentSettings.outlierThreshold.toString());
                    formData.append('r2_threshold', currentSettings.r2Threshold.toString());
                    formData.append('rt_tolerance', currentSettings.rtTolerance.toString());
                    
                    const response = await fetch(`${API_BASE}/api/analyze`, {
                        method: 'POST',
                        body: formData
                    });
                    
                    const result = await response.json();
                    
                    if (response.ok) {
                        currentAnalysisResults = result.results;
                        displayAnalysisResults(result.results);
                        updateStatus('âœ… ë³µí•© ìƒ˜í”Œ ë¶„ì„ ì™„ë£Œ');
                        
                        showResult('ğŸ§¬ ë³µí•© ìƒ˜í”Œ ë¶„ì„ ì™„ë£Œ!\\n\\nì´ í…ŒìŠ¤íŠ¸ì—ì„œëŠ” ë‹¤ìŒì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:\\n- ì´ì„±ì§ˆì²´ ìë™ ë¶„ë¥˜\\n- O-acetylation íš¨ê³¼ ê²€ì¦\\n- ë³µì¡í•œ êµ¬ì¡° ë¶„ì„\\n\\nì„¤ì •ì„ ë³€ê²½í•˜ì—¬ ê²°ê³¼ ë³€í™”ë¥¼ ê´€ì°°í•´ë³´ì„¸ìš”!', 'success');
                    } else {
                        showResult(`âŒ ë³µí•© ìƒ˜í”Œ ë¶„ì„ ì‹¤íŒ¨: ${result.detail || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'}`, 'error');
                        updateStatus('âŒ ë³µí•© ìƒ˜í”Œ ë¶„ì„ ì‹¤íŒ¨');
                    }
                } catch (error) {
                    showResult(`âŒ ë³µí•© ìƒ˜í”Œ ë¶„ì„ ì˜¤ë¥˜: ${error.message}`, 'error');
                    updateStatus('âŒ ë³µí•© ìƒ˜í”Œ ë¶„ì„ ì˜¤ë¥˜');
                } finally {
                    showLoading(false);
                }
            }, 2000);
        }
        
        // ë„ì „ ë°ì´í„° í…ŒìŠ¤íŠ¸
        async function testChallengeData() {
            if (!confirm('âš ï¸ ë„ì „ ë°ì´í„°ëŠ” ë¶„ì„í•˜ê¸° ì–´ë ¤ìš´ ë°ì´í„°ë¥¼ í¬í•¨í•©ë‹ˆë‹¤.\\në‚®ì€ ì„±ê³µë¥ ì´ ì˜ˆìƒë˜ë©°, ì„¤ì • ì¡°ì •ì´ í•„ìš”í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.\\n\\nê³„ì†í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                return;
            }
            
            showResult('ğŸ’€ ë„ì „ ë°ì´í„° í…ŒìŠ¤íŠ¸ ì‹œì‘!\\n\\nì´ ë°ì´í„°ì…‹ì€ ë‹¤ìŒ ë¬¸ì œë¥¼ í¬í•¨í•©ë‹ˆë‹¤:\\n- ë‚®ì€ RÂ² ê°’\\n- í° RT í¸ì°¨\\n- ë³µì¡í•œ ì´ìƒì¹˜ íŒ¨í„´\\n- ë¶ˆì™„ì „í•œ anchor ë°ì´í„°', 'warning');
            
            // ì„¤ì •ì„ ë” ê´€ëŒ€í•˜ê²Œ ë³€ê²½ ì œì•ˆ
            setTimeout(() => {
                if (confirm('ğŸ’¡ ë„ì „ ë°ì´í„°ë¥¼ ìœ„í•´ ì„¤ì •ì„ ë” ê´€ëŒ€í•˜ê²Œ ë³€ê²½í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\\n- í‘œì¤€í™” ì”ì°¨ ì„ê³„ê°’: 2.0\\n- RÂ² ì„ê³„ê°’: 0.95\\n- RT í—ˆìš© ë²”ìœ„: 0.2ë¶„')) {
                    document.getElementById('outlierThreshold').value = 2.0;
                    document.getElementById('r2Threshold').value = 0.95;
                    document.getElementById('rtTolerance').value = 0.2;
                    
                    document.getElementById('outlierValue').textContent = '2.0';
                    document.getElementById('r2Value').textContent = '0.950';
                    document.getElementById('rtValue').textContent = 'Â±0.20';
                    
                    currentSettings.outlierThreshold = 2.0;
                    currentSettings.r2Threshold = 0.95;
                    currentSettings.rtTolerance = 0.2;
                }
                
                // ì‹¤ì œ ë„ì „ ë°ì´í„° ë¶„ì„ ìˆ˜í–‰
                performChallengeAnalysis();
            }, 3000);
        }
        
        async function performChallengeAnalysis() {
            try {
                showLoading(true);
                updateStatus('ğŸ’€ ë„ì „ ë°ì´í„° ë¶„ì„ ì¤‘...');
                
                const challengeCSV = `Name,RT,Volume,Log P,Anchor
GD1a(36:1;O2),9.572,1000000,1.53,T
GM1a(36:1;O2),10.852,500000,4.20,F
GM3(36:1;O2),10.306,2000000,7.94,F
GD3(36:1;O2),11.726,800000,5.47,F
GT1b(36:1;O2),8.201,1200000,-0.74,T
Unknown_1(36:1;O2),12.543,450000,8.25,F
GQ1c(36:1;O2),7.501,600000,-3.61,F
GP1(36:1;O2),6.851,300000,-6.08,F
Contamination(36:1;O2),15.234,150000,12.45,F
GD1a(34:1;O2),9.123,750000,1.33,F
Noise_signal(unknown),8.765,50000,-2.15,F
GM1a+3OAc(36:1;O2),12.845,180000,5.95,F
Fragment_ion(36:1;O2),10.456,2500000,7.82,F
GD3_isomer(36:1;O2),11.999,720000,5.59,F
Artifact(36:1;O2),14.123,80000,9.87,F`;
                
                const blob = new Blob([challengeCSV], { type: 'text/csv' });
                const formData = new FormData();
                formData.append('file', blob, 'challenge_data.csv');
                formData.append('data_type', currentSettings.analysisMode);
                formData.append('outlier_threshold', currentSettings.outlierThreshold.toString());
                formData.append('r2_threshold', currentSettings.r2Threshold.toString());
                formData.append('rt_tolerance', currentSettings.rtTolerance.toString());
                
                const response = await fetch(`${API_BASE}/api/analyze`, {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    currentAnalysisResults = result.results;
                    displayAnalysisResults(result.results);
                    updateStatus('âœ… ë„ì „ ë°ì´í„° ë¶„ì„ ì™„ë£Œ');
                    
                    const stats = result.results.statistics;
                    const successRate = stats.success_rate || 0;
                    
                    let message = 'ğŸ’€ ë„ì „ ë°ì´í„° ë¶„ì„ ì™„ë£Œ!\\n\\n';
                    if (successRate >= 70) {
                        message += 'ğŸ† ìš°ìˆ˜! ì–´ë ¤ìš´ ë°ì´í„°ì—ì„œë„ ë†’ì€ ì„±ê³µë¥ ì„ ë‹¬ì„±í–ˆìŠµë‹ˆë‹¤.';
                    } else if (successRate >= 50) {
                        message += 'ğŸ‘ ì–‘í˜¸! ì„¤ì •ì„ ë” ì¡°ì •í•˜ë©´ ì„±ëŠ¥ì„ í–¥ìƒì‹œí‚¬ ìˆ˜ ìˆìŠµë‹ˆë‹¤.';
                    } else {
                        message += 'ğŸ”§ ê°œì„  í•„ìš”! ì„¤ì •ì„ ì¡°ì •í•˜ì—¬ ì„±ëŠ¥ì„ í–¥ìƒì‹œì¼œë³´ì„¸ìš”.\\n\\nğŸ’¡ íŒ:\\n- í‘œì¤€í™” ì”ì°¨ ì„ê³„ê°’ì„ ë‚®ì¶°ë³´ì„¸ìš”\\n- RÂ² ì„ê³„ê°’ì„ ë‚®ì¶°ë³´ì„¸ìš”\\n- RT í—ˆìš© ë²”ìœ„ë¥¼ ëŠ˜ë ¤ë³´ì„¸ìš”';
                    }
                    
                    showResult(message, successRate >= 70 ? 'success' : successRate >= 50 ? 'info' : 'warning');
                } else {
                    showResult(`âŒ ë„ì „ ë°ì´í„° ë¶„ì„ ì‹¤íŒ¨: ${result.detail || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'}`, 'error');
                    updateStatus('âŒ ë„ì „ ë°ì´í„° ë¶„ì„ ì‹¤íŒ¨');
                }
            } catch (error) {
                showResult(`âŒ ë„ì „ ë°ì´í„° ë¶„ì„ ì˜¤ë¥˜: ${error.message}`, 'error');
                updateStatus('âŒ ë„ì „ ë°ì´í„° ë¶„ì„ ì˜¤ë¥˜');
            } finally {
                showLoading(false);
            }
        }
        
        // ìƒì„¸ ë¦¬í¬íŠ¸ ìƒì„±
        function generateReport() {
            if (!currentAnalysisResults) {
                showResult('âš ï¸ ë¦¬í¬íŠ¸ë¥¼ ìƒì„±í•  ë¶„ì„ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.', 'warning');
                return;
            }
            
            const stats = currentAnalysisResults.statistics;
            const timestamp = new Date().toLocaleString();
            
            const reportData = `# Ganglioside Analysis Report
Generated: ${timestamp}

## Analysis Settings
- **Outlier Threshold**: ${currentSettings.outlierThreshold}
- **RÂ² Threshold**: ${currentSettings.r2Threshold}
- **RT Tolerance**: Â±${currentSettings.rtTolerance} min
- **Analysis Mode**: ${currentSettings.analysisMode}
- **Real-time Mode**: ${isRealTimeMode ? 'Enabled' : 'Disabled'}

## Summary Statistics
- **Total Compounds**: ${stats.total_compounds || 0}
- **Valid Compounds**: ${stats.valid_compounds || 0}
- **Outliers**: ${stats.outliers || 0}
- **Success Rate**: ${(stats.success_rate || 0).toFixed(1)}%
- **Anchor Compounds**: ${stats.anchor_compounds || 0}

## Rule-based Analysis
- **Rule 1 (Regression)**: ${stats.rule_breakdown?.rule1_regression || 0} valid
- **Rule 4 (O-acetylation)**: ${stats.rule_breakdown?.rule4_oacetylation || 0} valid
- **Rule 5 (RT Filtering)**: ${stats.rule_breakdown?.rule5_rt_filtering || 0} valid

## Settings History
${settingsHistory.map(entry => `- ${entry.timestamp}: ${entry.setting} = ${entry.value}`).join('\\n')}

## Analysis Status
${currentAnalysisResults.status || 'Unknown'}

Target Achievement: ${currentAnalysisResults.target_achievement || 'N/A'}
`;
            
            const blob = new Blob([reportData], { type: 'text/markdown' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `ganglioside_analysis_report_${new Date().toISOString().slice(0,19).replace(/:/g, '-')}.md`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
            
            showResult('ğŸ“‹ ìƒì„¸ ë¦¬í¬íŠ¸ê°€ ì„±ê³µì ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!\\n\\ní¬í•¨ ë‚´ìš©:\\n- ë¶„ì„ ì„¤ì •\\n- í†µê³„ ìš”ì•½\\n- ê·œì¹™ë³„ ê²°ê³¼\\n- ì„¤ì • ë³€ê²½ íˆìŠ¤í† ë¦¬', 'success');
        }
        
        // ê²°ê³¼ ë‹¤ìš´ë¡œë“œ (í–¥ìƒëœ ë²„ì „)
        async function downloadResults() {
            if (!currentAnalysisResults) {
                showResult('âš ï¸ ë‹¤ìš´ë¡œë“œí•  ë¶„ì„ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.', 'warning');
                return;
            }
            
            try {
                const csvContent = generateEnhancedCSVFromResults(currentAnalysisResults);
                const blob = new Blob([csvContent], { type: 'text/csv' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `ganglioside_analysis_results_${new Date().toISOString().slice(0,19).replace(/:/g, '-')}.csv`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
                
                showResult('ğŸ’¾ í–¥ìƒëœ ë¶„ì„ ê²°ê³¼ê°€ ì„±ê³µì ìœ¼ë¡œ ë‹¤ìš´ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤!\\n\\nì¶”ê°€ ì •ë³´ í¬í•¨:\\n- í˜„ì¬ ë¶„ì„ ì„¤ì •\\n- ì˜ˆì¸¡ RT ê°’\\n- í‘œì¤€í™” ì”ì°¨\\n- ìƒì„¸ ë¶„ë¥˜ ì‚¬ìœ ', 'success');
                updateStatus('âœ… ë‹¤ìš´ë¡œë“œ ì™„ë£Œ');
            } catch (error) {
                showResult(`âŒ ë‹¤ìš´ë¡œë“œ ì˜¤ë¥˜: ${error.message}`, 'error');
            }
        }
        
        // ë¶„ì„ ê²°ê³¼ í‘œì‹œ í•¨ìˆ˜ (í–¥ìƒëœ ë²„ì „)
        function displayAnalysisResults(results, isAutoReanalysis = false) {
            const stats = results.statistics;
            const prefix = isAutoReanalysis ? 'ğŸ”„ ì‹¤ì‹œê°„ ì¬ë¶„ì„ ì™„ë£Œ!' : 'ğŸ”¬ ë¶„ì„ ì™„ë£Œ!';
            
            const summary = `${prefix}

=== ë¶„ì„ ìš”ì•½ ===
ì´ í™”í•©ë¬¼ ìˆ˜: ${stats.total_compounds || 'N/A'}
ìœ íš¨ í™”í•©ë¬¼: ${stats.valid_compounds || 'N/A'}
ì´ìƒì¹˜: ${stats.outliers || 'N/A'}
ì„±ê³µë¥ : ${(stats.success_rate || 0).toFixed(1)}%

=== í˜„ì¬ ì„¤ì • ===
í‘œì¤€í™” ì”ì°¨ ì„ê³„ê°’: ${currentSettings.outlierThreshold}
RÂ² ì„ê³„ê°’: ${currentSettings.r2Threshold}
RT í—ˆìš© ë²”ìœ„: Â±${currentSettings.rtTolerance}ë¶„
ë¶„ì„ ëª¨ë“œ: ${currentSettings.analysisMode}

=== ê·œì¹™ë³„ ë¶„ì„ ===
ê·œì¹™1 (íšŒê·€ë¶„ì„): ${stats.rule_breakdown?.rule1_regression || 0}ê°œ ìœ íš¨
ê·œì¹™4 (O-ì•„ì„¸í‹¸í™”): ${stats.rule_breakdown?.rule4_oacetylation || 0}ê°œ ìœ íš¨
ê·œì¹™5 (RT í•„í„°ë§): ${stats.rule_breakdown?.rule5_rt_filtering || 0}ê°œ ìœ íš¨

ë¶„ì„ ìƒíƒœ: ${results.status || 'Unknown'}
ëª©í‘œ ë‹¬ì„±ë„: ${results.target_achievement || 'N/A'}

${isAutoReanalysis ? 'âš¡ ì‹¤ì‹œê°„ ëª¨ë“œ: ì„¤ì • ë³€ê²½ì´ ìë™ ë°˜ì˜ë˜ì—ˆìŠµë‹ˆë‹¤.' : ''}`;

            showResult(summary, 'success');
        }
        
        // í–¥ìƒëœ CSV ìƒì„± í•¨ìˆ˜
        function generateEnhancedCSVFromResults(results) {
            let csv = 'Name,RT,Volume,Log P,Anchor,Status,Classification,Predicted_RT,Residual,Std_Residual,Analysis_Settings\n';
            
            const settingsString = `"Outlier:${currentSettings.outlierThreshold}|R2:${currentSettings.r2Threshold}|RT:${currentSettings.rtTolerance}|Mode:${currentSettings.analysisMode}"`;
            
            if (results.valid_compounds) {
                results.valid_compounds.forEach(compound => {
                    const predictedRT = compound.predicted_rt ? compound.predicted_rt.toFixed(3) : 'N/A';
                    const residual = compound.residual ? compound.residual.toFixed(3) : 'N/A';
                    const stdResidual = compound.std_residual ? compound.std_residual.toFixed(3) : 'N/A';
                    
                    csv += `"${compound.Name}",${compound.RT},${compound.Volume},${compound['Log P']},${compound.Anchor},Valid,"True Positive",${predictedRT},${residual},${stdResidual},${settingsString}\n`;
                });
            }
            
            if (results.outliers) {
                results.outliers.forEach(outlier => {
                    const predictedRT = outlier.predicted_rt ? outlier.predicted_rt.toFixed(3) : 'N/A';
                    const residual = outlier.residual ? outlier.residual.toFixed(3) : 'N/A';
                    const stdResidual = outlier.std_residual ? outlier.std_residual.toFixed(3) : 'N/A';
                    const reason = (outlier.outlier_reason || 'Unknown').replace(/"/g, '""');
                    
                    csv += `"${outlier.Name}",${outlier.RT},${outlier.Volume},${outlier['Log P']},${outlier.Anchor},Outlier,"${reason}",${predictedRT},${residual},${stdResidual},${settingsString}\n`;
                });
            }
            
            return csv;
        }
        
        // ì„¤ì • íˆìŠ¤í† ë¦¬ ì—…ë°ì´íŠ¸
        function updateSettingsHistory() {
            const historyContainer = document.getElementById('historyLog');
            if (settingsHistory.length > 0) {
                document.getElementById('settingsHistory').style.display = 'block';
                
                const historyHTML = settingsHistory.slice(-10).reverse().map(entry => 
                    `<div style="padding: 8px; border-left: 3px solid #3498db; margin: 5px 0; background: #f8f9fa;">
                        <strong>${entry.timestamp}</strong>: ${entry.setting} = ${entry.value}
                    </div>`
                ).join('');
                
                historyContainer.innerHTML = historyHTML;
            }
        }
        
        // UI í—¬í¼ í•¨ìˆ˜ë“¤
        function showResult(message, type) {
            const resultDiv = document.getElementById('result');
            resultDiv.className = `result ${type}`;
            resultDiv.textContent = message;
            resultDiv.scrollTop = resultDiv.scrollHeight;
        }
        
        function showLoading(show) {
            document.getElementById('loadingIndicator').style.display = show ? 'block' : 'none';
        }
        
        function updateStatus(message) {
            document.getElementById('statusBar').innerHTML = `<span class="real-time-indicator"></span>${message}`;
        }
        
        // API ì—°ê²° í™•ì¸
        async function checkAPIStatus() {
            try {
                updateStatus('ğŸ”„ API ì—°ê²° í™•ì¸ ì¤‘...');
                const response = await fetch(`${API_BASE}/`);
                const result = await response.json();
                updateStatus(`âœ… ${result.message || 'API ì—°ê²° ì„±ê³µ'} - ì¸í„°ë™í‹°ë¸Œ ëª¨ë“œ`);
                showResult(`âœ… ì¸í„°ë™í‹°ë¸Œ ì‹œìŠ¤í…œ ì¤€ë¹„ ì™„ë£Œ!

ğŸ›ï¸ ìƒˆë¡œìš´ ê¸°ëŠ¥:
- ì‹¤ì‹œê°„ ì„¤ì • ì¡°ì ˆ
- ìë™ ì¬ë¶„ì„
- ìƒì„¸ ë¦¬í¬íŠ¸ ìƒì„±
- ì„¤ì • íˆìŠ¤í† ë¦¬ ì¶”ì 

API ìƒíƒœ: ì •ìƒ
ì„œë²„: ${API_BASE}
ì—°ê²° ì‹œê°„: ${new Date().toLocaleString()}

ì´ì œ ì„¤ì •ì„ ì¡°ì ˆí•˜ë©° ì‹¤ì‹œê°„ìœ¼ë¡œ ë¶„ì„ ê²°ê³¼ë¥¼ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤!`, 'success');
            } catch (error) {
                updateStatus('âŒ API ì—°ê²° ì‹¤íŒ¨');
                showResult(`âŒ API ì—°ê²° ì‹¤íŒ¨

ì˜¤ë¥˜: ${error.message}
ì„œë²„: ${API_BASE}

ì„œë²„ê°€ ì‹¤í–‰ ì¤‘ì¸ì§€ í™•ì¸í•´ì£¼ì„¸ìš”.`, 'error');
            }
        }
        
        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
        window.onload = function() {
            updateStatus('ğŸš€ ì¸í„°ë™í‹°ë¸Œ ì‹œìŠ¤í…œ ì´ˆê¸°í™” ì¤‘...');
            setTimeout(checkAPIStatus, 1000);
        };
        
        // ë“œë˜ê·¸ ì•¤ ë“œë¡­ ê¸°ëŠ¥
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            document.body.addEventListener(eventName, preventDefaults, false);
        });
        
        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }
        
        ['dragenter', 'dragover'].forEach(eventName => {
            document.body.addEventListener(eventName, highlight, false);
        });
        
        ['dragleave', 'drop'].forEach(eventName => {
            document.body.addEventListener(eventName, unhighlight, false);
        });
        
        function highlight(e) {
            document.body.style.backgroundColor = '#f0f8ff';
        }
        
        function unhighlight(e) {
            document.body.style.backgroundColor = '';
        }
        
        document.body.addEventListener('drop', handleDrop, false);
        
        function handleDrop(e) {
            const dt = e.dataTransfer;
            const files = dt.files;
            
            if (files.length > 0) {
                const file = files[0];
                if (file.type === 'text/csv' || file.name.endsWith('.csv')) {
                    document.getElementById('csvFile').files = files;
                    showResult(`ğŸ“„ íŒŒì¼ì´ ë“œë¡­ë˜ì—ˆìŠµë‹ˆë‹¤: ${file.name}`, 'info');
                    
                    // ìë™ ë¶„ì„ ì œì•ˆ
                    setTimeout(() => {
                        if (confirm('íŒŒì¼ì´ ì—…ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤. ë°”ë¡œ ë¶„ì„ì„ ì‹œì‘í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                            analyzeData();
                        }
                    }, 1000);
                } else {
                    showResult('âš ï¸ CSV íŒŒì¼ë§Œ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤.', 'warning');
                }
            }
        }
        
        // í‚¤ë³´ë“œ ë‹¨ì¶•í‚¤
        document.addEventListener('keydown', function(e) {
            if (e.ctrlKey) {
                switch(e.key) {
                    case 'r':
                        e.preventDefault();
                        resetToDefaults();
                        break;
                    case 's':
                        e.preventDefault();
                        exportSettings();
                        break;
                    case 'Enter':
                        e.preventDefault();
                        if (currentAnalysisResults) {
                            createVisualization();
                        } else {
                            testSampleData();
                        }
                        break;
                }
            }
        });
        
        // ê³ ê¸‰ ê¸°ëŠ¥: ì„¤ì • í”„ë¦¬ì…‹
        const presets = {
            'strict': {
                outlierThreshold: 3.5,
                r2Threshold: 0.995,
                rtTolerance: 0.05,
                name: 'ì—„ê²©í•œ ë¶„ì„'
            },
            'balanced': {
                outlierThreshold: 3.0,
                r2Threshold: 0.99,
                rtTolerance: 0.1,
                name: 'ê· í˜• ì¡íŒ ë¶„ì„'
            },
            'lenient': {
                outlierThreshold: 2.0,
                r2Threshold: 0.95,
                rtTolerance: 0.2,
                name: 'ê´€ëŒ€í•œ ë¶„ì„'
            }
        };
        
        function applyPreset(presetName) {
            const preset = presets[presetName];
            if (!preset) return;
            
            document.getElementById('outlierThreshold').value = preset.outlierThreshold;
            document.getElementById('r2Threshold').value = preset.r2Threshold;
            document.getElementById('rtTolerance').value = preset.rtTolerance;
            
            document.getElementById('outlierValue').textContent = preset.outlierThreshold.toFixed(1);
            document.getElementById('r2Value').textContent = preset.r2Threshold.toFixed(3);
            document.getElementById('rtValue').textContent = `Â±${preset.rtTolerance.toFixed(2)}`;
            
            currentSettings.outlierThreshold = preset.outlierThreshold;
            currentSettings.r2Threshold = preset.r2Threshold;
            currentSettings.rtTolerance = preset.rtTolerance;
            
            showResult(`ğŸ“‹ "${preset.name}" í”„ë¦¬ì…‹ì´ ì ìš©ë˜ì—ˆìŠµë‹ˆë‹¤.`, 'success');
            
            if (currentAnalysisResults) {
                reanalyzeWithNewSettings();
            }
        }
        
        // ì´ˆê¸°í™” ì™„ë£Œ ë©”ì‹œì§€
        console.log('ğŸ§¬ Ganglioside Analyzer - Interactive Mode v2.0 ë¡œë“œ ì™„ë£Œ');
        console.log('ğŸ›ï¸ ì¸í„°ë™í‹°ë¸Œ ê¸°ëŠ¥: ì‹¤ì‹œê°„ ì„¤ì • ì¡°ì ˆ, ìë™ ì¬ë¶„ì„, ìƒì„¸ ë¦¬í¬íŠ¸');
        console.log('âŒ¨ï¸ í‚¤ë³´ë“œ ë‹¨ì¶•í‚¤: Ctrl+R(ë¦¬ì…‹), Ctrl+S(ì„¤ì •ì €ì¥), Ctrl+Enter(ë¶„ì„/ì‹œê°í™”)');
    </script>
</body>
</html><!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ§¬ Ganglioside Analyzer - Interactive Mode</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .main-container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }
        
        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }
        
        .container {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 20px;
        }
        
        .section {
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            padding: 25px;
            margin: 20px 0;
            transition: all 0.3s ease;
        }
        
        .section:hover {
            border-color: #3498db;
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.1);
        }
        
        .section h3 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 1.3rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .section p {
            color: #6c757d;
            margin-bottom: 15px;
            line-height: 1.6;
        }
        
        /* ìƒˆë¡œìš´ ìŠ¤íƒ€ì¼: ìƒí˜¸ì‘ìš© ì»¨íŠ¸ë¡¤ë“¤ */
        .control-panel {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            border: none;
            padding: 25px;
            border-radius: 15px;
            margin: 20px 0;
            box-shadow: 0 8px 25px rgba(240, 147, 251, 0.3);
        }
        
        .control-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .control-item {
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 12px;
            backdrop-filter: blur(10px);
        }
        
        .control-item label {
            display: block;
            font-weight: bold;
            margin-bottom: 10px;
            font-size: 1.1em;
        }
        
        .slider-container {
            position: relative;
            margin: 15px 0;
        }
        
        .slider {
            width: 100%;
            height: 8px;
            border-radius: 5px;
            background: rgba(255, 255, 255, 0.3);
            outline: none;
            opacity: 0.7;
            transition: opacity 0.2s;
        }
        
        .slider:hover {
            opacity: 1;
        }
        
        .slider::-webkit-slider-thumb {
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #ffffff;
            cursor: pointer;
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
        }
        
        .slider::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #ffffff;
            cursor: pointer;
            border: none;
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
        }
        
        .value-display {
            background: rgba(255, 255, 255, 0.2);
            padding: 8px 12px;
            border-radius: 8px;
            font-weight: bold;
            text-align: center;
            margin-top: 10px;
            font-family: 'Courier New', monospace;
        }
        
        .mode-selector {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        
        .mode-option {
            flex: 1;
            padding: 12px;
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 8px;
            color: white;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s ease;
            font-weight: bold;
        }
        
        .mode-option:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        
        .mode-option.active {
            background: rgba(255, 255, 255, 0.9);
            color: #333;
            border-color: white;
        }
        
        .file-input {
            width: 100%;
            padding: 12px;
            border: 2px dashed #3498db;
            border-radius: 8px;
            background: white;
            margin: 15px 0;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .file-input:hover {
            border-color: #2980b9;
            background-color: #f8f9fa;
        }
        
        .btn {
            background: linear-gradient(45deg, #3498db, #2980b9);
            color: white;
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            margin: 5px;
            transition: all 0.3s ease;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }
        
        .btn:active {
            transform: translateY(0);
        }
        
        .btn-success {
            background: linear-gradient(45deg, #27ae60, #2ecc71);
        }
        
        .btn-warning {
            background: linear-gradient(45deg, #f39c12, #e67e22);
        }
        
        .btn-danger {
            background: linear-gradient(45deg, #e74c3c, #c0392b);
        }
        
        .btn-primary {
            background: linear-gradient(45deg, #8e44ad, #9b59b6);
        }
        
        .button-group {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
            margin-top: 15px;
        }
        
        .result {
            margin-top: 20px;
            padding: 20px;
            border-radius: 8px;
            white-space: pre-wrap;
            font-family: 'Courier New', monospace;
            max-height: 400px;
            overflow-y: auto;
            border-left: 4px solid;
        }
        
        .success {
            background-color: #d4edda;
            color: #155724;
            border-left-color: #28a745;
        }
        
        .error {
            background-color: #f8d7da;
            color: #721c24;
            border-left-color: #dc3545;
        }
        
        .info {
            background-color: #d1ecf1;
            color: #0c5460;
            border-left-color: #17a2b8;
        }
        
        .warning {
            background-color: #fff3cd;
            color: #856404;
            border-left-color: #ffc107;
        }
        
        .status-bar {
            background: #34495e;
            color: white;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
            font-weight: bold;
        }
        
        .feature-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }
        
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .analysis-settings {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px;
            padding: 25px;
            margin: 20px 0;
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
        }
        
        .real-time-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            background: #2ecc71;
            border-radius: 50%;
            margin-right: 8px;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        .parameter-info {
            font-size: 0.9em;
            opacity: 0.8;
            margin-top: 5px;
        }
        
        @media (max-width: 768px) {
            .main-container {
                padding: 10px;
            }
            
            .container {
                padding: 20px;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .control-grid {
                grid-template-columns: 1fr;
            }
            
            .button-group {
                flex-direction: column;
            }
            
            .btn {
                width: 100%;
                margin: 5px 0;
            }
        }
    </style>
</head>
<body>
    <div class="main-container">
        <div class="header">
            <h1>ğŸ§¬ Ganglioside Analyzer</h1>
            <p>ì‚°ì„± ë‹¹ì§€ì§ˆ LC-MS/MS ë°ì´í„° ìë™ ë¶„ì„ ì‹œìŠ¤í…œ - ì¸í„°ë™í‹°ë¸Œ ëª¨ë“œ</p>
        </div>
        
        <div class="status-bar" id="statusBar">
            <span class="real-time-indicator"></span>
            ğŸ”„ ì‹œìŠ¤í…œ ì´ˆê¸°í™” ì¤‘...
        </div>
        
        <!-- ìƒˆë¡œìš´ ê¸°ëŠ¥: ë¶„ì„ ì„¤ì • íŒ¨ë„ -->
        <div class="control-panel">
            <h3 style="margin-top: 0; text-align: center; font-size: 1.8em;">âš™ï¸ ì‹¤ì‹œê°„ ë¶„ì„ ì„¤ì •</h3>
            <p style="text-align: center; opacity: 0.9; margin-bottom: 20px;">ì„¤ì •ì„ ë³€ê²½í•˜ë©´ ì¦‰ì‹œ ì¬ë¶„ì„ì´ ìˆ˜í–‰ë©ë‹ˆë‹¤</p>
            
            <div class="control-grid">
                <div class="control-item">
                    <label for="outlierThreshold">ğŸ“Š í‘œì¤€í™” ì”ì°¨ ì„ê³„ê°’</label>
                    <div class="slider-container">
                        <input type="range" id="outlierThreshold" class="slider" min="1.0" max="5.0" step="0.1" value="3.0">
                        <div class="value-display" id="outlierValue">3.0</div>
                    </div>
                    <div class="parameter-info">ì´ìƒì¹˜ íŒë³„ ê¸°ì¤€ (ë†’ì„ìˆ˜ë¡ ì—„ê²©)</div>
                </div>
                
                <div class="control-item">
                    <label for="r2Threshold">ğŸ“ˆ ê²°ì •ê³„ìˆ˜ (RÂ²) ì„ê³„ê°’</label>
                    <div class="slider-container">
                        <input type="range" id="r2Threshold" class="slider" min="0.90" max="0.999" step="0.001" value="0.99">
                        <div class="value-display" id="r2Value">0.990</div>
                    </div>
                    <div class="parameter-info">íšŒê·€ë¶„ì„ í’ˆì§ˆ ê¸°ì¤€ (ë†’ì„ìˆ˜ë¡ ì—„ê²©)</div>
                </div>
                
                <div class="control-item">
                    <label for="rtTolerance">â±ï¸ RT í—ˆìš© ë²”ìœ„ (ë¶„)</label>
                    <div class="slider-container">
                        <input type="range" id="rtTolerance" class="slider" min="0.05" max="0.5" step="0.01" value="0.1">
                        <div class="value-display" id="rtValue">Â±0.10</div>
                    </div>
                    <div class="parameter-info">ë™ì¼ ì ‘ë¯¸ì‚¬ ê·¸ë£¹ ë‚´ RT í—ˆìš© ì˜¤ì°¨</div>
                </div>
                
                <div class="control-item">
                    <label>ğŸ”¬ ë¶„ì„ ëª¨ë“œ</label>
                    <div class="mode-selector">
                        <div class="mode-option active" data-mode="Porcine" onclick="selectMode('Porcine')">
                            ğŸ· Porcine
                        </div>
                        <div class="mode-option" data-mode="Mouse" onclick="selectMode('Mouse')">
                            ğŸ­ Mouse
                        </div>
                    </div>
                    <div class="parameter-info">ë°ì´í„° ì¢…ë¥˜ì— ë”°ë¥¸ ë¶„ì„ ê·œì¹™ ì ìš©</div>
                </div>
            </div>
            
            <div style="text-align: center; margin-top: 25px;">
                <button class="btn btn-primary" onclick="resetToDefaults()">
                    ğŸ”„ ê¸°ë³¸ê°’ ë³µì›
                </button>
                <button class="btn btn-warning" onclick="exportSettings()">
                    ğŸ’¾ ì„¤ì • ë‚´ë³´ë‚´ê¸°
                </button>
                <button class="btn btn-success" onclick="applyAdvancedRules()">
                    ğŸš€ ê³ ê¸‰ ê·œì¹™ ì ìš©
                </button>
            </div>
        </div>
        
        <div class="container">
            <div class="feature-grid">
                <!-- íŒŒì¼ ì—…ë¡œë“œ ì„¹ì…˜ -->
                <div class="section">
                    <h3>ğŸ“„ CSV íŒŒì¼ ì—…ë¡œë“œ</h3>
                    <p><strong>í•„ìˆ˜ ì»¬ëŸ¼:</strong> Name, RT, Volume, Log P, Anchor</p>
                    <input type="file" id="csvFile" accept=".csv" class="file-input">
                    <div class="button-group">
                        <button class="btn" onclick="uploadFile()">ğŸ“¤ íŒŒì¼ ì—…ë¡œë“œ</button>
                        <button class="btn btn-success" onclick="analyzeData()">ğŸ”¬ ë°ì´í„° ë¶„ì„</button>
                    </div>
                </div>
                
                <!-- ì‹œê°í™” ì„¹ì…˜ -->
                <div class="section">
                    <h3>ğŸ“Š ì‹œê°í™” ë° ê²°ê³¼</h3>
                    <p>ë¶„ì„ ê²°ê³¼ë¥¼ ì‹œê°ì ìœ¼ë¡œ í™•ì¸í•˜ê³  ë‹¤ìš´ë¡œë“œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
                    <div class="button-group">
                        <button class="btn btn-warning" onclick="createVisualization()">ğŸ“ˆ ì‹œê°í™” ìƒì„±</button>
                        <button class="btn btn-success" onclick="downloadResults()">ğŸ’¾ ê²°ê³¼ ë‹¤ìš´ë¡œë“œ</button>
                        <button class="btn btn-primary" onclick="generateReport()">ğŸ“‹ ìƒì„¸ ë¦¬í¬íŠ¸</button>
                    </div>
                </div>
            </div>
            
            <!-- ìƒ˜í”Œ ë°ì´í„° í…ŒìŠ¤íŠ¸ -->
            <div class="section">
                <h3>ğŸ§ª ìƒ˜í”Œ ë°ì´í„° í…ŒìŠ¤íŠ¸</h3>
                <p>ë¯¸ë¦¬ ì¤€ë¹„ëœ ìƒ˜í”Œ ë°ì´í„°ë¡œ ì‹œìŠ¤í…œì„ í…ŒìŠ¤íŠ¸í•´ë³´ì„¸ìš”.</p>
                <div class="button-group">
                    <button class="btn btn-success" onclick="testSampleData()">ğŸš€ ìƒ˜í”Œ ë°ì´í„° í…ŒìŠ¤íŠ¸</button>
                    <button class="btn btn-warning" onclick="testComplexSample()">ğŸ§¬ ë³µí•© ìƒ˜í”Œ í…ŒìŠ¤íŠ¸</button>
                    <button class="btn btn-danger" onclick="testChallengeData()">ğŸ’€ ë„ì „ ë°ì´í„° í…ŒìŠ¤íŠ¸</button>
                </div>
            </div>
        </div>
        
        <!-- ë¡œë”© ì¸ë””ì¼€ì´í„° -->
        <div class="loading" id="loadingIndicator">
            <div class="spinner"></div>
            <p>ì‹¤ì‹œê°„ ë¶„ì„ ì¤‘...</p>
        </div>
        
        <!-- ê²°ê³¼ í‘œì‹œ ì˜ì—­ -->
        <div class="container">
            <div id="result"></div>
        </div>
        
        <!-- ì‹œê°í™” í‘œì‹œ ì˜ì—­ -->
        <div class="container" style="display: none;" id="visualizationContainer">
            <h3>ğŸ“Š ë¶„ì„ ê²°ê³¼ ì‹œê°í™”</h3>
            <div id="visualizations"></div>
        </div>
        
        <!-- ì„¤ì • ë³€ê²½ íˆìŠ¤í† ë¦¬ -->
        <div class="container" style="display: none;" id="settingsHistory">
            <h3>ğŸ“ˆ ì„¤ì • ë³€ê²½ íˆìŠ¤í† ë¦¬</h3>
            <div id="historyLog"></div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8000';
        let currentAnalysisResults = null;
        let currentSettings = {
            outlierThreshold: 3.0,
            r2Threshold: 0.99,
            rtTolerance: 0.1,
            analysisMode: 'Porcine'
        };
        let isRealTimeMode = false;
        let settingsHistory = [];
        
        // ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', function() {
            initializeSliders();
            updateStatus('ğŸš€ ì‹œìŠ¤í…œ ì´ˆê¸°í™” ì¤‘...');
            setTimeout(checkAPIStatus, 1000);
        });
        
        // ìŠ¬ë¼ì´ë” ì´ˆê¸°í™” ë° ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        function initializeSliders() {
            const outlierSlider = document.getElementById('outlierThreshold');
            const r2Slider = document.getElementById('r2Threshold');
            const rtSlider = document.getElementById('rtTolerance');
            
            outlierSlider.addEventListener('input', function() {
                const value = parseFloat(this.value);
                document.getElementById('outlierValue').textContent = value.toFixed(1);
                currentSettings.outlierThreshold = value;
                onSettingChange('outlierThreshold', value);
            });
            
            r2Slider.addEventListener('input', function() {
                const value = parseFloat(this.value);
                document.getElementById('r2Value').textContent = value.toFixed(3);
                currentSettings.r2Threshold = value;
                onSettingChange('r2Threshold', value);
            });
            
            rtSlider.addEventListener('input', function() {
                const value = parseFloat(this.value);
                document.getElementById('rtValue').textContent = `Â±${value.toFixed(2)}`;
                currentSettings.rtTolerance = value;
                onSettingChange('rtTolerance', value);
            });
        }
        
        // ì„¤ì • ë³€ê²½ ì‹œ í˜¸ì¶œ
        function onSettingChange(setting, value) {
            // íˆìŠ¤í† ë¦¬ ì¶”ê°€
            settingsHistory.push({
                timestamp: new Date().toLocaleTimeString(),
                setting: setting,
                value: value
            });
            
            // ì‹¤ì‹œê°„ ëª¨ë“œì¼ ë•Œ ìë™ ì¬ë¶„ì„
            if (isRealTimeMode && currentAnalysisResults) {
                showResult(`âš¡ ì„¤ì • ë³€ê²½ ê°ì§€: ${setting} = ${value}\\nì‹¤ì‹œê°„ ì¬ë¶„ì„ ì¤‘...`, 'info');
                debounceAnalysis();
            }
            
            // ì„¤ì • íˆìŠ¤í† ë¦¬ ì—…ë°ì´íŠ¸
            updateSettingsHistory();
        }
        
        // ë””ë°”ìš´ìŠ¤ëœ ë¶„ì„ (ì—°ì†ëœ ì„¤ì • ë³€ê²½ ì‹œ ë§ˆì§€ë§‰ ë³€ê²½ í›„ 1ì´ˆ ë’¤ ë¶„ì„)
        let analysisTimeout;
        function debounceAnalysis() {
            clearTimeout(analysisTimeout);
            analysisTimeout = setTimeout(() => {
                if (currentAnalysisResults) {
                    reanalyzeWithNewSettings();
                }
            }, 1000);
        }
        
        // ìƒˆë¡œìš´ ì„¤ì •ìœ¼ë¡œ ì¬ë¶„ì„
        async function reanalyzeWithNewSettings() {
            try {
                showLoading(true);
                updateStatus('ğŸ”„ ì„¤ì • ì ìš© ì¤‘...');
                
                // í˜„ì¬ íŒŒì¼ë¡œ ì¬ë¶„ì„ ìš”ì²­
                const fileInput = document.getElementById('csvFile');
                if (fileInput.files[0]) {
                    await analyzeData(true); // ìë™ ì¬ë¶„ì„ í”Œë˜ê·¸
                } else {
                    // ìƒ˜í”Œ ë°ì´í„°ë¡œ ì¬ë¶„ì„
                    await testSampleData(true);
                }
                
                updateStatus('âœ… ì‹¤ì‹œê°„ ë¶„ì„ ì™„ë£Œ');
            } catch (error) {
                showResult(`âŒ ì‹¤ì‹œê°„ ë¶„ì„ ì˜¤ë¥˜: ${error.message}`, 'error');
                updateStatus('âŒ ì‹¤ì‹œê°„ ë¶„ì„ ì‹¤íŒ¨');
            } finally {
                showLoading(false);
            }
        }
        
        // ë¶„ì„ ëª¨ë“œ ì„ íƒ
        function selectMode(mode) {
            // UI ì—…ë°ì´íŠ¸
            document.querySelectorAll('.mode-option').forEach(option => {
                option.classList.remove('active');
            });
            document.querySelector(`[data-mode="${mode}"]`).classList.add('active');
            
            // ì„¤ì • ì—…ë°ì´íŠ¸
            currentSettings.analysisMode = mode;
            onSettingChange('analysisMode', mode);
        }
        
        // ê¸°ë³¸ê°’ ë³µì›
        function resetToDefaults() {
            document.getElementById('outlierThreshold').value = 3.0;
            document.getElementById('r2Threshold').value = 0.99;
            document.getElementById('rtTolerance').value = 0.1;
            
            document.getElementById('outlierValue').textContent = '3.0';
            document.getElementById('r2Value').textContent = '0.990';
            document.getElementById('rtValue').textContent = 'Â±0.10';
            
            selectMode('Porcine');
            
            currentSettings = {
                outlierThreshold: 3.0,
                r2Threshold: 0.99,
                rtTolerance: 0.1,
                analysisMode: 'Porcine'
            };
            
            showResult('ğŸ”„ ëª¨ë“  ì„¤ì •ì´ ê¸°ë³¸ê°’ìœ¼ë¡œ ë³µì›ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
            
            if (currentAnalysisResults) {
                reanalyzeWithNewSettings();
            }
        }
        
        // ì„¤ì • ë‚´ë³´ë‚´ê¸°
        function exportSettings() {
            const settingsData = {
                settings: currentSettings,
                timestamp: new Date().toISOString(),
                history: settingsHistory
            };
            
            const dataStr = JSON.stringify(settingsData, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `ganglioside_settings_${new Date().toISOString().slice(0,19).replace(/:/g, '-')}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
            
            showResult('ğŸ’¾ ì„¤ì •ì´ ì„±ê³µì ìœ¼ë¡œ ë‚´ë³´ë‚´ì¡ŒìŠµë‹ˆë‹¤!', 'success');
        }
        
        // ê³ ê¸‰ ê·œì¹™ ì ìš©
        function applyAdvancedRules() {
            showResult(`ğŸš€ ê³ ê¸‰ ê·œì¹™ ëª¨ë“œ í™œì„±í™”!

âœ… í™œì„±í™”ëœ ê³ ê¸‰ ê¸°ëŠ¥:
- GD1+dHex â†’ GD1b ìë™ ë¶„ë¥˜
- GQ1 ì´ì„±ì§ˆì²´ RT ê¸°ë°˜ êµ¬ë¶„
- O-acetylation íš¨ê³¼ ì •ë°€ ê²€ì¦
- In-source fragmentation íƒì§€
- Volume í†µí•© ìµœì í™”

í˜„ì¬ ì„¤ì •ìœ¼ë¡œ ê³ ê¸‰ ë¶„ì„ì„ ìˆ˜í–‰í•©ë‹ˆë‹¤.`, 'info');
            
            if (currentAnalysisResults) {
                reanalyzeWithNewSettings();
            }
        }
        
        // íŒŒì¼ ì—…ë¡œë“œ í•¨ìˆ˜
        async function uploadFile() {
            const fileInput = document.getElementById('csvFile');
            const file = fileInput.files[0];
            
            if (!file) {
                showResult('âš ï¸ íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.', 'warning');
                return;
            }
            
            const formData = new FormData();
            formData.append('file', file);
            
            try {
                showLoading(true);
                updateStatus('ğŸ“¤ íŒŒì¼ ì—…ë¡œë“œ ì¤‘...');
                
                const response = await fetch(`${API_BASE}/api/upload`, {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    showResult(`âœ… ì—…ë¡œë“œ ì„±ê³µ!\\níŒŒì¼ëª…: ${file.name}\\ní¬ê¸°: ${(file.size/1024).toFixed(1)} KB\\n\\n${JSON.stringify(result, null, 2)}`, 'success');
                    updateStatus('âœ… íŒŒì¼ ì—…ë¡œë“œ ì™„ë£Œ');
                    
                    // ì‹¤ì‹œê°„ ëª¨ë“œ í™œì„±í™” ì œì•ˆ
                    if (!isRealTimeMode) {
                        setTimeout(() => {
                            if (confirm('ì‹¤ì‹œê°„ ë¶„ì„ ëª¨ë“œë¥¼ í™œì„±í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\\nì„¤ì • ë³€ê²½ ì‹œ ìë™ìœ¼ë¡œ ì¬ë¶„ì„ì´ ìˆ˜í–‰ë©ë‹ˆë‹¤.')) {
                                isRealTimeMode = true;
                                updateStatus('âš¡ ì‹¤ì‹œê°„ ëª¨ë“œ í™œì„±í™”');
                            }
                        }, 2000);
                    }
                } else {
                    showResult(`âŒ ì—…ë¡œë“œ ì‹¤íŒ¨: ${result.detail || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'}`, 'error');
                    updateStatus('âŒ íŒŒì¼ ì—…ë¡œë“œ ì‹¤íŒ¨');
                }
            } catch (error) {
                showResult(`âŒ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜: ${error.message}`, 'error');
                updateStatus('âŒ ì—°ê²° ì˜¤ë¥˜');
            } finally {
                showLoading(false);
            }
        }
        
        // ë°ì´í„° ë¶„ì„ í•¨ìˆ˜ (í–¥ìƒëœ ë²„ì „)
        async function analyzeData(isAutoReanalysis = false) {
            const fileInput = document.getElementById('csvFile');
            const file = fileInput.files[0];
            
            if (!file && !isAutoReanalysis) {
                showResult('âš ï¸ ë¶„ì„í•  íŒŒì¼ì„ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”.', 'warning');
                return;
            }
            
            if (!file && isAutoReanalysis) {
                // ìë™ ì¬ë¶„ì„ì¸ë° íŒŒì¼ì´ ì—†ìœ¼ë©´ ìƒ˜í”Œ ë°ì´í„° ì‚¬ìš©
                return