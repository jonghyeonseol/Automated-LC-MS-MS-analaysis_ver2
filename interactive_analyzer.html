            if (!file && isAutoReanalysis) {
                // 자동 재분석인데 파일이 없으면 샘플 데이터 사용
                return await testSampleData(true);
            }
            
            const formData = new FormData();
            formData.append('file', file);
            formData.append('data_type', currentSettings.analysisMode);
            formData.append('outlier_threshold', currentSettings.outlierThreshold.toString());
            formData.append('r2_threshold', currentSettings.r2Threshold.toString());
            formData.append('rt_tolerance', currentSettings.rtTolerance.toString());
            
            try {
                showLoading(true);
                updateStatus(isAutoReanalysis ? '🔄 실시간 재분석 중...' : '🔬 데이터 분석 중...');
                
                const response = await fetch(`${API_BASE}/api/analyze`, {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    currentAnalysisResults = result.results;
                    displayAnalysisResults(result.results, isAutoReanalysis);
                    updateStatus(isAutoReanalysis ? '✅ 실시간 재분석 완료' : '✅ 데이터 분석 완료');
                } else {
                    showResult(`❌ 분석 실패: ${result.detail || '알 수 없는 오류'}`, 'error');
                    updateStatus('❌ 분석 실패');
                }
            } catch (error) {
                showResult(`❌ 분석 오류: ${error.message}`, 'error');
                updateStatus('❌ 분석 오류');
            } finally {
                showLoading(false);
            }
        }
        
        // 시각화 생성 함수 (향상된 버전)
        async function createVisualization() {
            if (!currentAnalysisResults) {
                showResult('⚠️ 먼저 데이터 분석을 수행해주세요.', 'warning');
                return;
            }
            
            try {
                showLoading(true);
                updateStatus('📊 고급 시각화 생성 중...');
                
                // 시각화 컨테이너 표시
                document.getElementById('visualizationContainer').style.display = 'block';
                
                // 상세한 시각화 HTML 생성
                const results = currentAnalysisResults.results || currentAnalysisResults;
                const stats = results.statistics;
                const validCount = stats.valid_compounds || 0;
                const outlierCount = stats.outliers || 0;
                const totalCount = stats.total_compounds || 0;
                const successRate = stats.success_rate || 0;
                const anchorCount = stats.anchor_compounds || 0;
                
                // 현재 설정 정보
                const settingsInfo = `
                    <div style="background: rgba(52, 73, 94, 0.1); padding: 15px; border-radius: 8px; margin: 10px 0;">
                        <h5 style="margin-top: 0;">🎛️ 현재 분석 설정</h5>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; font-size: 0.9em;">
                            <div><strong>표준화 잔차 임계값:</strong> ${currentSettings.outlierThreshold}</div>
                            <div><strong>R² 임계값:</strong> ${currentSettings.r2Threshold}</div>
                            <div><strong>RT 허용 범위:</strong> ±${currentSettings.rtTolerance}분</div>
                            <div><strong>분석 모드:</strong> ${currentSettings.analysisMode}</div>
                        </div>
                    </div>
                `;
                
                // 설정 영향 분석
                const settingsImpact = `
                    <div style="background: linear-gradient(135deg, #3498db, #2980b9); color: white; padding: 20px; border-radius: 12px; margin: 15px 0;">
                        <h4 style="margin-top: 0; text-align: center;">📈 설정 영향 분석</h4>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px;">
                            <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 8px; text-align: center;">
                                <h3>${(currentSettings.outlierThreshold >= 3.0 ? '엄격' : currentSettings.outlierThreshold >= 2.0 ? '보통' : '관대')}</h3>
                                <p>이상치 판별</p>
                            </div>
                            <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 8px; text-align: center;">
                                <h3>${(currentSettings.r2Threshold >= 0.99 ? '매우 높음' : currentSettings.r2Threshold >= 0.95 ? '높음' : '보통')}</h3>
                                <p>회귀 품질 요구</p>
                            </div>
                            <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 8px; text-align: center;">
                                <h3>${(currentSettings.rtTolerance <= 0.1 ? '정밀' : currentSettings.rtTolerance <= 0.2 ? '보통' : '관대')}</h3>
                                <p>RT 허용도</p>
                            </div>
                        </div>
                    </div>
                `;
                
                // 메인 대시보드
                const mainDashboard = `
                    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 25px; border-radius: 15px; margin: 15px 0; color: white;">
                        <h3 style="margin-top: 0; text-align: center;">🏆 Ganglioside 분석 대시보드</h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; margin: 25px 0;">
                            <div style="background: rgba(255,255,255,0.15); padding: 20px; border-radius: 12px; text-align: center;">
                                <h2 style="margin: 0; font-size: 2.5em;">${totalCount}</h2>
                                <p style="margin: 8px 0;">총 화합물</p>
                            </div>
                            <div style="background: rgba(46, 204, 113, 0.2); padding: 20px; border-radius: 12px; text-align: center;">
                                <h2 style="margin: 0; font-size: 2.5em; color: #2ecc71;">${validCount}</h2>
                                <p style="margin: 8px 0;">유효 화합물</p>
                            </div>
                            <div style="background: rgba(231, 76, 60, 0.2); padding: 20px; border-radius: 12px; text-align: center;">
                                <h2 style="margin: 0; font-size: 2.5em; color: #e74c3c;">${outlierCount}</h2>
                                <p style="margin: 8px 0;">이상치</p>
                            </div>
                            <div style="background: rgba(243, 156, 18, 0.2); padding: 20px; border-radius: 12px; text-align: center;">
                                <h2 style="margin: 0; font-size: 2.5em; color: #f39c12;">${successRate.toFixed(1)}%</h2>
                                <p style="margin: 8px 0;">성공률</p>
                            </div>
                        </div>
                        <div style="text-align: center; margin-top: 20px;">
                            <p style="font-size: 1.2em;">🎯 분석 상태: ${results.status || 'Interactive Analysis'}</p>
                            <p style="font-size: 1.1em;">📊 목표 달성: ${results.target_achievement || 'N/A'}</p>
                        </div>
                    </div>
                `;
                
                // 실시간 분석 정보
                const realTimeInfo = isRealTimeMode ? `
                    <div style="background: linear-gradient(45deg, #27ae60, #2ecc71); color: white; padding: 20px; border-radius: 12px; margin: 15px 0; text-align: center;">
                        <h4 style="margin-top: 0;">⚡ 실시간 분석 모드 활성화</h4>
                        <p style="margin: 10px 0;">설정 변경 시 자동으로 재분석이 수행됩니다</p>
                        <p style="font-size: 0.9em; opacity: 0.8;">마지막 분석: ${new Date().toLocaleTimeString()}</p>
                    </div>
                ` : `
                    <div style="background: linear-gradient(45deg, #f39c12, #e67e22); color: white; padding: 15px; border-radius: 8px; margin: 15px 0; text-align: center;">
                        <p style="margin: 0;">💡 실시간 모드를 활성화하면 설정 변경 시 자동 재분석됩니다</p>
                        <button onclick="isRealTimeMode = true; updateStatus('⚡ 실시간 모드 활성화');" style="background: rgba(255,255,255,0.2); border: none; color: white; padding: 8px 16px; border-radius: 4px; margin-top: 8px; cursor: pointer;">
                            🚀 실시간 모드 활성화
                        </button>
                    </div>
                `;
                
                const visualizationHtml = settingsInfo + settingsImpact + mainDashboard + realTimeInfo;
                
                document.getElementById('visualizations').innerHTML = visualizationHtml;
                
                showResult('📊 인터랙티브 시각화가 성공적으로 생성되었습니다!\\n\\n✨ 새로운 기능:\\n- 현재 설정 표시\\n- 설정 영향 분석\\n- 실시간 분석 모드\\n- 상세 대시보드', 'success');
                updateStatus('✅ 시각화 완료');
                
                // 시각화 영역으로 스크롤
                document.getElementById('visualizationContainer').scrollIntoView({ behavior: 'smooth' });
                
            } catch (error) {
                showResult(`❌ 시각화 오류: ${error.message}`, 'error');
                updateStatus('❌ 시각화 실패');
            } finally {
                showLoading(false);
            }
        }
        
        // 샘플 데이터 테스트 (향상된 버전)
        async function testSampleData(isAutoReanalysis = false) {
            try {
                showLoading(true);
                updateStatus(isAutoReanalysis ? '🔄 샘플 데이터 재분석 중...' : '🧪 샘플 데이터 테스트 중...');
                
                const sampleCSV = `Name,RT,Volume,Log P,Anchor
GD1a(36:1;O2),9.572,1000000,1.53,T
GM1a(36:1;O2),10.452,500000,4.00,F
GM3(36:1;O2),10.606,2000000,7.74,F
GD3(36:1;O2),10.126,800000,5.27,T
GT1b(36:1;O2),8.701,1200000,-0.94,T
GQ1c(36:1;O2),8.101,600000,-3.41,T
GP1(36:1;O2),7.851,300000,-5.88,F
GD1b(34:1;O2),9.123,750000,2.15,F
GM2(d18:1/16:0),11.234,450000,5.82,F
GT3(d18:1/18:0),8.967,920000,0.35,T`;
                
                const blob = new Blob([sampleCSV], { type: 'text/csv' });
                const formData = new FormData();
                formData.append('file', blob, 'enhanced_sample_data.csv');
                formData.append('data_type', currentSettings.analysisMode);
                formData.append('outlier_threshold', currentSettings.outlierThreshold.toString());
                formData.append('r2_threshold', currentSettings.r2Threshold.toString());
                formData.append('rt_tolerance', currentSettings.rtTolerance.toString());
                
                const response = await fetch(`${API_BASE}/api/analyze`, {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    currentAnalysisResults = result.results;
                    displayAnalysisResults(result.results, isAutoReanalysis);
                    updateStatus(isAutoReanalysis ? '✅ 실시간 재분석 완료' : '✅ 샘플 데이터 테스트 완료');
                    
                    // 실시간 모드 제안 (첫 번째 테스트일 때만)
                    if (!isAutoReanalysis && !isRealTimeMode) {
                        setTimeout(() => {
                            showResult('💡 팁: 실시간 모드를 활성화하면 설정 변경 시 자동으로 재분석됩니다!', 'info');
                        }, 3000);
                    }
                } else {
                    showResult(`❌ 샘플 테스트 실패: ${result.detail || '알 수 없는 오류'}`, 'error');
                    updateStatus('❌ 샘플 테스트 실패');
                }
            } catch (error) {
                showResult(`❌ 샘플 테스트 오류: ${error.message}`, 'error');
                updateStatus('❌ 샘플 테스트 오류');
            } finally {
                showLoading(false);
            }
        }
        
        // 복합 샘플 테스트
        async function testComplexSample() {
            showResult('🧬 복합 샘플 데이터 준비 중...\\n\\n이 테스트는 다음을 포함합니다:\\n- 다양한 이성질체\\n- O-acetylation 화합물\\n- In-source fragmentation 후보\\n- 다양한 접두사/접미사 조합', 'info');
            
            setTimeout(async () => {
                try {
                    showLoading(true);
                    updateStatus('🧬 복합 샘플 분석 중...');
                    
                    const complexCSV = `Name,RT,Volume,Log P,Anchor
GD1a(36:1;O2),9.572,1000000,1.53,T
GD1b(36:1;O2),9.823,850000,1.48,F
GD1a+OAc(36:1;O2),10.125,650000,2.15,F
GM1a(34:1;O2),10.452,500000,4.00,F
GM1a+2OAc(34:1;O2),11.234,320000,4.85,F
GM3(36:1;O2),10.606,2000000,7.74,F
GM3(34:1;O2),10.598,1800000,7.69,F
GD3(36:1;O2),10.126,800000,5.27,T
GT1b(36:1;O2),8.701,1200000,-0.94,T
GT1c(36:1;O2),8.945,950000,-0.89,F
GQ1b(36:1;O2),8.101,600000,-3.41,T
GQ1c(36:1;O2),8.234,580000,-3.36,F
GP1(36:1;O2),7.851,300000,-5.88,F
GD1+dHex(36:1;O2),9.823,750000,1.48,F
GD1+HexNAc(36:1;O2),9.572,690000,1.53,F`;
                    
                    const blob = new Blob([complexCSV], { type: 'text/csv' });
                    const formData = new FormData();
                    formData.append('file', blob, 'complex_sample_data.csv');
                    formData.append('data_type', currentSettings.analysisMode);
                    formData.append('outlier_threshold', currentSettings.outlierThreshold.toString());
                    formData.append('r2_threshold', currentSettings.r2Threshold.toString());
                    formData.append('rt_tolerance', currentSettings.rtTolerance.toString());
                    
                    const response = await fetch(`${API_BASE}/api/analyze`, {
                        method: 'POST',
                        body: formData
                    });
                    
                    const result = await response.json();
                    
                    if (response.ok) {
                        currentAnalysisResults = result.results;
                        displayAnalysisResults(result.results);
                        updateStatus('✅ 복합 샘플 분석 완료');
                        
                        showResult('🧬 복합 샘플 분석 완료!\\n\\n이 테스트에서는 다음을 확인할 수 있습니다:\\n- 이성질체 자동 분류\\n- O-acetylation 효과 검증\\n- 복잡한 구조 분석\\n\\n설정을 변경하여 결과 변화를 관찰해보세요!', 'success');
                    } else {
                        showResult(`❌ 복합 샘플 분석 실패: ${result.detail || '알 수 없는 오류'}`, 'error');
                        updateStatus('❌ 복합 샘플 분석 실패');
                    }
                } catch (error) {
                    showResult(`❌ 복합 샘플 분석 오류: ${error.message}`, 'error');
                    updateStatus('❌ 복합 샘플 분석 오류');
                } finally {
                    showLoading(false);
                }
            }, 2000);
        }
        
        // 도전 데이터 테스트
        async function testChallengeData() {
            if (!confirm('⚠️ 도전 데이터는 분석하기 어려운 데이터를 포함합니다.\\n낮은 성공률이 예상되며, 설정 조정이 필요할 수 있습니다.\\n\\n계속하시겠습니까?')) {
                return;
            }
            
            showResult('💀 도전 데이터 테스트 시작!\\n\\n이 데이터셋은 다음 문제를 포함합니다:\\n- 낮은 R² 값\\n- 큰 RT 편차\\n- 복잡한 이상치 패턴\\n- 불완전한 anchor 데이터', 'warning');
            
            // 설정을 더 관대하게 변경 제안
            setTimeout(() => {
                if (confirm('💡 도전 데이터를 위해 설정을 더 관대하게 변경하시겠습니까?\\n- 표준화 잔차 임계값: 2.0\\n- R² 임계값: 0.95\\n- RT 허용 범위: 0.2분')) {
                    document.getElementById('outlierThreshold').value = 2.0;
                    document.getElementById('r2Threshold').value = 0.95;
                    document.getElementById('rtTolerance').value = 0.2;
                    
                    document.getElementById('outlierValue').textContent = '2.0';
                    document.getElementById('r2Value').textContent = '0.950';
                    document.getElementById('rtValue').textContent = '±0.20';
                    
                    currentSettings.outlierThreshold = 2.0;
                    currentSettings.r2Threshold = 0.95;
                    currentSettings.rtTolerance = 0.2;
                }
                
                // 실제 도전 데이터 분석 수행
                performChallengeAnalysis();
            }, 3000);
        }
        
        async function performChallengeAnalysis() {
            try {
                showLoading(true);
                updateStatus('💀 도전 데이터 분석 중...');
                
                const challengeCSV = `Name,RT,Volume,Log P,Anchor
GD1a(36:1;O2),9.572,1000000,1.53,T
GM1a(36:1;O2),10.852,500000,4.20,F
GM3(36:1;O2),10.306,2000000,7.94,F
GD3(36:1;O2),11.726,800000,5.47,F
GT1b(36:1;O2),8.201,1200000,-0.74,T
Unknown_1(36:1;O2),12.543,450000,8.25,F
GQ1c(36:1;O2),7.501,600000,-3.61,F
GP1(36:1;O2),6.851,300000,-6.08,F
Contamination(36:1;O2),15.234,150000,12.45,F
GD1a(34:1;O2),9.123,750000,1.33,F
Noise_signal(unknown),8.765,50000,-2.15,F
GM1a+3OAc(36:1;O2),12.845,180000,5.95,F
Fragment_ion(36:1;O2),10.456,2500000,7.82,F
GD3_isomer(36:1;O2),11.999,720000,5.59,F
Artifact(36:1;O2),14.123,80000,9.87,F`;
                
                const blob = new Blob([challengeCSV], { type: 'text/csv' });
                const formData = new FormData();
                formData.append('file', blob, 'challenge_data.csv');
                formData.append('data_type', currentSettings.analysisMode);
                formData.append('outlier_threshold', currentSettings.outlierThreshold.toString());
                formData.append('r2_threshold', currentSettings.r2Threshold.toString());
                formData.append('rt_tolerance', currentSettings.rtTolerance.toString());
                
                const response = await fetch(`${API_BASE}/api/analyze`, {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    currentAnalysisResults = result.results;
                    displayAnalysisResults(result.results);
                    updateStatus('✅ 도전 데이터 분석 완료');
                    
                    const stats = result.results.statistics;
                    const successRate = stats.success_rate || 0;
                    
                    let message = '💀 도전 데이터 분석 완료!\\n\\n';
                    if (successRate >= 70) {
                        message += '🏆 우수! 어려운 데이터에서도 높은 성공률을 달성했습니다.';
                    } else if (successRate >= 50) {
                        message += '👍 양호! 설정을 더 조정하면 성능을 향상시킬 수 있습니다.';
                    } else {
                        message += '🔧 개선 필요! 설정을 조정하여 성능을 향상시켜보세요.\\n\\n💡 팁:\\n- 표준화 잔차 임계값을 낮춰보세요\\n- R² 임계값을 낮춰보세요\\n- RT 허용 범위를 늘려보세요';
                    }
                    
                    showResult(message, successRate >= 70 ? 'success' : successRate >= 50 ? 'info' : 'warning');
                } else {
                    showResult(`❌ 도전 데이터 분석 실패: ${result.detail || '알 수 없는 오류'}`, 'error');
                    updateStatus('❌ 도전 데이터 분석 실패');
                }
            } catch (error) {
                showResult(`❌ 도전 데이터 분석 오류: ${error.message}`, 'error');
                updateStatus('❌ 도전 데이터 분석 오류');
            } finally {
                showLoading(false);
            }
        }
        
        // 상세 리포트 생성
        function generateReport() {
            if (!currentAnalysisResults) {
                showResult('⚠️ 리포트를 생성할 분석 결과가 없습니다.', 'warning');
                return;
            }
            
            const stats = currentAnalysisResults.statistics;
            const timestamp = new Date().toLocaleString();
            
            const reportData = `# Ganglioside Analysis Report
Generated: ${timestamp}

## Analysis Settings
- **Outlier Threshold**: ${currentSettings.outlierThreshold}
- **R² Threshold**: ${currentSettings.r2Threshold}
- **RT Tolerance**: ±${currentSettings.rtTolerance} min
- **Analysis Mode**: ${currentSettings.analysisMode}
- **Real-time Mode**: ${isRealTimeMode ? 'Enabled' : 'Disabled'}

## Summary Statistics
- **Total Compounds**: ${stats.total_compounds || 0}
- **Valid Compounds**: ${stats.valid_compounds || 0}
- **Outliers**: ${stats.outliers || 0}
- **Success Rate**: ${(stats.success_rate || 0).toFixed(1)}%
- **Anchor Compounds**: ${stats.anchor_compounds || 0}

## Rule-based Analysis
- **Rule 1 (Regression)**: ${stats.rule_breakdown?.rule1_regression || 0} valid
- **Rule 4 (O-acetylation)**: ${stats.rule_breakdown?.rule4_oacetylation || 0} valid
- **Rule 5 (RT Filtering)**: ${stats.rule_breakdown?.rule5_rt_filtering || 0} valid

## Settings History
${settingsHistory.map(entry => `- ${entry.timestamp}: ${entry.setting} = ${entry.value}`).join('\\n')}

## Analysis Status
${currentAnalysisResults.status || 'Unknown'}

Target Achievement: ${currentAnalysisResults.target_achievement || 'N/A'}
`;
            
            const blob = new Blob([reportData], { type: 'text/markdown' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `ganglioside_analysis_report_${new Date().toISOString().slice(0,19).replace(/:/g, '-')}.md`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
            
            showResult('📋 상세 리포트가 성공적으로 생성되었습니다!\\n\\n포함 내용:\\n- 분석 설정\\n- 통계 요약\\n- 규칙별 결과\\n- 설정 변경 히스토리', 'success');
        }
        
        // 결과 다운로드 (향상된 버전)
        async function downloadResults() {
            if (!currentAnalysisResults) {
                showResult('⚠️ 다운로드할 분석 결과가 없습니다.', 'warning');
                return;
            }
            
            try {
                const csvContent = generateEnhancedCSVFromResults(currentAnalysisResults);
                const blob = new Blob([csvContent], { type: 'text/csv' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `ganglioside_analysis_results_${new Date().toISOString().slice(0,19).replace(/:/g, '-')}.csv`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
                
                showResult('💾 향상된 분석 결과가 성공적으로 다운로드되었습니다!\\n\\n추가 정보 포함:\\n- 현재 분석 설정\\n- 예측 RT 값\\n- 표준화 잔차\\n- 상세 분류 사유', 'success');
                updateStatus('✅ 다운로드 완료');
            } catch (error) {
                showResult(`❌ 다운로드 오류: ${error.message}`, 'error');
            }
        }
        
        // 분석 결과 표시 함수 (향상된 버전)
        function displayAnalysisResults(results, isAutoReanalysis = false) {
            const stats = results.statistics;
            const prefix = isAutoReanalysis ? '🔄 실시간 재분석 완료!' : '🔬 분석 완료!';
            
            const summary = `${prefix}

=== 분석 요약 ===
총 화합물 수: ${stats.total_compounds || 'N/A'}
유효 화합물: ${stats.valid_compounds || 'N/A'}
이상치: ${stats.outliers || 'N/A'}
성공률: ${(stats.success_rate || 0).toFixed(1)}%

=== 현재 설정 ===
표준화 잔차 임계값: ${currentSettings.outlierThreshold}
R² 임계값: ${currentSettings.r2Threshold}
RT 허용 범위: ±${currentSettings.rtTolerance}분
분석 모드: ${currentSettings.analysisMode}

=== 규칙별 분석 ===
규칙1 (회귀분석): ${stats.rule_breakdown?.rule1_regression || 0}개 유효
규칙4 (O-아세틸화): ${stats.rule_breakdown?.rule4_oacetylation || 0}개 유효
규칙5 (RT 필터링): ${stats.rule_breakdown?.rule5_rt_filtering || 0}개 유효

분석 상태: ${results.status || 'Unknown'}
목표 달성도: ${results.target_achievement || 'N/A'}

${isAutoReanalysis ? '⚡ 실시간 모드: 설정 변경이 자동 반영되었습니다.' : ''}`;

            showResult(summary, 'success');
        }
        
        // 향상된 CSV 생성 함수
        function generateEnhancedCSVFromResults(results) {
            let csv = 'Name,RT,Volume,Log P,Anchor,Status,Classification,Predicted_RT,Residual,Std_Residual,Analysis_Settings\n';
            
            const settingsString = `"Outlier:${currentSettings.outlierThreshold}|R2:${currentSettings.r2Threshold}|RT:${currentSettings.rtTolerance}|Mode:${currentSettings.analysisMode}"`;
            
            if (results.valid_compounds) {
                results.valid_compounds.forEach(compound => {
                    const predictedRT = compound.predicted_rt ? compound.predicted_rt.toFixed(3) : 'N/A';
                    const residual = compound.residual ? compound.residual.toFixed(3) : 'N/A';
                    const stdResidual = compound.std_residual ? compound.std_residual.toFixed(3) : 'N/A';
                    
                    csv += `"${compound.Name}",${compound.RT},${compound.Volume},${compound['Log P']},${compound.Anchor},Valid,"True Positive",${predictedRT},${residual},${stdResidual},${settingsString}\n`;
                });
            }
            
            if (results.outliers) {
                results.outliers.forEach(outlier => {
                    const predictedRT = outlier.predicted_rt ? outlier.predicted_rt.toFixed(3) : 'N/A';
                    const residual = outlier.residual ? outlier.residual.toFixed(3) : 'N/A';
                    const stdResidual = outlier.std_residual ? outlier.std_residual.toFixed(3) : 'N/A';
                    const reason = (outlier.outlier_reason || 'Unknown').replace(/"/g, '""');
                    
                    csv += `"${outlier.Name}",${outlier.RT},${outlier.Volume},${outlier['Log P']},${outlier.Anchor},Outlier,"${reason}",${predictedRT},${residual},${stdResidual},${settingsString}\n`;
                });
            }
            
            return csv;
        }
        
        // 설정 히스토리 업데이트
        function updateSettingsHistory() {
            const historyContainer = document.getElementById('historyLog');
            if (settingsHistory.length > 0) {
                document.getElementById('settingsHistory').style.display = 'block';
                
                const historyHTML = settingsHistory.slice(-10).reverse().map(entry => 
                    `<div style="padding: 8px; border-left: 3px solid #3498db; margin: 5px 0; background: #f8f9fa;">
                        <strong>${entry.timestamp}</strong>: ${entry.setting} = ${entry.value}
                    </div>`
                ).join('');
                
                historyContainer.innerHTML = historyHTML;
            }
        }
        
        // UI 헬퍼 함수들
        function showResult(message, type) {
            const resultDiv = document.getElementById('result');
            resultDiv.className = `result ${type}`;
            resultDiv.textContent = message;
            resultDiv.scrollTop = resultDiv.scrollHeight;
        }
        
        function showLoading(show) {
            document.getElementById('loadingIndicator').style.display = show ? 'block' : 'none';
        }
        
        function updateStatus(message) {
            document.getElementById('statusBar').innerHTML = `<span class="real-time-indicator"></span>${message}`;
        }
        
        // API 연결 확인
        async function checkAPIStatus() {
            try {
                updateStatus('🔄 API 연결 확인 중...');
                const response = await fetch(`${API_BASE}/`);
                const result = await response.json();
                updateStatus(`✅ ${result.message || 'API 연결 성공'} - 인터랙티브 모드`);
                showResult(`✅ 인터랙티브 시스템 준비 완료!

🎛️ 새로운 기능:
- 실시간 설정 조절
- 자동 재분석
- 상세 리포트 생성
- 설정 히스토리 추적

API 상태: 정상
서버: ${API_BASE}
연결 시간: ${new Date().toLocaleString()}

이제 설정을 조절하며 실시간으로 분석 결과를 확인할 수 있습니다!`, 'success');
            } catch (error) {
                updateStatus('❌ API 연결 실패');
                showResult(`❌ API 연결 실패

오류: ${error.message}
서버: ${API_BASE}

서버가 실행 중인지 확인해주세요.`, 'error');
            }
        }
        
        // 페이지 로드 시 초기화
        window.onload = function() {
            updateStatus('🚀 인터랙티브 시스템 초기화 중...');
            setTimeout(checkAPIStatus, 1000);
        };
        
        // 드래그 앤 드롭 기능
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            document.body.addEventListener(eventName, preventDefaults, false);
        });
        
        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }
        
        ['dragenter', 'dragover'].forEach(eventName => {
            document.body.addEventListener(eventName, highlight, false);
        });
        
        ['dragleave', 'drop'].forEach(eventName => {
            document.body.addEventListener(eventName, unhighlight, false);
        });
        
        function highlight(e) {
            document.body.style.backgroundColor = '#f0f8ff';
        }
        
        function unhighlight(e) {
            document.body.style.backgroundColor = '';
        }
        
        document.body.addEventListener('drop', handleDrop, false);
        
        function handleDrop(e) {
            const dt = e.dataTransfer;
            const files = dt.files;
            
            if (files.length > 0) {
                const file = files[0];
                if (file.type === 'text/csv' || file.name.endsWith('.csv')) {
                    document.getElementById('csvFile').files = files;
                    showResult(`📄 파일이 드롭되었습니다: ${file.name}`, 'info');
                    
                    // 자동 분석 제안
                    setTimeout(() => {
                        if (confirm('파일이 업로드되었습니다. 바로 분석을 시작하시겠습니까?')) {
                            analyzeData();
                        }
                    }, 1000);
                } else {
                    showResult('⚠️ CSV 파일만 업로드 가능합니다.', 'warning');
                }
            }
        }
        
        // 키보드 단축키
        document.addEventListener('keydown', function(e) {
            if (e.ctrlKey) {
                switch(e.key) {
                    case 'r':
                        e.preventDefault();
                        resetToDefaults();
                        break;
                    case 's':
                        e.preventDefault();
                        exportSettings();
                        break;
                    case 'Enter':
                        e.preventDefault();
                        if (currentAnalysisResults) {
                            createVisualization();
                        } else {
                            testSampleData();
                        }
                        break;
                }
            }
        });
        
        // 고급 기능: 설정 프리셋
        const presets = {
            'strict': {
                outlierThreshold: 3.5,
                r2Threshold: 0.995,
                rtTolerance: 0.05,
                name: '엄격한 분석'
            },
            'balanced': {
                outlierThreshold: 3.0,
                r2Threshold: 0.99,
                rtTolerance: 0.1,
                name: '균형 잡힌 분석'
            },
            'lenient': {
                outlierThreshold: 2.0,
                r2Threshold: 0.95,
                rtTolerance: 0.2,
                name: '관대한 분석'
            }
        };
        
        function applyPreset(presetName) {
            const preset = presets[presetName];
            if (!preset) return;
            
            document.getElementById('outlierThreshold').value = preset.outlierThreshold;
            document.getElementById('r2Threshold').value = preset.r2Threshold;
            document.getElementById('rtTolerance').value = preset.rtTolerance;
            
            document.getElementById('outlierValue').textContent = preset.outlierThreshold.toFixed(1);
            document.getElementById('r2Value').textContent = preset.r2Threshold.toFixed(3);
            document.getElementById('rtValue').textContent = `±${preset.rtTolerance.toFixed(2)}`;
            
            currentSettings.outlierThreshold = preset.outlierThreshold;
            currentSettings.r2Threshold = preset.r2Threshold;
            currentSettings.rtTolerance = preset.rtTolerance;
            
            showResult(`📋 "${preset.name}" 프리셋이 적용되었습니다.`, 'success');
            
            if (currentAnalysisResults) {
                reanalyzeWithNewSettings();
            }
        }
        
        // 초기화 완료 메시지
        console.log('🧬 Ganglioside Analyzer - Interactive Mode v2.0 로드 완료');
        console.log('🎛️ 인터랙티브 기능: 실시간 설정 조절, 자동 재분석, 상세 리포트');
        console.log('⌨️ 키보드 단축키: Ctrl+R(리셋), Ctrl+S(설정저장), Ctrl+Enter(분석/시각화)');
    </script>
</body>
</html><!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🧬 Ganglioside Analyzer - Interactive Mode</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .main-container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }
        
        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }
        
        .container {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 20px;
        }
        
        .section {
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            padding: 25px;
            margin: 20px 0;
            transition: all 0.3s ease;
        }
        
        .section:hover {
            border-color: #3498db;
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.1);
        }
        
        .section h3 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 1.3rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .section p {
            color: #6c757d;
            margin-bottom: 15px;
            line-height: 1.6;
        }
        
        /* 새로운 스타일: 상호작용 컨트롤들 */
        .control-panel {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            border: none;
            padding: 25px;
            border-radius: 15px;
            margin: 20px 0;
            box-shadow: 0 8px 25px rgba(240, 147, 251, 0.3);
        }
        
        .control-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .control-item {
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 12px;
            backdrop-filter: blur(10px);
        }
        
        .control-item label {
            display: block;
            font-weight: bold;
            margin-bottom: 10px;
            font-size: 1.1em;
        }
        
        .slider-container {
            position: relative;
            margin: 15px 0;
        }
        
        .slider {
            width: 100%;
            height: 8px;
            border-radius: 5px;
            background: rgba(255, 255, 255, 0.3);
            outline: none;
            opacity: 0.7;
            transition: opacity 0.2s;
        }
        
        .slider:hover {
            opacity: 1;
        }
        
        .slider::-webkit-slider-thumb {
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #ffffff;
            cursor: pointer;
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
        }
        
        .slider::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #ffffff;
            cursor: pointer;
            border: none;
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
        }
        
        .value-display {
            background: rgba(255, 255, 255, 0.2);
            padding: 8px 12px;
            border-radius: 8px;
            font-weight: bold;
            text-align: center;
            margin-top: 10px;
            font-family: 'Courier New', monospace;
        }
        
        .mode-selector {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        
        .mode-option {
            flex: 1;
            padding: 12px;
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 8px;
            color: white;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s ease;
            font-weight: bold;
        }
        
        .mode-option:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        
        .mode-option.active {
            background: rgba(255, 255, 255, 0.9);
            color: #333;
            border-color: white;
        }
        
        .file-input {
            width: 100%;
            padding: 12px;
            border: 2px dashed #3498db;
            border-radius: 8px;
            background: white;
            margin: 15px 0;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .file-input:hover {
            border-color: #2980b9;
            background-color: #f8f9fa;
        }
        
        .btn {
            background: linear-gradient(45deg, #3498db, #2980b9);
            color: white;
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            margin: 5px;
            transition: all 0.3s ease;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }
        
        .btn:active {
            transform: translateY(0);
        }
        
        .btn-success {
            background: linear-gradient(45deg, #27ae60, #2ecc71);
        }
        
        .btn-warning {
            background: linear-gradient(45deg, #f39c12, #e67e22);
        }
        
        .btn-danger {
            background: linear-gradient(45deg, #e74c3c, #c0392b);
        }
        
        .btn-primary {
            background: linear-gradient(45deg, #8e44ad, #9b59b6);
        }
        
        .button-group {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
            margin-top: 15px;
        }
        
        .result {
            margin-top: 20px;
            padding: 20px;
            border-radius: 8px;
            white-space: pre-wrap;
            font-family: 'Courier New', monospace;
            max-height: 400px;
            overflow-y: auto;
            border-left: 4px solid;
        }
        
        .success {
            background-color: #d4edda;
            color: #155724;
            border-left-color: #28a745;
        }
        
        .error {
            background-color: #f8d7da;
            color: #721c24;
            border-left-color: #dc3545;
        }
        
        .info {
            background-color: #d1ecf1;
            color: #0c5460;
            border-left-color: #17a2b8;
        }
        
        .warning {
            background-color: #fff3cd;
            color: #856404;
            border-left-color: #ffc107;
        }
        
        .status-bar {
            background: #34495e;
            color: white;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
            font-weight: bold;
        }
        
        .feature-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }
        
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .analysis-settings {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px;
            padding: 25px;
            margin: 20px 0;
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
        }
        
        .real-time-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            background: #2ecc71;
            border-radius: 50%;
            margin-right: 8px;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        .parameter-info {
            font-size: 0.9em;
            opacity: 0.8;
            margin-top: 5px;
        }
        
        @media (max-width: 768px) {
            .main-container {
                padding: 10px;
            }
            
            .container {
                padding: 20px;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .control-grid {
                grid-template-columns: 1fr;
            }
            
            .button-group {
                flex-direction: column;
            }
            
            .btn {
                width: 100%;
                margin: 5px 0;
            }
        }
    </style>
</head>
<body>
    <div class="main-container">
        <div class="header">
            <h1>🧬 Ganglioside Analyzer</h1>
            <p>산성 당지질 LC-MS/MS 데이터 자동 분석 시스템 - 인터랙티브 모드</p>
        </div>
        
        <div class="status-bar" id="statusBar">
            <span class="real-time-indicator"></span>
            🔄 시스템 초기화 중...
        </div>
        
        <!-- 새로운 기능: 분석 설정 패널 -->
        <div class="control-panel">
            <h3 style="margin-top: 0; text-align: center; font-size: 1.8em;">⚙️ 실시간 분석 설정</h3>
            <p style="text-align: center; opacity: 0.9; margin-bottom: 20px;">설정을 변경하면 즉시 재분석이 수행됩니다</p>
            
            <div class="control-grid">
                <div class="control-item">
                    <label for="outlierThreshold">📊 표준화 잔차 임계값</label>
                    <div class="slider-container">
                        <input type="range" id="outlierThreshold" class="slider" min="1.0" max="5.0" step="0.1" value="3.0">
                        <div class="value-display" id="outlierValue">3.0</div>
                    </div>
                    <div class="parameter-info">이상치 판별 기준 (높을수록 엄격)</div>
                </div>
                
                <div class="control-item">
                    <label for="r2Threshold">📈 결정계수 (R²) 임계값</label>
                    <div class="slider-container">
                        <input type="range" id="r2Threshold" class="slider" min="0.90" max="0.999" step="0.001" value="0.99">
                        <div class="value-display" id="r2Value">0.990</div>
                    </div>
                    <div class="parameter-info">회귀분석 품질 기준 (높을수록 엄격)</div>
                </div>
                
                <div class="control-item">
                    <label for="rtTolerance">⏱️ RT 허용 범위 (분)</label>
                    <div class="slider-container">
                        <input type="range" id="rtTolerance" class="slider" min="0.05" max="0.5" step="0.01" value="0.1">
                        <div class="value-display" id="rtValue">±0.10</div>
                    </div>
                    <div class="parameter-info">동일 접미사 그룹 내 RT 허용 오차</div>
                </div>
                
                <div class="control-item">
                    <label>🔬 분석 모드</label>
                    <div class="mode-selector">
                        <div class="mode-option active" data-mode="Porcine" onclick="selectMode('Porcine')">
                            🐷 Porcine
                        </div>
                        <div class="mode-option" data-mode="Mouse" onclick="selectMode('Mouse')">
                            🐭 Mouse
                        </div>
                    </div>
                    <div class="parameter-info">데이터 종류에 따른 분석 규칙 적용</div>
                </div>
            </div>
            
            <div style="text-align: center; margin-top: 25px;">
                <button class="btn btn-primary" onclick="resetToDefaults()">
                    🔄 기본값 복원
                </button>
                <button class="btn btn-warning" onclick="exportSettings()">
                    💾 설정 내보내기
                </button>
                <button class="btn btn-success" onclick="applyAdvancedRules()">
                    🚀 고급 규칙 적용
                </button>
            </div>
        </div>
        
        <div class="container">
            <div class="feature-grid">
                <!-- 파일 업로드 섹션 -->
                <div class="section">
                    <h3>📄 CSV 파일 업로드</h3>
                    <p><strong>필수 컬럼:</strong> Name, RT, Volume, Log P, Anchor</p>
                    <input type="file" id="csvFile" accept=".csv" class="file-input">
                    <div class="button-group">
                        <button class="btn" onclick="uploadFile()">📤 파일 업로드</button>
                        <button class="btn btn-success" onclick="analyzeData()">🔬 데이터 분석</button>
                    </div>
                </div>
                
                <!-- 시각화 섹션 -->
                <div class="section">
                    <h3>📊 시각화 및 결과</h3>
                    <p>분석 결과를 시각적으로 확인하고 다운로드할 수 있습니다.</p>
                    <div class="button-group">
                        <button class="btn btn-warning" onclick="createVisualization()">📈 시각화 생성</button>
                        <button class="btn btn-success" onclick="downloadResults()">💾 결과 다운로드</button>
                        <button class="btn btn-primary" onclick="generateReport()">📋 상세 리포트</button>
                    </div>
                </div>
            </div>
            
            <!-- 샘플 데이터 테스트 -->
            <div class="section">
                <h3>🧪 샘플 데이터 테스트</h3>
                <p>미리 준비된 샘플 데이터로 시스템을 테스트해보세요.</p>
                <div class="button-group">
                    <button class="btn btn-success" onclick="testSampleData()">🚀 샘플 데이터 테스트</button>
                    <button class="btn btn-warning" onclick="testComplexSample()">🧬 복합 샘플 테스트</button>
                    <button class="btn btn-danger" onclick="testChallengeData()">💀 도전 데이터 테스트</button>
                </div>
            </div>
        </div>
        
        <!-- 로딩 인디케이터 -->
        <div class="loading" id="loadingIndicator">
            <div class="spinner"></div>
            <p>실시간 분석 중...</p>
        </div>
        
        <!-- 결과 표시 영역 -->
        <div class="container">
            <div id="result"></div>
        </div>
        
        <!-- 시각화 표시 영역 -->
        <div class="container" style="display: none;" id="visualizationContainer">
            <h3>📊 분석 결과 시각화</h3>
            <div id="visualizations"></div>
        </div>
        
        <!-- 설정 변경 히스토리 -->
        <div class="container" style="display: none;" id="settingsHistory">
            <h3>📈 설정 변경 히스토리</h3>
            <div id="historyLog"></div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8000';
        let currentAnalysisResults = null;
        let currentSettings = {
            outlierThreshold: 3.0,
            r2Threshold: 0.99,
            rtTolerance: 0.1,
            analysisMode: 'Porcine'
        };
        let isRealTimeMode = false;
        let settingsHistory = [];
        
        // 초기화
        document.addEventListener('DOMContentLoaded', function() {
            initializeSliders();
            updateStatus('🚀 시스템 초기화 중...');
            setTimeout(checkAPIStatus, 1000);
        });
        
        // 슬라이더 초기화 및 이벤트 리스너
        function initializeSliders() {
            const outlierSlider = document.getElementById('outlierThreshold');
            const r2Slider = document.getElementById('r2Threshold');
            const rtSlider = document.getElementById('rtTolerance');
            
            outlierSlider.addEventListener('input', function() {
                const value = parseFloat(this.value);
                document.getElementById('outlierValue').textContent = value.toFixed(1);
                currentSettings.outlierThreshold = value;
                onSettingChange('outlierThreshold', value);
            });
            
            r2Slider.addEventListener('input', function() {
                const value = parseFloat(this.value);
                document.getElementById('r2Value').textContent = value.toFixed(3);
                currentSettings.r2Threshold = value;
                onSettingChange('r2Threshold', value);
            });
            
            rtSlider.addEventListener('input', function() {
                const value = parseFloat(this.value);
                document.getElementById('rtValue').textContent = `±${value.toFixed(2)}`;
                currentSettings.rtTolerance = value;
                onSettingChange('rtTolerance', value);
            });
        }
        
        // 설정 변경 시 호출
        function onSettingChange(setting, value) {
            // 히스토리 추가
            settingsHistory.push({
                timestamp: new Date().toLocaleTimeString(),
                setting: setting,
                value: value
            });
            
            // 실시간 모드일 때 자동 재분석
            if (isRealTimeMode && currentAnalysisResults) {
                showResult(`⚡ 설정 변경 감지: ${setting} = ${value}\\n실시간 재분석 중...`, 'info');
                debounceAnalysis();
            }
            
            // 설정 히스토리 업데이트
            updateSettingsHistory();
        }
        
        // 디바운스된 분석 (연속된 설정 변경 시 마지막 변경 후 1초 뒤 분석)
        let analysisTimeout;
        function debounceAnalysis() {
            clearTimeout(analysisTimeout);
            analysisTimeout = setTimeout(() => {
                if (currentAnalysisResults) {
                    reanalyzeWithNewSettings();
                }
            }, 1000);
        }
        
        // 새로운 설정으로 재분석
        async function reanalyzeWithNewSettings() {
            try {
                showLoading(true);
                updateStatus('🔄 설정 적용 중...');
                
                // 현재 파일로 재분석 요청
                const fileInput = document.getElementById('csvFile');
                if (fileInput.files[0]) {
                    await analyzeData(true); // 자동 재분석 플래그
                } else {
                    // 샘플 데이터로 재분석
                    await testSampleData(true);
                }
                
                updateStatus('✅ 실시간 분석 완료');
            } catch (error) {
                showResult(`❌ 실시간 분석 오류: ${error.message}`, 'error');
                updateStatus('❌ 실시간 분석 실패');
            } finally {
                showLoading(false);
            }
        }
        
        // 분석 모드 선택
        function selectMode(mode) {
            // UI 업데이트
            document.querySelectorAll('.mode-option').forEach(option => {
                option.classList.remove('active');
            });
            document.querySelector(`[data-mode="${mode}"]`).classList.add('active');
            
            // 설정 업데이트
            currentSettings.analysisMode = mode;
            onSettingChange('analysisMode', mode);
        }
        
        // 기본값 복원
        function resetToDefaults() {
            document.getElementById('outlierThreshold').value = 3.0;
            document.getElementById('r2Threshold').value = 0.99;
            document.getElementById('rtTolerance').value = 0.1;
            
            document.getElementById('outlierValue').textContent = '3.0';
            document.getElementById('r2Value').textContent = '0.990';
            document.getElementById('rtValue').textContent = '±0.10';
            
            selectMode('Porcine');
            
            currentSettings = {
                outlierThreshold: 3.0,
                r2Threshold: 0.99,
                rtTolerance: 0.1,
                analysisMode: 'Porcine'
            };
            
            showResult('🔄 모든 설정이 기본값으로 복원되었습니다.', 'success');
            
            if (currentAnalysisResults) {
                reanalyzeWithNewSettings();
            }
        }
        
        // 설정 내보내기
        function exportSettings() {
            const settingsData = {
                settings: currentSettings,
                timestamp: new Date().toISOString(),
                history: settingsHistory
            };
            
            const dataStr = JSON.stringify(settingsData, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `ganglioside_settings_${new Date().toISOString().slice(0,19).replace(/:/g, '-')}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
            
            showResult('💾 설정이 성공적으로 내보내졌습니다!', 'success');
        }
        
        // 고급 규칙 적용
        function applyAdvancedRules() {
            showResult(`🚀 고급 규칙 모드 활성화!

✅ 활성화된 고급 기능:
- GD1+dHex → GD1b 자동 분류
- GQ1 이성질체 RT 기반 구분
- O-acetylation 효과 정밀 검증
- In-source fragmentation 탐지
- Volume 통합 최적화

현재 설정으로 고급 분석을 수행합니다.`, 'info');
            
            if (currentAnalysisResults) {
                reanalyzeWithNewSettings();
            }
        }
        
        // 파일 업로드 함수
        async function uploadFile() {
            const fileInput = document.getElementById('csvFile');
            const file = fileInput.files[0];
            
            if (!file) {
                showResult('⚠️ 파일을 선택해주세요.', 'warning');
                return;
            }
            
            const formData = new FormData();
            formData.append('file', file);
            
            try {
                showLoading(true);
                updateStatus('📤 파일 업로드 중...');
                
                const response = await fetch(`${API_BASE}/api/upload`, {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    showResult(`✅ 업로드 성공!\\n파일명: ${file.name}\\n크기: ${(file.size/1024).toFixed(1)} KB\\n\\n${JSON.stringify(result, null, 2)}`, 'success');
                    updateStatus('✅ 파일 업로드 완료');
                    
                    // 실시간 모드 활성화 제안
                    if (!isRealTimeMode) {
                        setTimeout(() => {
                            if (confirm('실시간 분석 모드를 활성화하시겠습니까?\\n설정 변경 시 자동으로 재분석이 수행됩니다.')) {
                                isRealTimeMode = true;
                                updateStatus('⚡ 실시간 모드 활성화');
                            }
                        }, 2000);
                    }
                } else {
                    showResult(`❌ 업로드 실패: ${result.detail || '알 수 없는 오류'}`, 'error');
                    updateStatus('❌ 파일 업로드 실패');
                }
            } catch (error) {
                showResult(`❌ 네트워크 오류: ${error.message}`, 'error');
                updateStatus('❌ 연결 오류');
            } finally {
                showLoading(false);
            }
        }
        
        // 데이터 분석 함수 (향상된 버전)
        async function analyzeData(isAutoReanalysis = false) {
            const fileInput = document.getElementById('csvFile');
            const file = fileInput.files[0];
            
            if (!file && !isAutoReanalysis) {
                showResult('⚠️ 분석할 파일을 먼저 선택해주세요.', 'warning');
                return;
            }
            
            if (!file && isAutoReanalysis) {
                // 자동 재분석인데 파일이 없으면 샘플 데이터 사용
                return