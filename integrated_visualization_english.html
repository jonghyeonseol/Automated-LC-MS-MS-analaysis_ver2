<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üß¨ Integrated LC-MS-MS Analysis Platform</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/plotly.js/2.26.0/plotly.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 3.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.3em;
            opacity: 0.9;
        }

        /* Main layout */
        .main-layout {
            display: grid;
            grid-template-columns: 350px 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        /* Left control panel */
        .control-sidebar {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            height: fit-content;
        }

        .control-section {
            margin-bottom: 25px;
        }

        .control-section h3 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 1.2em;
            border-bottom: 2px solid #3498db;
            padding-bottom: 5px;
        }

        /* File upload */
        .file-upload {
            border: 3px dashed #667eea;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
            margin-bottom: 15px;
        }

        .file-upload:hover {
            border-color: #764ba2;
            background: rgba(102, 126, 234, 0.05);
        }

        .file-upload.dragover {
            border-color: #764ba2;
            background: rgba(102, 126, 234, 0.1);
            transform: scale(1.02);
        }

        .file-upload.uploaded {
            border-color: #27ae60;
            background: rgba(39, 174, 96, 0.1);
        }

        .file-upload.uploaded:hover {
            background: rgba(39, 174, 96, 0.15);
        }

        /* Setting sliders */
        .slider-group {
            margin-bottom: 15px;
        }

        .slider-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #2c3e50;
        }

        .slider-container {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .slider-container input[type="range"] {
            flex: 1;
            height: 6px;
            border-radius: 3px;
            background: #ddd;
            outline: none;
        }

        .slider-value {
            min-width: 60px;
            text-align: center;
            background: #f8f9fa;
            padding: 4px 8px;
            border-radius: 4px;
            font-weight: bold;
            color: #495057;
        }

        /* Analysis mode selector */
        .mode-selector {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .mode-option {
            padding: 12px;
            text-align: center;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: bold;
        }

        .mode-option:hover {
            border-color: #667eea;
            background: #f8f9ff;
        }

        .mode-option.active {
            border-color: #667eea;
            background: #667eea;
            color: white;
        }

        /* Buttons */
        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            font-weight: bold;
            transition: all 0.3s ease;
            margin: 5px;
            display: inline-block;
            text-decoration: none;
        }

        .btn-primary {
            background: #3498db;
            color: white;
        }

        .btn-primary:hover {
            background: #2980b9;
            transform: translateY(-1px);
        }

        .btn-success {
            background: #27ae60;
            color: white;
        }

        .btn-success:hover {
            background: #219a52;
            transform: translateY(-1px);
        }

        /* Status display */
        .status-panel {
            background: #f8f9fa;
            border-left: 4px solid #3498db;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            font-family: 'Courier New', monospace;
        }

        /* File info panel */
        .file-info-panel {
            display: none;
            margin-top: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            border: 1px solid #e9ecef;
        }

        /* Right content area */
        .content-area {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        /* Tab navigation */
        .tab-navigation {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 2px solid #e9ecef;
        }

        .tab-btn {
            padding: 15px 25px;
            background: none;
            border: none;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            color: #6c757d;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
        }

        .tab-btn.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }

        .tab-btn:hover:not(.active) {
            color: #495057;
            background-color: #f8f9fa;
        }

        .tab-content {
            min-height: 600px;
        }

        .tab-pane {
            display: none;
        }

        .tab-pane.active {
            display: block;
        }

        /* Visualization area */
        .visualization-area {
            border: 1px solid #e9ecef;
            border-radius: 10px;
            padding: 20px;
            min-height: 500px;
        }

        .plot-container {
            width: 100%;
            height: 600px;
        }

        /* Controls */
        .controls {
            text-align: center;
            margin-bottom: 20px;
        }

        /* Real-time status */
        .realtime-status {
            background: #e3f2fd;
            border: 1px solid #90caf9;
            border-radius: 5px;
            padding: 10px;
            margin-top: 15px;
            text-align: center;
            font-weight: bold;
            color: #0d47a1;
        }

        .advanced-controls {
            margin-top: 15px;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .advanced-controls .btn {
            margin: 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üß¨ Integrated LC-MS-MS Analysis Platform</h1>
            <p>Advanced interactive visualization of Mass-to-Charge, Retention Time, and Partition Coefficient relationships</p>
        </div>

        <!-- Main layout -->
        <div class="main-layout">
            <!-- Left control panel -->
            <div class="control-sidebar">
                <!-- File upload -->
                <div class="control-section">
                    <h3>üìÅ Data Upload</h3>
                    <div class="file-upload" id="fileUpload" onclick="document.getElementById('csvFile').click();">
                        <div style="font-size: 2em; margin-bottom: 10px;">üìÑ</div>
                        <div>Upload CSV File</div>
                        <small>Click or drag</small>
                        <input type="file" id="csvFile" accept=".csv" style="display: none;">
                    </div>
                    <div id="fileStatus" style="text-align: center; color: #6c757d; font-size: 0.9em;">Please select a file</div>

                    <!-- File information panel -->
                    <div id="fileInfoPanel" class="file-info-panel">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <h4 style="margin: 0; color: #2c3e50; font-size: 1em;">üìã Uploaded File Information</h4>
                            <button id="removeFileBtn" onclick="removeUploadedFile()" style="background: #e74c3c; color: white; border: none; border-radius: 4px; padding: 4px 8px; font-size: 0.8em; cursor: pointer;">‚úï Delete</button>
                        </div>
                        <div id="fileDetails">
                            <div><strong>Filename:</strong> <span id="fileName">-</span></div>
                            <div><strong>File size:</strong> <span id="fileSize">-</span></div>
                            <div><strong>Upload time:</strong> <span id="uploadTime">-</span></div>
                            <div><strong>Status:</strong> <span id="fileStatusDetail" style="color: #27ae60;">‚úÖ Upload complete</span></div>
                        </div>
                        <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #e9ecef;">
                            <button onclick="previewFile()" style="background: #3498db; color: white; border: none; border-radius: 4px; padding: 6px 12px; font-size: 0.9em; cursor: pointer; margin-right: 8px;">üëÅÔ∏è Preview</button>
                            <button onclick="document.getElementById('csvFile').click()" style="background: #f39c12; color: white; border: none; border-radius: 4px; padding: 6px 12px; font-size: 0.9em; cursor: pointer;">üîÑ Replace File</button>
                        </div>
                    </div>
                </div>

                <!-- Analysis settings -->
                <div class="control-section">
                    <h3>‚öôÔ∏è Analysis Settings</h3>
                    <div class="slider-group">
                        <label>Outlier Threshold</label>
                        <div class="slider-container">
                            <input type="range" id="outlierThreshold" min="1.0" max="5.0" step="0.1" value="3.0">
                            <span class="slider-value" id="outlierValue">3.0</span>
                        </div>
                    </div>

                    <div class="slider-group">
                        <label>R¬≤ Threshold</label>
                        <div class="slider-container">
                            <input type="range" id="r2Threshold" min="0.900" max="0.999" step="0.001" value="0.990">
                            <span class="slider-value" id="r2Value">0.990</span>
                        </div>
                    </div>

                    <div class="slider-group">
                        <label>RT Tolerance (min)</label>
                        <div class="slider-container">
                            <input type="range" id="rtTolerance" min="0.05" max="0.50" step="0.01" value="0.10">
                            <span class="slider-value" id="rtValue">¬±0.10</span>
                        </div>
                    </div>

                    <div style="margin-top: 20px;">
                        <label>Analysis Mode</label>
                        <div class="mode-selector">
                            <div class="mode-option active" data-mode="Porcine" onclick="selectMode('Porcine')">üê∑ Porcine</div>
                            <div class="mode-option" data-mode="Mouse" onclick="selectMode('Mouse')">üê≠ Mouse</div>
                        </div>
                    </div>
                </div>

                <!-- Execution buttons -->
                <div class="control-section">
                    <h3>üöÄ Execution</h3>
                    <button class="btn btn-primary" onclick="runAnalysis()">Start Analysis</button>
                    <button class="btn btn-success" onclick="generateIntegratedVisualization()" id="visualizeBtn" style="display: none;">Integrated Visualization</button>

                    <div class="advanced-controls">
                        <button class="btn btn-primary" onclick="resetSettings()">üîÑ Reset Settings</button>
                        <button class="btn btn-success" onclick="downloadResults()" id="downloadBtn" style="display: none;">üíæ Download Results</button>
                        <button class="btn btn-primary" onclick="testConnection()" style="background-color: #e74c3c;">üîå Connection Test</button>
                    </div>
                </div>

                <!-- Real-time status -->
                <div class="control-section">
                    <h3>üìä Real-time Status</h3>
                    <div class="realtime-status" id="realtimeStatus">
                        Ready for analysis
                    </div>
                </div>
            </div>

            <!-- Right content area -->
            <div class="content-area">
                <!-- Tab navigation -->
                <div class="tab-navigation">
                    <button class="tab-btn active" data-tab="analysis" onclick="switchTab('analysis')">üìà Analysis</button>
                    <button class="tab-btn" data-tab="visualization-2d" onclick="switchTab('visualization-2d')">üìä 2D Visualization</button>
                    <button class="tab-btn" data-tab="visualization-3d" onclick="switchTab('visualization-3d')">üåê 3D Visualization</button>
                    <button class="tab-btn" data-tab="integrated" onclick="switchTab('integrated')">üîó Integrated</button>
                </div>

                <!-- Tab content -->
                <div class="tab-content">
                    <!-- Analysis results tab -->
                    <div id="analysis" class="tab-pane active">
                        <div class="status-panel" id="statusDisplay">
                            To start analysis, upload a CSV file and click the 'Start Analysis' button.
                        </div>

                        <div class="stats-grid" id="statsGrid" style="display: none;">
                            <!-- Dynamically generated -->
                        </div>

                        <div id="analysisDetails" style="display: none;">
                            <h4>Detailed Analysis Information</h4>
                            <div id="detailsContent"></div>
                        </div>
                    </div>

                    <!-- 2D Visualization tab -->
                    <div id="visualization-2d" class="tab-pane">
                        <div class="controls">
                            <button class="btn btn-primary" onclick="reset2DView()">üîÑ Reset View</button>
                            <button class="btn btn-primary" onclick="toggle2DOutliers()">üëÅÔ∏è Toggle Outliers</button>
                            <button class="btn btn-primary" onclick="show2DRegression()">üìà Show Regression Line</button>
                        </div>

                        <div class="visualization-area">
                            <div id="plot-2d" class="plot-container"></div>
                        </div>
                    </div>

                    <!-- 3D Visualization tab -->
                    <div id="visualization-3d" class="tab-pane">
                        <div class="controls">
                            <button class="btn btn-primary" onclick="reset3DView()">üîÑ Reset View</button>
                            <button class="btn btn-primary" onclick="toggle3DOutliers()">üëÅÔ∏è Toggle Outliers</button>
                            <button class="btn btn-primary" onclick="toggle3DRegression()">üìà Toggle Regression Plane</button>
                        </div>

                        <div class="visualization-area">
                            <div id="plot-3d" class="plot-container"></div>
                        </div>
                    </div>

                    <!-- Integrated visualization tab -->
                    <div id="integrated" class="tab-pane">
                        <div class="controls">
                            <button class="btn btn-primary" onclick="refreshIntegratedView()">üîÑ Refresh</button>
                            <button class="btn btn-primary" onclick="openIntegratedWindow()">üîó Open in New Window</button>
                        </div>

                        <div class="visualization-area">
                            <div id="integratedVisualization" style="min-height: 600px;">
                                <div style="text-align: center; padding: 50px; color: #6c757d;">
                                    Complete analysis first to view integrated visualization
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        console.log('üß¨ Integrated LC-MS-MS Analysis Platform Loading...');

        // Global variables
        let uploadedFile = null;
        let currentAnalysisResults = null;
        let currentSettings = {
            outlierThreshold: 3.0,
            r2Threshold: 0.99,
            rtTolerance: 0.1,
            analysisMode: 'Porcine'
        };

        // Visualization control variables
        let showOutliers2D = true;
        let showOutliers3D = true;
        let showRegression2D = false;
        let showRegression3D = false;

        // Page initialization
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ DOM loaded, initializing event listeners...');
            initializeEventListeners();
            setupDragAndDrop();
            initializeTabs();
            console.log('‚úÖ All event listeners initialized');
        });

        // Initialize event listeners
        function initializeEventListeners() {
            console.log('üîß Setting up event listeners...');

            // Slider events
            document.getElementById('outlierThreshold').addEventListener('input', updateOutlierValue);
            document.getElementById('r2Threshold').addEventListener('input', updateR2Value);
            document.getElementById('rtTolerance').addEventListener('input', updateRtValue);

            // File upload event
            document.getElementById('csvFile').addEventListener('change', handleFileUpload);

            console.log('‚úÖ Event listeners setup complete');
        }

        // Tab initialization
        function initializeTabs() {
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const targetTab = this.getAttribute('data-tab');
                    switchTab(targetTab);
                });
            });
        }

        // Tab switching
        function switchTab(tabId) {
            console.log(`üîÑ Switching to tab: ${tabId}`);

            // Remove active class from all tabs and panes
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-pane').forEach(pane => pane.classList.remove('active'));

            // Add active class to selected tab and pane
            document.querySelector(`[data-tab="${tabId}"]`).classList.add('active');
            document.getElementById(tabId).classList.add('active');
        }

        // Drag and drop setup
        function setupDragAndDrop() {
            const fileUpload = document.getElementById('fileUpload');

            fileUpload.addEventListener('dragover', function(e) {
                e.preventDefault();
                fileUpload.classList.add('dragover');
            });

            fileUpload.addEventListener('dragleave', function(e) {
                e.preventDefault();
                fileUpload.classList.remove('dragover');
            });

            fileUpload.addEventListener('drop', function(e) {
                e.preventDefault();
                fileUpload.classList.remove('dragover');

                const files = e.dataTransfer.files;
                if (files.length === 0) {
                    showStatus('‚ùå No file was dropped.', 'error');
                    return;
                }

                if (files.length > 1) {
                    showStatus('‚ö†Ô∏è Only one file can be uploaded at a time.', 'error');
                    return;
                }

                const file = files[0];
                if (!file.name.endsWith('.csv')) {
                    showStatus('‚ùå Only CSV files can be dragged and dropped.', 'error');
                    return;
                }

                showStatus('üéØ File was dropped! Processing...', 'loading');
                document.getElementById('csvFile').files = files;
                handleFileUpload({target: {files: files}});
            });
        }

        // File upload handler
        function handleFileUpload(event) {
            console.log('üìÅ File upload event triggered:', event);

            // Show loading feedback immediately
            showStatus('üìÇ Processing file...', 'loading');
            document.getElementById('fileStatus').textContent = 'Processing file...';
            document.getElementById('fileStatus').style.color = '#f39c12';

            const file = event.target.files[0];
            console.log('üìÑ Selected file:', file);

            if (!file) {
                console.log('‚ùå No file selected');
                showStatus('‚ùå No file was selected.', 'error');
                document.getElementById('fileStatus').textContent = 'Please select a file';
                document.getElementById('fileStatus').style.color = '#6c757d';
                return;
            }

            if (!file.name.endsWith('.csv')) {
                showStatus('‚ùå Only CSV files can be uploaded. Other file formats are not supported.', 'error');
                console.log('‚ùå Invalid file type:', file.name);
                document.getElementById('fileStatus').textContent = `‚ùå Unsupported file: ${file.name}`;
                document.getElementById('fileStatus').style.color = '#e74c3c';
                return;
            }

            // Check file size (optional - warn for very large files)
            const maxSize = 50 * 1024 * 1024; // 50MB
            if (file.size > maxSize) {
                showStatus(`‚ö†Ô∏è File is very large (${(file.size/1024/1024).toFixed(1)} MB). Processing may take a while.`, 'loading');
            }

            uploadedFile = file;
            console.log('‚úÖ File uploaded successfully:', file.name, file.size, 'bytes');

            // Enhanced success feedback
            const fileSizeKB = (file.size/1024).toFixed(1);
            const fileSizeMB = (file.size/1024/1024).toFixed(2);
            const sizeDisplay = file.size > 1024*1024 ? `${fileSizeMB} MB` : `${fileSizeKB} KB`;

            document.getElementById('fileStatus').textContent = `‚úÖ ${file.name} (${sizeDisplay})`;
            document.getElementById('fileStatus').style.color = '#27ae60';
            showStatus(`üéâ Data file has been uploaded! Filename: ${file.name}, Size: ${sizeDisplay}`, 'success');

            // Show detailed file information panel
            showFileInfoPanel(file, sizeDisplay);

            // Update upload area visual state
            document.getElementById('fileUpload').classList.add('uploaded');

            // Add a brief preview of file info
            setTimeout(() => {
                showStatus(`üìã Uploaded file: ${file.name} | You can now click the 'Start Analysis' button to begin LC-MS-MS data analysis.`, 'info');
            }, 2000);
        }

        // Show file information panel
        function showFileInfoPanel(file, sizeDisplay) {
            const panel = document.getElementById('fileInfoPanel');
            const fileName = document.getElementById('fileName');
            const fileSize = document.getElementById('fileSize');
            const uploadTime = document.getElementById('uploadTime');
            const fileStatusDetail = document.getElementById('fileStatusDetail');

            // Display upload time
            const now = new Date();
            const timeString = now.toLocaleString('en-US', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });

            // Update file information
            fileName.textContent = file.name;
            fileSize.textContent = sizeDisplay;
            uploadTime.textContent = timeString;
            fileStatusDetail.innerHTML = '‚úÖ Upload complete';
            fileStatusDetail.style.color = '#27ae60';

            // Show panel
            panel.style.display = 'block';

            // Animation effect
            panel.style.opacity = '0';
            panel.style.transform = 'translateY(-10px)';
            setTimeout(() => {
                panel.style.transition = 'all 0.3s ease';
                panel.style.opacity = '1';
                panel.style.transform = 'translateY(0)';
            }, 100);
        }

        // Remove uploaded file
        function removeUploadedFile() {
            if (confirm('Are you sure you want to delete the uploaded file?')) {
                uploadedFile = null;

                // Reset UI
                document.getElementById('csvFile').value = '';
                document.getElementById('fileStatus').textContent = 'Please select a file';
                document.getElementById('fileStatus').style.color = '#6c757d';
                document.getElementById('fileInfoPanel').style.display = 'none';
                document.getElementById('fileUpload').classList.remove('uploaded');

                // Reset analysis results
                currentAnalysisResults = null;
                document.getElementById('visualizeBtn').style.display = 'none';
                document.getElementById('downloadBtn').style.display = 'none';

                showStatus('üóëÔ∏è File has been deleted. Please upload a new file.', 'info');
            }
        }

        // File preview
        function previewFile() {
            if (!uploadedFile) {
                showStatus('‚ùå No file to preview.', 'error');
                return;
            }

            showStatus('üìñ Loading file preview...', 'loading');

            const reader = new FileReader();
            reader.onload = function(e) {
                const text = e.target.result;
                const lines = text.split('\n');
                const previewLines = lines.slice(0, 10); // Show first 10 lines only

                // Create preview modal
                const modal = document.createElement('div');
                modal.style.cssText = `
                    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                    background: rgba(0,0,0,0.5); display: flex; justify-content: center;
                    align-items: center; z-index: 1000;
                `;

                modal.innerHTML = `
                    <div style="background: white; border-radius: 10px; padding: 20px; max-width: 80%; max-height: 80%; overflow-y: auto;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <h3>üìñ File Preview: ${uploadedFile.name}</h3>
                            <button onclick="this.closest('.modal').remove()" style="background: #e74c3c; color: white; border: none; border-radius: 4px; padding: 5px 10px; cursor: pointer;">‚úï Close</button>
                        </div>
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 5px; font-family: monospace; font-size: 0.9em; white-space: pre-wrap; overflow-x: auto;">
${previewLines.join('\n')}
${lines.length > 10 ? '\n... (Total ' + lines.length + ' lines, showing first 10 only)' : ''}
                        </div>
                        <div style="margin-top: 10px; font-size: 0.9em; color: #666;">
                            <strong>File Information:</strong> ${lines.length} lines, ${uploadedFile.size} bytes
                        </div>
                    </div>
                `;

                modal.className = 'modal';
                document.body.appendChild(modal);

                // Close modal by clicking outside
                modal.addEventListener('click', function(e) {
                    if (e.target === modal) {
                        modal.remove();
                    }
                });

                showStatus('‚úÖ File preview is ready.', 'success');
            };

            reader.onerror = function() {
                showStatus('‚ùå Cannot read file.', 'error');
            };

            reader.readAsText(uploadedFile);
        }

        // Slider value update functions
        function updateOutlierValue(event) {
            const value = parseFloat(event.target.value);
            document.getElementById('outlierValue').textContent = value.toFixed(1);
            currentSettings.outlierThreshold = value;

            showStatus(`‚öôÔ∏è Outlier threshold changed to ${value.toFixed(1)}.`, 'info');

            if (uploadedFile) {
                showStatus('üîÑ Settings changed, automatic re-analysis will start...', 'loading');
                debounceAnalysis();
            }
        }

        function updateR2Value(event) {
            const value = parseFloat(event.target.value);
            document.getElementById('r2Value').textContent = value.toFixed(3);
            currentSettings.r2Threshold = value;

            showStatus(`‚öôÔ∏è R¬≤ threshold changed to ${value.toFixed(3)}.`, 'info');

            if (uploadedFile) {
                showStatus('üîÑ Settings changed, automatic re-analysis will start...', 'loading');
                debounceAnalysis();
            }
        }

        function updateRtValue(event) {
            const value = parseFloat(event.target.value);
            document.getElementById('rtValue').textContent = `¬±${value.toFixed(2)}`;
            currentSettings.rtTolerance = value;

            showStatus(`‚öôÔ∏è RT tolerance changed to ¬±${value.toFixed(2)} minutes.`, 'info');

            if (uploadedFile) {
                showStatus('üîÑ Settings changed, automatic re-analysis will start...', 'loading');
                debounceAnalysis();
            }
        }

        // Analysis mode selection
        function selectMode(mode) {
            document.querySelectorAll('.mode-option').forEach(option => {
                option.classList.remove('active');
            });

            document.querySelector(`[data-mode="${mode}"]`).classList.add('active');
            currentSettings.analysisMode = mode;

            const modeIcon = mode === 'Porcine' ? 'üê∑' : 'üê≠';
            showStatus(`${modeIcon} Analysis mode changed to ${mode}!`, 'success');

            if (uploadedFile) {
                showStatus('üîÑ Mode change will trigger automatic re-analysis...', 'loading');
                debounceAnalysis();
            }
        }

        // Reset settings
        function resetSettings() {
            showStatus('üîÑ Resetting settings to default values...', 'loading');

            currentSettings = {
                outlierThreshold: 3.0,
                r2Threshold: 0.99,
                rtTolerance: 0.1,
                analysisMode: 'Porcine'
            };

            document.getElementById('outlierThreshold').value = 3.0;
            document.getElementById('r2Threshold').value = 0.99;
            document.getElementById('rtTolerance').value = 0.1;
            document.getElementById('outlierValue').textContent = '3.0';
            document.getElementById('r2Value').textContent = '0.990';
            document.getElementById('rtValue').textContent = '¬±0.10';

            selectMode('Porcine');

            showStatus('‚úÖ All settings have been reset to default values! (Outlier: 3.0, R¬≤: 0.99, RT: ¬±0.10, Mode: Porcine)', 'success');

            if (uploadedFile) {
                setTimeout(() => {
                    showStatus('üöÄ Starting re-analysis with reset settings...', 'loading');
                    runAnalysis();
                }, 1000);
            }
        }

        // Debounced analysis execution
        let analysisTimeout;
        function debounceAnalysis() {
            clearTimeout(analysisTimeout);
            analysisTimeout = setTimeout(() => {
                runAnalysis(true);
            }, 1000);
        }

        // Main analysis execution
        async function runAnalysis(isAutoReanalysis = false) {
            if (!uploadedFile) {
                showStatus('‚ùå Please upload a CSV file first. Click the file upload area above or drag a CSV file.', 'error');
                return;
            }

            try {
                const prefix = isAutoReanalysis ? 'üîÑ Real-time re-analysis' : 'üöÄ LC-MS-MS data analysis';
                showStatus(`${prefix} starting! Filename: ${uploadedFile.name} | Analysis mode: ${currentSettings.analysisMode}`, 'loading');
                showRealtimeStatus('Requesting analysis server...');

                // Show detailed analysis parameters
                setTimeout(() => {
                    showStatus(`‚öôÔ∏è Analysis settings - Outlier threshold: ${currentSettings.outlierThreshold}, R¬≤ threshold: ${currentSettings.r2Threshold}, RT tolerance: ${currentSettings.rtTolerance}`, 'loading');
                }, 500);

                console.log('üî¨ Starting analysis with file:', uploadedFile.name);

                const formData = new FormData();
                formData.append('file', uploadedFile);
                formData.append('data_type', currentSettings.analysisMode);
                formData.append('outlier_threshold', currentSettings.outlierThreshold);
                formData.append('r2_threshold', currentSettings.r2Threshold);
                formData.append('rt_tolerance', currentSettings.rtTolerance);

                console.log('üì§ FormData prepared, sending request...');

                const response = await fetch('/api/analyze', {
                    method: 'POST',
                    body: formData
                });

                console.log('üì® Response received:', response.status);

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.json();
                console.log('‚úÖ Analysis result:', result);

                if (result.error) {
                    showStatus(`‚ùå Analysis error: ${result.error}`, 'error');
                    return;
                }

                // Store analysis results
                currentAnalysisResults = result.results;

                // Show success message
                const stats = result.results.statistics;
                showStatus(`‚úÖ Analysis completed! Success rate: ${stats.success_rate.toFixed(1)}% | Valid: ${stats.valid_compounds}, Outliers: ${stats.outliers}`, 'success');

                // Show visualization and download buttons
                document.getElementById('visualizeBtn').style.display = 'inline-block';
                document.getElementById('downloadBtn').style.display = 'inline-block';

                // Update real-time status
                showRealtimeStatus(`‚úÖ Analysis complete - ${stats.success_rate.toFixed(1)}% success rate`);

                // Auto-generate visualizations
                setTimeout(() => {
                    generateIntegratedVisualization();
                }, 1000);

            } catch (error) {
                console.error('‚ùå Analysis error:', error);
                showStatus(`‚ùå Analysis failed: ${error.message}`, 'error');
                showRealtimeStatus('‚ùå Analysis failed');
            }
        }

        // Status display functions
        function showStatus(message, type = 'info') {
            console.log(`üì¢ Status: [${type}] ${message}`);

            const statusDisplay = document.getElementById('statusDisplay');
            statusDisplay.textContent = message;

            statusDisplay.className = 'status-panel';
            if (type === 'error') {
                statusDisplay.style.borderLeftColor = '#e74c3c';
                statusDisplay.style.background = '#fdf2f2';
            } else if (type === 'success') {
                statusDisplay.style.borderLeftColor = '#27ae60';
                statusDisplay.style.background = '#f2f9f4';
            } else if (type === 'loading') {
                statusDisplay.style.borderLeftColor = '#f39c12';
                statusDisplay.style.background = '#fef9e7';
            } else {
                statusDisplay.style.borderLeftColor = '#3498db';
                statusDisplay.style.background = '#f8f9fa';
            }
        }

        // Real-time status display
        function showRealtimeStatus(message) {
            document.getElementById('realtimeStatus').textContent = message;
        }

        // Generate integrated visualization
        async function generateIntegratedVisualization() {
            if (!currentAnalysisResults) {
                showStatus('‚ùå No analysis results available. Please run analysis first.', 'error');
                return;
            }

            try {
                showStatus('üìä Generating integrated visualizations...', 'loading');

                const response = await fetch('/api/visualize', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        results: currentAnalysisResults
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.json();
                console.log('üìä Visualization result:', result);

                if (result.error) {
                    showStatus(`‚ùå Visualization error: ${result.error}`, 'error');
                    return;
                }

                // Update plots
                if (result.plots) {
                    if (result.plots.regression_scatter) {
                        document.getElementById('plot-2d').innerHTML = result.plots.regression_scatter;
                    }
                    if (result.plots['3d_distribution']) {
                        document.getElementById('plot-3d').innerHTML = result.plots['3d_distribution'];
                    }
                    if (result.plots.integrated_visualization) {
                        document.getElementById('integratedVisualization').innerHTML = result.plots.integrated_visualization;
                    }
                }

                showStatus('‚úÖ Integrated visualizations generated successfully!', 'success');

            } catch (error) {
                console.error('‚ùå Visualization error:', error);
                showStatus(`‚ùå Visualization generation failed: ${error.message}`, 'error');
            }
        }

        // Control functions
        function reset2DView() {
            Plotly.relayout('plot-2d', {
                'xaxis.autorange': true,
                'yaxis.autorange': true
            });
        }

        function reset3DView() {
            Plotly.relayout('plot-3d', {
                'scene.camera': {
                    eye: { x: 1.2, y: 1.2, z: 1.2 }
                }
            });
        }

        function toggle2DOutliers() {
            showOutliers2D = !showOutliers2D;
            // Implement toggle logic here
            showStatus(`üëÅÔ∏è 2D outliers ${showOutliers2D ? 'shown' : 'hidden'}`, 'info');
        }

        function toggle3DOutliers() {
            showOutliers3D = !showOutliers3D;
            // Implement toggle logic here
            showStatus(`üëÅÔ∏è 3D outliers ${showOutliers3D ? 'shown' : 'hidden'}`, 'info');
        }

        function show2DRegression() {
            showRegression2D = !showRegression2D;
            // Implement regression line logic here
            showStatus(`üìà 2D regression line ${showRegression2D ? 'shown' : 'hidden'}`, 'info');
        }

        function toggle3DRegression() {
            showRegression3D = !showRegression3D;
            // Implement regression plane logic here
            showStatus(`üìà 3D regression plane ${showRegression3D ? 'shown' : 'hidden'}`, 'info');
        }

        // Download results
        function downloadResults() {
            if (!currentAnalysisResults) {
                showStatus('‚ùå No analysis results available. Please run analysis first.', 'error');
                return;
            }

            try {
                const csvContent = generateCSVFromResults(currentAnalysisResults);
                const blob = new Blob([csvContent], { type: 'text/csv' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = url;
                a.download = `ganglioside_analysis_${new Date().toISOString().slice(0, 19).replace(/:/g, '-')}.csv`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);

                showStatus('‚úÖ Results downloaded successfully!', 'success');

            } catch (error) {
                showStatus(`‚ùå Download failed: ${error.message}`, 'error');
            }
        }

        // Generate CSV from results
        function generateCSVFromResults(results) {
            let csvContent = "Name,RT,Volume,Classification,Log P,Prefix,Suffix,Outlier_Reason\n";

            // Add valid compounds
            if (results.valid_compounds) {
                results.valid_compounds.forEach(compound => {
                    csvContent += `"${compound.Name || ''}","${compound.RT || ''}","${compound.Volume || ''}","Valid","${compound['Log P'] || ''}","${compound.prefix || ''}","${compound.suffix || ''}",""\n`;
                });
            }

            // Add outliers
            if (results.outliers) {
                results.outliers.forEach(outlier => {
                    csvContent += `"${outlier.Name || ''}","${outlier.RT || ''}","${outlier.Volume || ''}","Outlier","${outlier['Log P'] || ''}","${outlier.prefix || ''}","${outlier.suffix || ''}","${outlier.outlier_reason || ''}"\n`;
                });
            }

            return csvContent;
        }

        // Refresh integrated view
        function refreshIntegratedView() {
            generateIntegratedVisualization();
        }

        // Open integrated visualization in new window
        function openIntegratedWindow() {
            if (!currentAnalysisResults) return;

            const newWindow = window.open('', '_blank', 'width=1400,height=900');
            const integratedContent = document.getElementById('integratedVisualization').innerHTML;

            newWindow.document.write(
                '<!DOCTYPE html>' +
                '<html>' +
                '<head>' +
                '    <title>Integrated LC-MS-MS Visualization</title>' +
                '    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>' +
                '</head>' +
                '<body>' +
                integratedContent +
                '</body>' +
                '</html>'
            );
            newWindow.document.close();
        }

        // Connection test
        async function testConnection() {
            try {
                showStatus('üîå Testing server connection...', 'loading');
                console.log('üîå Testing server connection...');

                const response = await fetch('/api/health');
                const data = await response.json();

                console.log('‚úÖ Health check response:', data);

                if (response.ok && data.status === 'healthy') {
                    showStatus('‚úÖ Server connection successful! Analysis ready.', 'success');
                } else {
                    showStatus('‚ö†Ô∏è Server response is abnormal.', 'error');
                }
            } catch (error) {
                console.error('‚ùå Connection test failed:', error);
                showStatus(`‚ùå Connection failed: ${error.message}`, 'error');
            }
        }

        // Window resize handler
        window.addEventListener('resize', function() {
            ['plot-2d', 'plot-3d'].forEach(id => {
                const element = document.getElementById(id);
                if (element && element.data) {
                    Plotly.Plots.resize(element);
                }
            });
        });

        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            // Ctrl+Enter: Run analysis
            if (e.ctrlKey && e.key === 'Enter') {
                e.preventDefault();
                runAnalysis();
            }
            // Ctrl+S: Download results
            if (e.ctrlKey && e.key === 's') {
                e.preventDefault();
                if (currentAnalysisResults) {
                    downloadResults();
                }
            }
        });

        console.log('üß¨ Integrated LC-MS-MS Analysis Platform initialization complete!');
        console.log('üìã Shortcuts: Ctrl+Enter (analysis), Ctrl+S (download)');
    </script>
</body>
</html>