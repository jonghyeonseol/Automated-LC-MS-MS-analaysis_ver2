<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3D LC-MS-MS Data Visualization Demo</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 30px;
        }
        h1 {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 10px;
        }
        .subtitle {
            text-align: center;
            color: #7f8c8d;
            font-size: 16px;
            margin-bottom: 30px;
        }
        .info-panel {
            background-color: #ecf0f1;
            border-left: 4px solid #3498db;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 5px;
        }
        .features {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .feature {
            background-color: #ffffff;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }
        .feature h3 {
            color: #2c3e50;
            margin-top: 0;
        }
        .feature ul {
            color: #555;
            padding-left: 20px;
        }
        #plot-container {
            height: 700px;
            border: 1px solid #ddd;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .controls {
            text-align: center;
            margin-bottom: 20px;
        }
        button {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            margin: 0 5px;
        }
        button:hover {
            background-color: #2980b9;
        }
        .legend {
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
        }
        .legend h4 {
            margin-top: 0;
            color: #2c3e50;
        }
        .legend-item {
            display: inline-block;
            margin-right: 20px;
            margin-bottom: 10px;
        }
        .legend-color {
            display: inline-block;
            width: 15px;
            height: 15px;
            border-radius: 50%;
            margin-right: 8px;
            vertical-align: middle;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß¨ 3D LC-MS-MS Data Visualization</h1>
        <p class="subtitle">Interactive visualization of Mass-to-Charge, Retention Time, and Partition Coefficient relationships</p>

        <div class="info-panel">
            <strong>üéØ Purpose:</strong> This 3D visualization displays the distribution of LC-MS-MS ganglioside data with three key dimensions:
            <br><strong>X-axis:</strong> Mass-to-Charge ratio (m/z) - Calculated from molecular composition
            <br><strong>Y-axis:</strong> Retention Time (min) - Chromatographic separation time
            <br><strong>Z-axis:</strong> Partition Coefficient (Log P) - Lipophilicity measure
        </div>

        <div class="features">
            <div class="feature">
                <h3>üîç Key Features</h3>
                <ul>
                    <li>Interactive 3D scatter plot</li>
                    <li>Color-coded by ganglioside type</li>
                    <li>Size reflects compound volume</li>
                    <li>Hover for detailed information</li>
                    <li>Rotation and zoom capabilities</li>
                </ul>
            </div>
            <div class="feature">
                <h3>üìä Data Points</h3>
                <ul>
                    <li>Valid compounds (spheres)</li>
                    <li>Anchor compounds (diamonds)</li>
                    <li>Outliers (X markers)</li>
                    <li>Regression lines (dashed)</li>
                    <li>Volume-based sizing</li>
                </ul>
            </div>
            <div class="feature">
                <h3>‚öôÔ∏è Implementation</h3>
                <ul>
                    <li>Plotly.js 3D rendering</li>
                    <li>Real-time m/z calculation</li>
                    <li>Ganglioside classification</li>
                    <li>Quality assessment integration</li>
                    <li>Flask API endpoint support</li>
                </ul>
            </div>
        </div>

        <div class="controls">
            <button onclick="resetView()">üîÑ Reset View</button>
            <button onclick="toggleOutliers()">üëÅÔ∏è Toggle Outliers</button>
            <button onclick="toggleRegression()">üìà Toggle Regression</button>
        </div>

        <div id="plot-container"></div>

        <div class="legend">
            <h4>Legend</h4>
            <div class="legend-item">
                <span class="legend-color" style="background-color: #3498db;"></span>
                Anchor Compounds (T)
            </div>
            <div class="legend-item">
                <span class="legend-color" style="background-color: #2ecc71;"></span>
                Valid Compounds
            </div>
            <div class="legend-item">
                <span class="legend-color" style="background-color: #e74c3c;"></span>
                Outliers
            </div>
            <div class="legend-item">
                <span class="legend-color" style="background-color: #9b59b6;"></span>
                Regression Lines
            </div>
        </div>
    </div>

    <script>
        // Sample data for demonstration
        const sampleData = {
            valid_compounds: [
                { Name: "GD1a(36:1;O2)", RT: 9.572, Volume: 1000000, "Log P": 1.53, Anchor: "T" },
                { Name: "GM1a(36:1;O2)", RT: 10.452, Volume: 500000, "Log P": 4.00, Anchor: "F" },
                { Name: "GM3(36:1;O2)", RT: 10.606, Volume: 2000000, "Log P": 7.74, Anchor: "F" },
                { Name: "GD3(36:1;O2)", RT: 10.126, Volume: 800000, "Log P": 5.27, Anchor: "T" },
                { Name: "GT1b(34:1;O2)", RT: 8.701, Volume: 1200000, "Log P": -0.94, Anchor: "T" },
                { Name: "GM1a(34:1;O2)", RT: 10.252, Volume: 600000, "Log P": 3.85, Anchor: "F" },
                { Name: "GQ1c(36:1;O2)", RT: 8.234, Volume: 580000, "Log P": -3.36, Anchor: "F" }
            ],
            outliers: [
                { Name: "Unknown_1(36:1;O2)", RT: 12.543, Volume: 450000, "Log P": 8.25, Anchor: "F", outlier_reason: "Rule 1: High standardized residual" },
                { Name: "Artifact(36:1;O2)", RT: 14.123, Volume: 80000, "Log P": 9.87, Anchor: "F", outlier_reason: "Rule 5: In-source fragmentation" }
            ]
        };

        // Calculate mass-to-charge ratios
        function calculateMassToCharge(compoundName) {
            const pattern = /\((\d+):(\d+);O(\d+)\)/;
            const match = compoundName.match(pattern);

            if (!match) return 800.0;

            const carbonCount = parseInt(match[1]);
            const unsaturation = parseInt(match[2]);
            const oxygenCount = parseInt(match[3]);

            const fattyAcidMW = carbonCount * 12.01 + (2 * carbonCount - 2 * unsaturation) * 1.008 + oxygenCount * 15.999;

            const gangliosideBaseWeights = {
                'GM3': 1200, 'GM2': 1400, 'GM1': 1500, 'GD3': 1500,
                'GD2': 1700, 'GD1': 1800, 'GT3': 1800, 'GT2': 2000,
                'GT1': 2100, 'GQ1': 2400, 'GP1': 2700
            };

            for (const [prefix, baseWeight] of Object.entries(gangliosideBaseWeights)) {
                if (compoundName.startsWith(prefix)) {
                    return baseWeight + fattyAcidMW;
                }
            }

            return 1500 + fattyAcidMW;
        }

        // Create 3D plot
        function create3DPlot() {
            const traces = [];

            // Valid compounds
            if (sampleData.valid_compounds.length > 0) {
                const anchors = sampleData.valid_compounds.filter(c => c.Anchor === "T");
                const nonAnchors = sampleData.valid_compounds.filter(c => c.Anchor !== "T");

                // Anchor compounds
                if (anchors.length > 0) {
                    traces.push({
                        x: anchors.map(c => calculateMassToCharge(c.Name)),
                        y: anchors.map(c => c.RT),
                        z: anchors.map(c => c["Log P"]),
                        mode: 'markers',
                        type: 'scatter3d',
                        marker: {
                            size: anchors.map(c => Math.sqrt(c.Volume / 50000)),
                            color: '#3498db',
                            symbol: 'diamond',
                            line: { width: 2, color: 'white' },
                            opacity: 0.9
                        },
                        name: 'Anchor Compounds (T)',
                        text: anchors.map(c => `<b>${c.Name}</b><br>m/z: ${calculateMassToCharge(c.Name).toFixed(1)}<br>RT: ${c.RT.toFixed(3)}<br>Log P: ${c["Log P"].toFixed(2)}<br>Volume: ${c.Volume.toLocaleString()}`),
                        hovertemplate: '%{text}<extra></extra>'
                    });
                }

                // Non-anchor valid compounds
                if (nonAnchors.length > 0) {
                    traces.push({
                        x: nonAnchors.map(c => calculateMassToCharge(c.Name)),
                        y: nonAnchors.map(c => c.RT),
                        z: nonAnchors.map(c => c["Log P"]),
                        mode: 'markers',
                        type: 'scatter3d',
                        marker: {
                            size: nonAnchors.map(c => Math.sqrt(c.Volume / 50000)),
                            color: '#2ecc71',
                            line: { width: 1, color: 'white' },
                            opacity: 0.8
                        },
                        name: 'Valid Compounds',
                        text: nonAnchors.map(c => `<b>${c.Name}</b><br>m/z: ${calculateMassToCharge(c.Name).toFixed(1)}<br>RT: ${c.RT.toFixed(3)}<br>Log P: ${c["Log P"].toFixed(2)}<br>Volume: ${c.Volume.toLocaleString()}`),
                        hovertemplate: '%{text}<extra></extra>'
                    });
                }
            }

            // Outliers
            if (sampleData.outliers.length > 0) {
                traces.push({
                    x: sampleData.outliers.map(c => calculateMassToCharge(c.Name)),
                    y: sampleData.outliers.map(c => c.RT),
                    z: sampleData.outliers.map(c => c["Log P"]),
                    mode: 'markers',
                    type: 'scatter3d',
                    marker: {
                        size: sampleData.outliers.map(c => Math.sqrt(c.Volume / 50000)),
                        color: '#e74c3c',
                        symbol: 'x',
                        line: { width: 2 },
                        opacity: 0.7
                    },
                    name: 'Outliers',
                    text: sampleData.outliers.map(c => `<b>${c.Name}</b><br>m/z: ${calculateMassToCharge(c.Name).toFixed(1)}<br>RT: ${c.RT.toFixed(3)}<br>Log P: ${c["Log P"].toFixed(2)}<br>Volume: ${c.Volume.toLocaleString()}<br>Reason: ${c.outlier_reason}`),
                    hovertemplate: '%{text}<extra></extra>'
                });
            }

            const layout = {
                title: {
                    text: '3D Distribution: Mass-to-Charge vs Retention Time vs Log P',
                    x: 0.5,
                    font: { size: 16 }
                },
                scene: {
                    xaxis: { title: 'Mass-to-Charge (m/z)' },
                    yaxis: { title: 'Retention Time (min)' },
                    zaxis: { title: 'Partition Coefficient (Log P)' },
                    camera: {
                        eye: { x: 1.2, y: 1.2, z: 1.2 }
                    },
                    aspectmode: 'cube'
                },
                margin: { l: 0, r: 0, t: 50, b: 0 },
                legend: {
                    x: 0.02,
                    y: 0.98,
                    bgcolor: 'rgba(255,255,255,0.8)',
                    bordercolor: 'rgba(0,0,0,0.2)',
                    borderwidth: 1
                },
                hovermode: 'closest'
            };

            Plotly.newPlot('plot-container', traces, layout, {
                responsive: true,
                displayModeBar: true,
                modeBarButtonsToRemove: ['pan2d', 'select2d', 'lasso2d']
            });
        }

        // Control functions
        function resetView() {
            Plotly.relayout('plot-container', {
                'scene.camera': {
                    eye: { x: 1.2, y: 1.2, z: 1.2 }
                }
            });
        }

        let outliersVisible = true;
        function toggleOutliers() {
            outliersVisible = !outliersVisible;
            Plotly.restyle('plot-container',
                { visible: outliersVisible },
                [2] // outlier trace index
            );
        }

        // Initialize plot when page loads
        document.addEventListener('DOMContentLoaded', function() {
            create3DPlot();
        });
    </script>
</body>
</html>