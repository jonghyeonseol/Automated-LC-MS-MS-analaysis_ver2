{% extends "base.html" %}

{% block title %}Results - Session #{{ session.id }}{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="{% url 'analysis:home' %}">Home</a></li>
                <li class="breadcrumb-item"><a href="{% url 'analysis:history' %}">History</a></li>
                <li class="breadcrumb-item"><a href="{% url 'analysis:session_detail' session.id %}">Session #{{ session.id }}</a></li>
                <li class="breadcrumb-item active">Results</li>
            </ol>
        </nav>
    </div>
</div>

<div class="row mb-4">
    <div class="col-md-8">
        <h2><i class="bi bi-bar-chart-line"></i> Analysis Results</h2>
        <p class="text-muted">{{ session.name|default:"Session #"|add:session.id|stringformat:"s" }} - {{ session.original_filename }}</p>
    </div>
    <div class="col-md-4 text-end">
        <div class="btn-group">
            <a href="api/sessions/{{ session.id }}/export/?format=csv" class="btn btn-outline-primary">
                <i class="bi bi-file-earmark-spreadsheet"></i> Export CSV
            </a>
            <a href="api/sessions/{{ session.id }}/export/?format=excel" class="btn btn-outline-success">
                <i class="bi bi-file-earmark-excel"></i> Export Excel
            </a>
        </div>
    </div>
</div>

<!-- Summary Cards -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <h6 class="text-muted">Total Compounds</h6>
                <h2 class="text-primary mb-0">{{ result.total_compounds }}</h2>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <h6 class="text-muted">Valid Compounds</h6>
                <h2 class="text-success mb-0">{{ result.valid_compounds }}</h2>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <h6 class="text-muted">Outliers Detected</h6>
                <h2 class="text-warning mb-0">{{ result.outlier_count }}</h2>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <h6 class="text-muted">Success Rate</h6>
                <h2 class="text-info mb-0">{{ result.success_rate|floatformat:1 }}%</h2>
            </div>
        </div>
    </div>
</div>

<!-- Tabs -->
<ul class="nav nav-tabs mb-3" id="resultsTabs" role="tablist">
    <li class="nav-item" role="presentation">
        <button class="nav-link active" id="overview-tab" data-bs-toggle="tab" data-bs-target="#overview" type="button">
            <i class="bi bi-speedometer2"></i> Overview
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="compounds-tab" data-bs-toggle="tab" data-bs-target="#compounds" type="button">
            <i class="bi bi-table"></i> Compounds ({{ result.total_compounds }})
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="regression-tab" data-bs-toggle="tab" data-bs-target="#regression" type="button">
            <i class="bi bi-graph-up"></i> Regression Models
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="charts-tab" data-bs-toggle="tab" data-bs-target="#charts" type="button">
            <i class="bi bi-pie-chart"></i> Visualizations
        </button>
    </li>
</ul>

<div class="tab-content" id="resultsTabContent">
    <!-- Overview Tab -->
    <div class="tab-pane fade show active" id="overview" role="tabpanel">
        <div class="row">
            <div class="col-md-6 mb-4">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="bi bi-pie-chart"></i> Category Distribution</h5>
                    </div>
                    <div class="card-body">
                        {% if result.categorization %}
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Category</th>
                                    <th>Count</th>
                                    <th>Percentage</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for category, data in result.categorization.items %}
                                <tr>
                                    <td><strong>{{ category }}</strong></td>
                                    <td>{{ data.count }}</td>
                                    <td>
                                        <div class="progress" style="height: 20px;">
                                            <div class="progress-bar" role="progressbar" style="width: {{ data.percentage }}%">
                                                {{ data.percentage|floatformat:1 }}%
                                            </div>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                        {% else %}
                        <p class="text-muted">No categorization data available</p>
                        {% endif %}
                    </div>
                </div>
            </div>

            <div class="col-md-6 mb-4">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="bi bi-check-circle"></i> Rule Results</h5>
                    </div>
                    <div class="card-body">
                        <table class="table table-sm">
                            <tbody>
                                <tr>
                                    <th width="60%">Rule 1 - Valid Compounds:</th>
                                    <td><span class="badge bg-success">{{ result.rule1_valid }}</span></td>
                                </tr>
                                <tr>
                                    <th>Rule 1 - Outliers:</th>
                                    <td><span class="badge bg-warning">{{ result.rule1_outliers }}</span></td>
                                </tr>
                                <tr>
                                    <th>Rule 4 - Valid O-Acetylation:</th>
                                    <td><span class="badge bg-success">{{ result.rule4_valid }}</span></td>
                                </tr>
                                <tr>
                                    <th>Rule 4 - Invalid O-Acetylation:</th>
                                    <td><span class="badge bg-danger">{{ result.rule4_invalid }}</span></td>
                                </tr>
                                <tr>
                                    <th>Rule 5 - Fragments Merged:</th>
                                    <td><span class="badge bg-info">{{ result.rule5_fragments }}</span></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Compounds Tab -->
    <div class="tab-pane fade" id="compounds" role="tabpanel">
        <div class="card">
            <div class="card-header">
                <div class="row">
                    <div class="col">
                        <h5 class="mb-0">All Compounds</h5>
                    </div>
                    <div class="col-auto">
                        <input type="text" id="compoundSearch" class="form-control form-control-sm" placeholder="Search compounds...">
                    </div>
                </div>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-sm table-hover" id="compoundsTable">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>RT</th>
                                <th>Volume</th>
                                <th>Log P</th>
                                <th>Anchor</th>
                                <th>Category</th>
                                <th>Status</th>
                                <th>Predicted RT</th>
                                <th>Residual</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for compound in compounds %}
                            <tr>
                                <td><strong>{{ compound.name }}</strong></td>
                                <td>{{ compound.rt|floatformat:3 }}</td>
                                <td>{{ compound.volume|floatformat:0 }}</td>
                                <td>{{ compound.log_p|floatformat:2 }}</td>
                                <td>
                                    {% if compound.is_anchor %}
                                        <span class="badge bg-primary">T</span>
                                    {% else %}
                                        <span class="badge bg-secondary">F</span>
                                    {% endif %}
                                </td>
                                <td><span class="badge bg-info">{{ compound.get_category_display }}</span></td>
                                <td>
                                    {% if compound.status == 'valid' %}
                                        <span class="badge bg-success">Valid</span>
                                    {% elif compound.status == 'outlier' %}
                                        <span class="badge bg-warning">Outlier</span>
                                    {% else %}
                                        <span class="badge bg-secondary">{{ compound.get_status_display }}</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if compound.predicted_rt %}
                                        {{ compound.predicted_rt|floatformat:3 }}
                                    {% else %}
                                        -
                                    {% endif %}
                                </td>
                                <td>
                                    {% if compound.residual %}
                                        {{ compound.residual|floatformat:3 }}
                                    {% else %}
                                        -
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Regression Tab -->
    <div class="tab-pane fade" id="regression" role="tabpanel">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Regression Models by Prefix Group</h5>
            </div>
            <div class="card-body">
                {% if regression_models %}
                {% for model in regression_models %}
                <div class="card mb-3">
                    <div class="card-header bg-light">
                        <h6 class="mb-0">{{ model.prefix_group }} - {{ model.model_type }}</h6>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <p><strong>Equation:</strong></p>
                                <pre class="bg-light p-2 rounded"><code>{{ model.equation }}</code></pre>
                            </div>
                            <div class="col-md-6">
                                <table class="table table-sm">
                                    <tr>
                                        <th>RÂ²:</th>
                                        <td><span class="badge bg-success">{{ model.r2|floatformat:4 }}</span></td>
                                    </tr>
                                    <tr>
                                        <th>RMSE:</th>
                                        <td>{{ model.rmse|floatformat:4|default:"-" }}</td>
                                    </tr>
                                    <tr>
                                        <th>Samples:</th>
                                        <td>{{ model.n_samples }} ({{ model.n_anchors }} anchors)</td>
                                    </tr>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
                {% else %}
                <p class="text-muted">No regression models available</p>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Visualizations Tab -->
    <div class="tab-pane fade" id="charts" role="tabpanel">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-graph-up"></i> Actual vs Predicted RT</h5>
            </div>
            <div class="card-body">
                <div id="rtScatterPlot"></div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<!-- Plotly.js -->
<script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>

<script>
// Compound table search
document.getElementById('compoundSearch').addEventListener('keyup', function() {
    const searchTerm = this.value.toLowerCase();
    const rows = document.querySelectorAll('#compoundsTable tbody tr');

    rows.forEach(row => {
        const text = row.textContent.toLowerCase();
        row.style.display = text.includes(searchTerm) ? '' : 'none';
    });
});

// Create RT scatter plot
const compounds = {{ compounds|safe }};
const validData = {
    x: [],
    y: [],
    text: [],
    mode: 'markers',
    type: 'scatter',
    name: 'Valid',
    marker: {
        color: 'green',
        size: 8
    }
};

const outlierData = {
    x: [],
    y: [],
    text: [],
    mode: 'markers',
    type: 'scatter',
    name: 'Outlier',
    marker: {
        color: 'red',
        size: 8
    }
};

// Process compounds for plotting
{% for compound in compounds %}
    {% if compound.predicted_rt %}
        const point = {
            x: {{ compound.rt }},
            y: {{ compound.predicted_rt }},
            text: '{{ compound.name }}'
        };

        {% if compound.status == 'valid' %}
            validData.x.push(point.x);
            validData.y.push(point.y);
            validData.text.push(point.text);
        {% else %}
            outlierData.x.push(point.x);
            outlierData.y.push(point.y);
            outlierData.text.push(point.text);
        {% endif %}
    {% endif %}
{% endfor %}

// Diagonal reference line
const minRT = Math.min(...validData.x, ...outlierData.x);
const maxRT = Math.max(...validData.x, ...outlierData.x);
const diagonalLine = {
    x: [minRT, maxRT],
    y: [minRT, maxRT],
    mode: 'lines',
    type: 'scatter',
    name: 'Perfect Prediction',
    line: {
        color: 'gray',
        dash: 'dash'
    }
};

const layout = {
    title: 'Actual vs Predicted Retention Time',
    xaxis: {
        title: 'Actual RT (min)'
    },
    yaxis: {
        title: 'Predicted RT (min)'
    },
    hovermode: 'closest'
};

Plotly.newPlot('rtScatterPlot', [diagonalLine, validData, outlierData], layout);
</script>
{% endblock %}
