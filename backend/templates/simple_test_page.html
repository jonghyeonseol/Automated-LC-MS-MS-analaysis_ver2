<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ganglioside Analyzer - 간단 테스트</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        
        .header {
            text-align: center;
            background: #3498db;
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        
        .section {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .control-group {
            margin: 15px 0;
            padding: 15px;
            background: #ecf0f1;
            border-radius: 5px;
        }
        
        .slider {
            width: 100%;
            margin: 10px 0;
        }
        
        .value-display {
            background: #3498db;
            color: white;
            padding: 5px 10px;
            border-radius: 3px;
            display: inline-block;
            font-weight: bold;
        }
        
        .btn {
            background: #3498db;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        
        .btn:hover {
            background: #2980b9;
        }
        
        .btn-success { background: #27ae60; }
        .btn-warning { background: #f39c12; }
        .btn-danger { background: #e74c3c; }
        
        .result {
            background: #2ecc71;
            color: white;
            padding: 15px;
            border-radius: 5px;
            margin: 15px 0;
            white-space: pre-wrap;
            font-family: monospace;
        }
        
        .error {
            background: #e74c3c;
        }
        
        .warning {
            background: #f39c12;
        }
        
        .info {
            background: #3498db;
        }
        
        input[type="file"] {
            width: 100%;
            padding: 10px;
            border: 2px dashed #3498db;
            border-radius: 5px;
            margin: 10px 0;
        }
        
        .status-bar {
            background: #34495e;
            color: white;
            padding: 10px;
            text-align: center;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        
        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        
        @media (max-width: 768px) {
            .grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>🧬 Ganglioside Analyzer</h1>
        <p>인터랙티브 분석 시스템 - 테스트 버전</p>
    </div>
    
    <div class="status-bar" id="statusBar">
        🔄 시스템 준비 중...
    </div>
    
    <!-- 설정 패널 -->
    <div class="section">
        <h2>⚙️ 분석 설정</h2>
        
        <div class="control-group">
            <label><strong>📊 표준화 잔차 임계값:</strong></label>
            <input type="range" id="outlierThreshold" class="slider" min="1.0" max="5.0" step="0.1" value="3.0">
            <div class="value-display" id="outlierValue">3.0</div>
            <p><small>이상치 판별 기준 (높을수록 엄격)</small></p>
        </div>
        
        <div class="control-group">
            <label><strong>📈 R² 임계값:</strong></label>
            <input type="range" id="r2Threshold" class="slider" min="0.90" max="0.999" step="0.001" value="0.99">
            <div class="value-display" id="r2Value">0.990</div>
            <p><small>회귀분석 품질 기준 (높을수록 엄격)</small></p>
        </div>
        
        <div class="control-group">
            <label><strong>⏱️ RT 허용 범위 (분):</strong></label>
            <input type="range" id="rtTolerance" class="slider" min="0.05" max="0.5" step="0.01" value="0.1">
            <div class="value-display" id="rtValue">±0.10</div>
            <p><small>동일 접미사 그룹 내 RT 허용 오차</small></p>
        </div>
        
        <div class="control-group">
            <label><strong>🔬 분석 모드:</strong></label><br>
            <input type="radio" name="analysisMode" value="Porcine" checked> 🐷 Porcine &nbsp;&nbsp;
            <input type="radio" name="analysisMode" value="Mouse"> 🐭 Mouse
        </div>
        
        <div style="text-align: center; margin-top: 20px;">
            <button class="btn" onclick="resetSettings()">🔄 기본값 복원</button>
            <button class="btn btn-warning" onclick="exportSettings()">💾 설정 저장</button>
        </div>
    </div>
    
    <!-- 파일 업로드 및 분석 -->
    <div class="grid">
        <div class="section">
            <h3>📄 파일 업로드</h3>
            <input type="file" id="csvFile" accept=".csv">
            <button class="btn" onclick="uploadFile()">📤 업로드</button>
            <button class="btn btn-success" onclick="analyzeData()">🔬 분석</button>
        </div>
        
        <div class="section">
            <h3>📊 결과 및 시각화</h3>
            <button class="btn btn-warning" onclick="createVisualization()">📈 시각화</button>
            <button class="btn btn-success" onclick="downloadResults()">💾 다운로드</button>
        </div>
    </div>
    
    <!-- 테스트 버튼들 -->
    <div class="section">
        <h3>🧪 테스트 데이터</h3>
        <button class="btn btn-success" onclick="testSampleData()">🚀 기본 샘플</button>
        <button class="btn btn-warning" onclick="testComplexSample()">🧬 복합 샘플</button>
        <button class="btn btn-danger" onclick="testChallengeData()">💀 도전 데이터</button>
    </div>
    
    <!-- 결과 표시 -->
    <div id="result"></div>
    
    <!-- 시각화 영역 -->
    <div id="visualizationContainer" style="display: none;">
        <div class="section">
            <h3>📊 분석 결과</h3>
            <div id="visualizations"></div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8000';
        let currentAnalysisResults = null;
        let currentSettings = {
            outlierThreshold: 3.0,
            r2Threshold: 0.99,
            rtTolerance: 0.1,
            analysisMode: 'Porcine'
        };
        
        // 초기화
        document.addEventListener('DOMContentLoaded', function() {
            initializeControls();
            checkAPIStatus();
        });
        
        // 컨트롤 초기화
        function initializeControls() {
            // 슬라이더 이벤트 리스너
            document.getElementById('outlierThreshold').addEventListener('input', function() {
                const value = parseFloat(this.value);
                document.getElementById('outlierValue').textContent = value.toFixed(1);
                currentSettings.outlierThreshold = value;
                onSettingChange('outlierThreshold', value);
            });
            
            document.getElementById('r2Threshold').addEventListener('input', function() {
                const value = parseFloat(this.value);
                document.getElementById('r2Value').textContent = value.toFixed(3);
                currentSettings.r2Threshold = value;
                onSettingChange('r2Threshold', value);
            });
            
            document.getElementById('rtTolerance').addEventListener('input', function() {
                const value = parseFloat(this.value);
                document.getElementById('rtValue').textContent = `±${value.toFixed(2)}`;
                currentSettings.rtTolerance = value;
                onSettingChange('rtTolerance', value);
            });
            
            // 라디오 버튼 이벤트
            document.querySelectorAll('input[name="analysisMode"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    currentSettings.analysisMode = this.value;
                    onSettingChange('analysisMode', this.value);
                });
            });
        }
        
        // 설정 변경 감지
        function onSettingChange(setting, value) {
            console.log(`설정 변경: ${setting} = ${value}`);
            showResult(`⚙️ 설정 변경: ${setting} = ${value}`, 'info');
            
            // 자동 재분석 (데이터가 있을 때)
            if (currentAnalysisResults) {
                setTimeout(() => {
                    showResult('🔄 설정이 변경되어 재분석을 수행합니다...', 'info');
                    // 여기서 실제 재분석 호출
                }, 1000);
            }
        }
        
        // 기본값 복원
        function resetSettings() {
            document.getElementById('outlierThreshold').value = 3.0;
            document.getElementById('r2Threshold').value = 0.99;
            document.getElementById('rtTolerance').value = 0.1;
            document.querySelector('input[value="Porcine"]').checked = true;
            
            document.getElementById('outlierValue').textContent = '3.0';
            document.getElementById('r2Value').textContent = '0.990';
            document.getElementById('rtValue').textContent = '±0.10';
            
            currentSettings = {
                outlierThreshold: 3.0,
                r2Threshold: 0.99,
                rtTolerance: 0.1,
                analysisMode: 'Porcine'
            };
            
            showResult('🔄 모든 설정이 기본값으로 복원되었습니다.', 'info');
        }
        
        // 설정 저장
        function exportSettings() {
            const settingsData = {
                settings: currentSettings,
                timestamp: new Date().toISOString()
            };
            
            const dataStr = JSON.stringify(settingsData, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `settings_${new Date().toISOString().slice(0,10)}.json`;
            a.click();
            window.URL.revokeObjectURL(url);
            
            showResult('💾 설정이 저장되었습니다!', 'info');
        }
        
        // API 상태 확인
        async function checkAPIStatus() {
            try {
                updateStatus('🔄 API 연결 확인 중...');
                const response = await fetch(`${API_BASE}/`);
                const result = await response.json();
                updateStatus('✅ API 연결 성공 - 테스트 준비 완료');
                showResult(`✅ 시스템 준비 완료!\n\nAPI 상태: 정상\n서버: ${API_BASE}\n\n인터랙티브 기능을 테스트해보세요!`, 'info');
            } catch (error) {
                updateStatus('❌ API 연결 실패');
                showResult(`❌ API 연결 실패\n\n오류: ${error.message}\n서버: ${API_BASE}\n\n서버가 실행 중인지 확인해주세요.`, 'error');
            }
        }
        
        // 파일 업로드
        async function uploadFile() {
            const fileInput = document.getElementById('csvFile');
            const file = fileInput.files[0];
            
            if (!file) {
                showResult('⚠️ 파일을 선택해주세요.', 'warning');
                return;
            }
            
            showResult(`📤 파일 업로드: ${file.name} (${(file.size/1024).toFixed(1)} KB)`, 'info');
        }
        
        // 데이터 분석
        async function analyzeData() {
            try {
                updateStatus('🔬 데이터 분석 중...');
                
                // 현재 설정으로 분석 요청
                const formData = new FormData();
                if (document.getElementById('csvFile').files[0]) {
                    formData.append('file', document.getElementById('csvFile').files[0]);
                } else {
                    // 샘플 데이터 사용
                    const sampleCSV = `Name,RT,Volume,Log P,Anchor
GD1a(36:1;O2),9.572,1000000,1.53,T
GM1a(36:1;O2),10.452,500000,4.00,F
GM3(36:1;O2),10.606,2000000,7.74,F
GD3(36:1;O2),10.126,800000,5.27,T
GT1b(36:1;O2),8.701,1200000,-0.94,T`;
                    
                    const blob = new Blob([sampleCSV], { type: 'text/csv' });
                    formData.append('file', blob, 'sample.csv');
                }
                
                formData.append('data_type', currentSettings.analysisMode);
                
                const response = await fetch(`${API_BASE}/api/analyze`, {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    currentAnalysisResults = result.results;
                    displayAnalysisResults(result.results);
                    updateStatus('✅ 분석 완료');
                } else {
                    showResult(`❌ 분석 실패: ${result.detail}`, 'error');
                    updateStatus('❌ 분석 실패');
                }
            } catch (error) {
                showResult(`❌ 분석 오류: ${error.message}`, 'error');
                updateStatus('❌ 분석 오류');
            }
        }
        
        // 시각화 생성
        function createVisualization() {
            if (!currentAnalysisResults) {
                showResult('⚠️ 먼저 데이터 분석을 수행해주세요.', 'warning');
                return;
            }
            
            document.getElementById('visualizationContainer').style.display = 'block';
            
            const stats = currentAnalysisResults.statistics;
            const html = `
                <div style="background: #3498db; color: white; padding: 20px; border-radius: 8px; margin: 10px 0;">
                    <h3>📊 분석 결과 대시보드</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin: 15px 0;">
                        <div style="text-align: center;">
                            <h2>${stats.total_compounds || 0}</h2>
                            <p>총 화합물</p>
                        </div>
                        <div style="text-align: center;">
                            <h2>${stats.valid_compounds || 0}</h2>
                            <p>유효 화합물</p>
                        </div>
                        <div style="text-align: center;">
                            <h2>${stats.outliers || 0}</h2>
                            <p>이상치</p>
                        </div>
                        <div style="text-align: center;">
                            <h2>${(stats.success_rate || 0).toFixed(1)}%</h2>
                            <p>성공률</p>
                        </div>
                    </div>
                </div>
                
                <div style="background: #ecf0f1; padding: 15px; border-radius: 8px; margin: 10px 0;">
                    <h4>🎛️ 현재 설정</h4>
                    <p><strong>표준화 잔차 임계값:</strong> ${currentSettings.outlierThreshold}</p>
                    <p><strong>R² 임계값:</strong> ${currentSettings.r2Threshold}</p>
                    <p><strong>RT 허용 범위:</strong> ±${currentSettings.rtTolerance}분</p>
                    <p><strong>분석 모드:</strong> ${currentSettings.analysisMode}</p>
                </div>
            `;
            
            document.getElementById('visualizations').innerHTML = html;
            showResult('📊 시각화가 생성되었습니다!', 'info');
        }
        
        // 샘플 데이터 테스트
        function testSampleData() {
            showResult('🚀 기본 샘플 데이터로 테스트를 시작합니다...', 'info');
            setTimeout(() => {
                analyzeData();
            }, 1000);
        }
        
        // 복합 샘플 테스트
        function testComplexSample() {
            showResult('🧬 복합 샘플 데이터 준비 중...\n\n- 다양한 이성질체\n- O-acetylation 화합물\n- 복잡한 구조', 'info');
        }
        
        // 도전 데이터 테스트
        function testChallengeData() {
            if (confirm('⚠️ 도전 데이터는 분석하기 어려운 데이터입니다.\n계속하시겠습니까?')) {
                showResult('💀 도전 데이터 테스트 시작!\n\n이 데이터는 낮은 성공률이 예상됩니다.', 'warning');
            }
        }
        
        // 결과 다운로드
        function downloadResults() {
            if (!currentAnalysisResults) {
                showResult('⚠️ 다운로드할 결과가 없습니다.', 'warning');
                return;
            }
            showResult('💾 결과 다운로드 기능 (개발 중)', 'info');
        }
        
        // 분석 결과 표시
        function displayAnalysisResults(results) {
            const stats = results.statistics;
            const summary = `🔬 분석 완료!

=== 분석 요약 ===
총 화합물 수: ${stats.total_compounds}
유효 화합물: ${stats.valid_compounds}
이상치: ${stats.outliers}
성공률: ${stats.success_rate.toFixed(1)}%

=== 현재 설정 ===
표준화 잔차 임계값: ${currentSettings.outlierThreshold}
R² 임계값: ${currentSettings.r2Threshold}
RT 허용 범위: ±${currentSettings.rtTolerance}분
분석 모드: ${currentSettings.analysisMode}

분석 상태: ${results.status}`;

            showResult(summary, 'info');
        }
        
        // 유틸리티 함수들
        function showResult(message, type) {
            const resultDiv = document.getElementById('result');
            resultDiv.className = `result ${type}`;
            resultDiv.textContent = message;
        }
        
        function updateStatus(message) {
            document.getElementById('statusBar').textContent = message;
        }
        
        console.log('🧬 Ganglioside Analyzer - 간단 테스트 버전 로드 완료');
    </script>
</body>
</html>